<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paperly â€” your memories, made beautiful</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,500&family=Caveat:wght@400;600;700&family=Special+Elite&family=Crimson+Pro:ital,wght@0,300;0,400;1,400&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --cream: #f5ead6;
  --parchment: #f0e0c0;
  --warm: #e8d4b0;
  --brown: #2c1a0e;
  --ink: #1e120a;
  --rust: #8b3a1a;
  --amber: #c4783a;
  --gold: #b8903a;
  --sepia: #7a5030;
  --muted: #9a7050;
  --faint: #c0a880;
  --border: #d4b890;
  --paper: #faf3e5;
  --shadow: 0 6px 28px rgba(44,26,14,.18), 0 1px 6px rgba(44,26,14,.1);
  --shadow-lg: 0 18px 60px rgba(44,26,14,.28), 0 4px 12px rgba(44,26,14,.12);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Crimson Pro', Georgia, serif;
  background: #1a0e06;
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOISE TEXTURE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9998;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.view { display: none; }
.view.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR (shared)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 300;
  height: 58px; padding: 0 28px;
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(26,14,6,.82);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(196,168,100,.15);
}
.topbar-lib { background: transparent; border-bottom: none; }
.logo { display: flex; align-items: center; gap: 11px; cursor: pointer; user-select: none; }
.logo-mark {
  width: 38px; height: 38px;
  border: 1.5px solid rgba(196,168,100,.5);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Special Elite', monospace; font-size: 17px; color: var(--gold);
  transform: rotate(-2deg);
  background: rgba(196,168,100,.06);
  box-shadow: 0 0 12px rgba(196,168,100,.12), inset 0 0 8px rgba(196,168,100,.06);
}
.logo-text { display: flex; flex-direction: column; gap: 0; }
.logo-name {
  font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 500;
  color: var(--cream); letter-spacing: .12em; line-height: 1;
}
.logo-tag {
  font-family: 'Crimson Pro', serif; font-style: italic;
  font-size: 10.5px; color: rgba(196,168,100,.65); letter-spacing: .04em;
}
.topbar-r { display: flex; gap: 10px; align-items: center; }

/* Shared button styles */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 16px; cursor: pointer; border: none;
  font-family: 'Special Elite', monospace; font-size: 11.5px;
  letter-spacing: .06em; transition: all .18s;
}
.btn-p {
  background: var(--rust); color: var(--cream);
  border: 1px solid rgba(196,120,58,.4);
  box-shadow: 0 2px 8px rgba(139,58,26,.3), inset 0 1px 0 rgba(255,220,180,.1);
}
.btn-p:hover { background: #6a2810; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(139,58,26,.4); }
.btn-s {
  background: rgba(240,224,192,.08); color: var(--cream);
  border: 1px solid rgba(196,168,100,.28);
}
.btn-s:hover { background: rgba(240,224,192,.14); border-color: rgba(196,168,100,.5); }
.btn-g {
  background: transparent; color: rgba(196,168,100,.7);
  border: 1px solid transparent; padding: 6px 10px;
}
.btn-g:hover { color: var(--cream); border-color: rgba(196,168,100,.2); }

/* Auth bar */
.auth-bar { display: flex; align-items: center; gap: 8px; }
.user-chip {
  display: flex; align-items: center; gap: 7px;
  padding: 5px 12px;
  background: rgba(240,224,192,.07);
  border: 1px solid rgba(196,168,100,.25);
  font-family: 'Special Elite', monospace; font-size: 10px;
  color: rgba(240,224,192,.8); letter-spacing: .05em;
}
.user-avatar {
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--rust); display: flex; align-items: center;
  justify-content: center; color: var(--cream); font-size: 9px; font-weight: 700;
}
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #5aaa5a; display: inline-block; }
.sync-dot.syncing { background: var(--amber); animation: pulse .8s ease-in-out infinite; }
.sync-dot.offline { background: var(--muted); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING PAGE â€” HERO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#view-lib { background: #140c04; }

.landing-bg {
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 80% 60% at 50% 30%, rgba(196,120,58,.08) 0%, transparent 60%),
    radial-gradient(ellipse 40% 50% at 20% 80%, rgba(139,58,26,.06) 0%, transparent 50%),
    radial-gradient(ellipse 50% 60% at 80% 60%, rgba(90,50,20,.05) 0%, transparent 50%),
    linear-gradient(180deg, #140c04 0%, #1e1008 40%, #160d06 100%);
}

/* Floating paper fragments */
.floaters {
  position: fixed; inset: 0; z-index: 1; pointer-events: none; overflow: hidden;
}
.floater {
  position: absolute;
  background: var(--parchment);
  opacity: 0;
  animation: floatUp var(--dur, 18s) ease-in-out var(--delay, 0s) infinite;
}
@keyframes floatUp {
  0% { opacity: 0; transform: translateY(20px) rotate(var(--rot0, -8deg)) scale(.9); }
  15% { opacity: var(--max-op, .12); }
  85% { opacity: var(--max-op, .12); }
  100% { opacity: 0; transform: translateY(-60px) rotate(var(--rot1, 6deg)) scale(.95); }
}

/* Candle glow effect */
.candle-glow {
  position: fixed; bottom: -100px; left: 50%;
  transform: translateX(-50%);
  width: 600px; height: 400px;
  background: radial-gradient(ellipse at 50% 100%, rgba(196,120,58,.07) 0%, transparent 65%);
  pointer-events: none; z-index: 1;
  animation: flicker 4s ease-in-out infinite;
}
@keyframes flicker {
  0%,100% { opacity: 1; transform: translateX(-50%) scale(1); }
  25% { opacity: .85; transform: translateX(-50%) scale(1.02); }
  50% { opacity: .95; transform: translateX(-50%) scale(.98); }
  75% { opacity: .9; transform: translateX(-50%) scale(1.01); }
}

/* Hero section */
.hero {
  position: relative; z-index: 10;
  min-height: 100vh;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  text-align: center;
  padding: 100px 24px 60px;
}

.hero-eyebrow {
  font-family: 'Special Elite', monospace; font-size: 9.5px;
  color: rgba(196,168,100,.6); letter-spacing: .35em; text-transform: uppercase;
  margin-bottom: 28px;
  opacity: 0; animation: fadeUp .8s .2s forwards;
}

.hero-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(42px, 7vw, 88px);
  font-weight: 300; font-style: italic;
  color: var(--cream);
  line-height: 1.08;
  letter-spacing: -.01em;
  margin-bottom: 10px;
  opacity: 0; animation: fadeUp .9s .35s forwards;
}
.hero-title em {
  font-style: normal; font-weight: 500;
  background: linear-gradient(135deg, #e8c878, #c4903a, #e0a840);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.hero-subtitle {
  font-family: 'Cormorant Garamond', serif; font-style: italic;
  font-size: clamp(16px, 2.5vw, 22px); font-weight: 300;
  color: rgba(220,195,155,.55);
  letter-spacing: .04em; line-height: 1.6;
  max-width: 480px; margin: 0 auto 44px;
  opacity: 0; animation: fadeUp .9s .5s forwards;
}

.hero-acts {
  display: flex; gap: 14px; flex-wrap: wrap; justify-content: center;
  margin-bottom: 70px;
  opacity: 0; animation: fadeUp .9s .65s forwards;
}

.btn-hero-p {
  padding: 14px 36px;
  background: linear-gradient(135deg, #9a3a18, #7a2c10);
  color: var(--cream); border: 1px solid rgba(196,120,58,.3);
  font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 500;
  letter-spacing: .12em; cursor: pointer; transition: all .2s;
  box-shadow: 0 4px 20px rgba(139,58,26,.35);
}
.btn-hero-p:hover { background: linear-gradient(135deg, #7a2c10, #5a200a); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(139,58,26,.45); }

.btn-hero-s {
  padding: 14px 36px;
  background: transparent; color: rgba(220,195,155,.8);
  border: 1px solid rgba(196,168,100,.25);
  font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 400;
  letter-spacing: .12em; cursor: pointer; transition: all .2s;
}
.btn-hero-s:hover { border-color: rgba(196,168,100,.5); color: var(--cream); background: rgba(196,168,100,.06); }

/* Scroll hint */
.scroll-hint {
  position: absolute; bottom: 36px; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  font-family: 'Special Elite', monospace; font-size: 8px;
  color: rgba(196,168,100,.35); letter-spacing: .25em;
  opacity: 0; animation: fadeIn 1s 1.2s forwards;
}
.scroll-hint-line {
  width: 1px; height: 36px;
  background: linear-gradient(to bottom, transparent, rgba(196,168,100,.3));
  animation: lineGrow 2s 1.4s ease-out forwards;
  transform-origin: top; transform: scaleY(0);
}
@keyframes lineGrow { to { transform: scaleY(1); } }

/* Floating demo pages preview */
.hero-preview {
  position: relative; height: 240px; width: 100%; max-width: 620px;
  margin: 0 auto 20px;
  opacity: 0; animation: fadeUp 1s .8s forwards;
}
.preview-page {
  position: absolute; width: 130px;
  background: var(--parchment);
  box-shadow: var(--shadow-lg), 6px 8px 0 rgba(20,10,4,.3);
  background-image:
    repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(160,120,70,.12) 20px, rgba(160,120,70,.12) 21px);
  transition: transform .3s ease;
  cursor: pointer;
}
.preview-page:hover { transform: translateY(-8px) rotate(0deg) !important; z-index: 20 !important; }
.preview-tape { position: absolute; top: -9px; height: 20px; z-index: 5;
  background-image: repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,.25) 4px, rgba(255,255,255,.25) 5px); }
.preview-page-inner { padding: 12px 10px 16px; }
.preview-page-img {
  width: 100%; aspect-ratio: 4/3; object-fit: cover; display: block;
  filter: sepia(.55) brightness(.88);
  margin-bottom: 8px;
}
.preview-page-img-ph {
  width: 100%; aspect-ratio: 4/3;
  background: linear-gradient(135deg, #3a2810, #2a1a0c, #4a3020);
  margin-bottom: 8px; display: flex; align-items: center; justify-content: center;
  font-size: 28px; opacity: .6;
}
.preview-page-title {
  font-family: 'Caveat', cursive; font-size: 11px; font-weight: 700;
  color: var(--brown); line-height: 1.2; margin-bottom: 3px;
}
.preview-page-date {
  font-family: 'Special Elite', monospace; font-size: 7.5px;
  color: var(--sepia); letter-spacing: .05em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FEATURES SECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.features {
  position: relative; z-index: 10;
  padding: 80px 24px 90px;
  background: linear-gradient(180deg, transparent, rgba(18,10,4,.8) 20%, rgba(18,10,4,.9) 80%, transparent);
}
.features-inner { max-width: 860px; margin: 0 auto; }
.features-label {
  text-align: center; font-family: 'Special Elite', monospace; font-size: 9px;
  color: rgba(196,168,100,.45); letter-spacing: .3em; margin-bottom: 52px;
}
.features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
.feature {
  padding: 36px 28px;
  border: 1px solid rgba(196,168,100,.08);
  background: rgba(240,224,192,.02);
  transition: all .2s;
}
.feature:hover {
  background: rgba(240,224,192,.04);
  border-color: rgba(196,168,100,.16);
}
.feature-ico { font-size: 26px; margin-bottom: 16px; display: block; }
.feature-name {
  font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 500;
  color: var(--cream); margin-bottom: 10px; letter-spacing: .02em;
}
.feature-desc {
  font-family: 'Crimson Pro', serif; font-size: 14.5px; font-style: italic;
  color: rgba(196,155,100,.55); line-height: 1.65;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PULL QUOTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pullquote {
  position: relative; z-index: 10;
  text-align: center; padding: 70px 24px;
}
.pullquote-text {
  font-family: 'Cormorant Garamond', serif; font-style: italic;
  font-size: clamp(20px, 3.5vw, 36px); font-weight: 300;
  color: rgba(220,195,155,.45);
  max-width: 660px; margin: 0 auto 18px; line-height: 1.5;
  letter-spacing: .02em;
}
.pullquote-text em { color: rgba(220,195,155,.75); font-style: normal; }
.pullquote-attr {
  font-family: 'Special Elite', monospace; font-size: 8.5px;
  color: rgba(196,168,100,.3); letter-spacing: .2em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIBRARY VIEW (logged in)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.library-wrap {
  min-height: 100vh;
  background: var(--warm);
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.05'/%3E%3C/svg%3E"),
    linear-gradient(160deg, #ece0c6 0%, #e0cead 50%, #ddd0ae 100%);
}

.library-hero {
  padding: 80px 32px 0;
  max-width: 1080px; margin: 0 auto;
}
.library-greeting {
  font-family: 'Cormorant Garamond', serif; font-style: italic;
  font-size: 13px; font-weight: 300; color: var(--sepia);
  letter-spacing: .08em; margin-bottom: 6px;
}
.library-heading {
  font-family: 'Cormorant Garamond', serif; font-weight: 300;
  font-size: clamp(28px, 4vw, 46px);
  color: var(--brown); letter-spacing: .02em; line-height: 1.1;
  margin-bottom: 8px;
}
.library-heading em {
  font-style: italic; font-weight: 300;
  color: var(--rust);
}
.library-sub {
  font-family: 'Crimson Pro', serif; font-style: italic;
  font-size: 15px; color: var(--sepia); margin-bottom: 0;
}
.library-divider {
  display: flex; align-items: center; gap: 14px; margin: 28px 0 32px;
  font-family: 'Special Elite', monospace; font-size: 8.5px;
  color: var(--faint); letter-spacing: .25em;
}
.library-divider::before, .library-divider::after {
  content: ''; flex: 1; height: 1px;
  background: linear-gradient(to right, transparent, var(--border), transparent);
}

.library { max-width: 1080px; margin: 0 auto; padding: 0 32px 60px; }

/* Journal grid */
.jgrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(188px, 1fr)); gap: 28px; }

.jcard { cursor: pointer; transition: all .22s; position: relative; }
.jcard:hover { transform: translateY(-8px) rotate(.4deg); }
.jcard:hover .jcov { box-shadow: 0 22px 50px rgba(44,26,14,.3), 6px 8px 0 rgba(44,26,14,.1); }

.jcov {
  aspect-ratio: 3/4;
  box-shadow: var(--shadow), 4px 5px 0 rgba(44,26,14,.07);
  position: relative; overflow: hidden;
  display: flex; align-items: flex-end; padding: 14px;
  transition: box-shadow .22s;
}
.jcov-grain {
  position: absolute; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='.08'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 2;
}
.jspine { position: absolute; left: 0; top: 0; bottom: 0; width: 9px; background: rgba(0,0,0,.25); z-index: 3; }
.jthumb { position: absolute; inset: 0; object-fit: cover; opacity: .25; mix-blend-mode: multiply; z-index: 1; }
.jcov-txt { position: relative; z-index: 4; color: rgba(255,248,225,.95); }
.jcov-name { font-family: 'Special Elite', monospace; font-size: 13px; line-height: 1.25; text-shadow: 0 1px 6px rgba(0,0,0,.5); letter-spacing: .03em; }
.jcov-ct { font-family: 'Crimson Pro', serif; font-style: italic; font-size: 11px; opacity: .82; margin-top: 3px; }
.jmeta { padding: 9px 1px 0; }
.jmeta-name { font-family: 'Cormorant Garamond', serif; font-size: 14px; font-weight: 500; color: var(--brown); letter-spacing: .02em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.jmeta-date { font-family: 'Crimson Pro', serif; font-style: italic; font-size: 11px; color: var(--sepia); margin-top: 1px; }

.jacts { position: absolute; top: 7px; right: 7px; opacity: 0; transition: opacity .14s; display: flex; gap: 4px; z-index: 10; }
.jcard:hover .jacts { opacity: 1; }
.icobtn {
  width: 26px; height: 26px; border-radius: 50%;
  background: rgba(245,234,210,.92); border: 1px solid var(--border);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 11px; transition: all .12s; box-shadow: 0 1px 5px rgba(0,0,0,.12);
}
.icobtn:hover { background: white; transform: scale(1.1); }

/* New card */
.newcard {
  cursor: pointer; border: 2px dashed var(--border); aspect-ratio: 3/4;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 8px; color: var(--faint); transition: all .2s;
  background: rgba(245,234,210,.2);
}
.newcard:hover { border-color: var(--amber); color: var(--rust); background: rgba(196,120,58,.06); transform: translateY(-5px); }
.newcard-ico { font-size: 26px; opacity: .6; }
.newcard-lbl { font-family: 'Caveat', cursive; font-size: 15px; }

/* Demo card badge */
.demo-badge {
  position: absolute; top: 9px; right: 9px; z-index: 5;
  background: var(--rust); color: var(--cream);
  font-family: 'Special Elite', monospace; font-size: 7.5px;
  letter-spacing: .12em; padding: 2px 7px;
  box-shadow: 1px 1px 0 rgba(0,0,0,.2);
}

/* Library empty state */
.lib-empty {
  grid-column: 1 / -1;
  display: flex; align-items: center;
  padding: 20px 0;
}
.lib-empty-text {
  font-family: 'Cormorant Garamond', serif; font-style: italic;
  font-size: 16px; color: var(--faint); line-height: 1.65;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR (unchanged structure, restyled topbar)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.editor { display: flex; flex-direction: column; height: calc(100vh - 58px); margin-top: 58px; }
.ed-hdr {
  background: rgba(26,14,6,.96);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(196,168,100,.12);
  padding: 0 16px; height: 46px;
  display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
.ed-back {
  font-family: 'Special Elite', monospace; font-size: 10.5px;
  color: rgba(196,168,100,.6); cursor: pointer;
  padding: 4px 9px; background: none; border: 1px solid transparent;
  transition: all .12s; letter-spacing: .06em;
}
.ed-back:hover { border-color: rgba(196,168,100,.25); color: rgba(196,168,100,.9); background: rgba(196,168,100,.05); }
.ed-jname { font-family: 'Cormorant Garamond', serif; font-size: 15px; font-style: italic; color: var(--cream); flex: 1; letter-spacing: .03em; }
.ed-body { display: flex; flex: 1; overflow: hidden; }

/* PAGES SIDEBAR */
.pg-sb {
  width: 130px; background: rgba(220,210,188,.7);
  border-right: 1px solid var(--border);
  overflow-y: auto; flex-shrink: 0; padding: 10px 8px;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(180,150,100,.12) 19px, rgba(180,150,100,.12) 20px);
}
.sb-lbl { font-family: 'Special Elite', monospace; font-size: 9px; color: var(--muted); letter-spacing: .16em; margin-bottom: 8px; }
.pgthumb {
  aspect-ratio: 3/4; background: var(--paper); border: 2px solid var(--border);
  cursor: pointer; margin-bottom: 6px; transition: all .12s;
  position: relative; overflow: hidden;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 1px 2px 0 rgba(44,26,14,.06);
}
.pgthumb.active { border-color: var(--rust); box-shadow: 0 0 0 1px var(--rust); }
.pgthumb:hover:not(.active) { border-color: var(--amber); }
.pgthumb img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.pgnum { position: absolute; bottom: 2px; right: 3px; font-family: 'Special Elite', monospace; font-size: 7px; color: var(--muted); }
.addpg {
  width: 100%; aspect-ratio: 3/4; border: 2px dashed var(--border); background: none;
  cursor: pointer; font-family: 'Caveat', cursive; font-size: 11px; color: var(--muted);
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
  transition: all .12s;
}
.addpg:hover { border-color: var(--amber); color: var(--rust); background: rgba(196,120,58,.05); }

/* CANVAS AREA */
.canvas-area {
  flex: 1; overflow: auto; display: flex; justify-content: center; padding: 28px 18px;
  background: #c4ae8a;
  background-image:
    repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(140,110,60,.1) 28px, rgba(140,110,60,.1) 29px),
    repeating-linear-gradient(90deg, transparent, transparent 28px, rgba(140,110,60,.05) 28px, rgba(140,110,60,.05) 29px);
}

/* THE JOURNAL PAGE */
.journal-page {
  width: 560px; min-height: 780px; position: relative; flex-shrink: 0; align-self: flex-start;
  background-color: #f6ecd6;
  background-image:
    radial-gradient(ellipse 70px 58px at 88% 10%, rgba(100,65,25,.08) 52%, transparent 74%),
    url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='p'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.72' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23p)' opacity='.07'/%3E%3C/svg%3E"),
    repeating-linear-gradient(0deg, transparent, transparent 27px, rgba(150,110,70,.18) 27px, rgba(150,110,70,.18) 28px);
  box-shadow: 0 6px 24px rgba(44,26,14,.22), 5px 8px 0 rgba(44,26,14,.08);
}
.journal-page::before {
  content: ''; position: absolute; left: 50px; top: 0; bottom: 0; width: 1px;
  background: rgba(150,45,45,.2); z-index: 1; pointer-events: none;
}
.journal-page::after {
  content: ''; position: absolute; left: 12px; top: 0; bottom: 0; width: 24px;
  background:
    radial-gradient(circle 5px at 50% 50%, rgba(200,180,145,.5) 0%, rgba(200,180,145,.5) 4px, transparent 5px) center 72px,
    radial-gradient(circle 5px at 50% 50%, rgba(200,180,145,.5) 0%, rgba(200,180,145,.5) 4px, transparent 5px) center 234px,
    radial-gradient(circle 5px at 50% 50%, rgba(200,180,145,.5) 0%, rgba(200,180,145,.5) 4px, transparent 5px) center 396px,
    radial-gradient(circle 5px at 50% 50%, rgba(200,180,145,.5) 0%, rgba(200,180,145,.5) 4px, transparent 5px) center 558px;
  background-repeat: no-repeat; z-index: 1; pointer-events: none;
}
.page-content { position: relative; z-index: 10; padding: 30px 30px 50px 58px; min-height: 780px; }

/* Photo elements */
.photo-frame { display: block; position: relative; margin-bottom: 18px; }
.photo-clip { position: relative; display: block; overflow: hidden; filter: drop-shadow(4px 6px 10px rgba(44,26,14,.35)); }
.photo-clip img { display: block; width: 100%; height: auto; }
.photo-tape { position: absolute; top: -11px; height: 22px; z-index: 5; background-image: repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,.25) 4px, rgba(255,255,255,.25) 5px); }
.decor-sticker:hover { outline: 1.5px dashed rgba(122,64,32,.35); outline-offset: 4px; }
.photo-postmark { position: absolute; z-index: 5; border-radius: 50%; border: 2.5px solid rgba(110,25,25,.6); display: flex; align-items: center; justify-content: center; font-family: 'Special Elite', monospace; font-size: 6px; color: rgba(110,25,25,.7); text-align: center; line-height: 1.3; outline: 1.2px solid rgba(110,25,25,.4); outline-offset: -6px; }

/* Dropzone */
.dropzone {
  border: 2px dashed var(--border); padding: 28px 14px;
  text-align: center; cursor: pointer; background: rgba(245,234,210,.5);
  transition: all .16s; position: relative; margin-bottom: 14px; overflow: hidden;
}
.dropzone:hover, .dropzone.dv { border-color: var(--amber); background: rgba(196,120,58,.06); }
.dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; font-size: 0; color: transparent; -webkit-appearance: none; }
.dz-ico { font-size: 22px; margin-bottom: 5px; }
.dz-txt { font-family: 'Caveat', cursive; font-size: 14px; color: var(--muted); }
.dz-txt strong { color: var(--rust); }

/* Text fields */
.divider-orn {
  display: flex; align-items: center; gap: 8px; margin: 12px 0 10px;
  font-family: 'Special Elite', monospace; font-size: 9px; color: var(--muted); letter-spacing: .25em;
}
.divider-orn::before, .divider-orn::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.f-title { font-family: 'Caveat', cursive; font-size: 28px; font-weight: 700; color: var(--brown); line-height: 1.15; width: 100%; border: none; background: transparent; outline: none; resize: none; overflow: hidden; display: block; margin-bottom: 5px; }
.f-title:focus { outline: 2px dashed rgba(122,64,32,.28); outline-offset: 3px; }
.f-desc { font-family: 'Special Elite', monospace; font-size: 12px; color: var(--sepia); line-height: 1.9; width: 100%; border: none; background: transparent; outline: none; resize: none; min-height: 48px; letter-spacing: .02em; display: block; margin-bottom: 7px; }
.f-desc:focus { outline: 2px dashed rgba(122,64,32,.2); outline-offset: 3px; }
.quote-inline { border-left: 3px solid rgba(85,92,60,.5); padding: 5px 0 5px 11px; margin: 10px 0; }
.f-quote { font-family: 'Caveat', cursive; font-size: 19px; color: var(--brown); width: 100%; border: none; background: transparent; outline: none; resize: none; min-height: 28px; display: block; }
.f-quote:focus { outline: 2px dashed rgba(85,92,60,.3); outline-offset: 2px; }
.quote-footer { display: flex; flex-direction: column; gap: 5px; margin-top: 6px; }
.f-qdate, .f-qloc { font-family: 'Special Elite', monospace; font-size: 10px; color: var(--muted); border: none; background: transparent; outline: none; border-bottom: 1px solid rgba(160,130,80,.28); width: 100%; min-width: 0; letter-spacing: .06em; padding-bottom: 1px; }
.f-qdate:focus, .f-qloc:focus { border-bottom-color: var(--amber); }
.f-qloc { font-family: 'Caveat', cursive; font-size: 13px; font-style: italic; }
.scrap-wrap { position: relative; display: inline-block; max-width: 94%; margin: 12px 0; }
.scrap-paper {
  background: #fdf5dc;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(130,100,65,.1) 20px, rgba(130,100,65,.1) 21px);
  padding: 14px 14px 26px;
  clip-path: polygon(0% 2%,3% 0%,6% 2%,9% 0%,12% 2%,15% 0%,18% 1%,21% 0%,24% 2%,27% 0%,30% 1%,33% 0%,36% 2%,39% 0%,42% 1%,45% 0%,48% 2%,51% 0%,54% 1%,57% 0%,60% 2%,63% 0%,66% 1%,69% 0%,72% 2%,75% 0%,78% 1%,81% 0%,84% 2%,87% 0%,90% 1%,93% 0%,96% 2%,99% 0%,100% 2%,100% 100%,97% 96%,94% 100%,91% 96%,88% 100%,85% 95%,82% 100%,79% 96%,76% 100%,73% 95%,70% 100%,67% 96%,64% 100%,61% 95%,58% 100%,55% 96%,52% 100%,49% 95%,46% 100%,43% 96%,40% 100%,37% 95%,34% 100%,31% 96%,28% 100%,25% 95%,22% 100%,19% 96%,16% 100%,13% 95%,10% 100%,7% 96%,4% 100%,1% 96%,0% 100%);
  box-shadow: 2px 3px 9px rgba(44,26,14,.15);
}
.scrap-tape-el { position: absolute; top: -9px; height: 18px; z-index: 5; background-image: repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,.22) 4px, rgba(255,255,255,.22) 5px); }

/* RIGHT PANEL */
.rpanel {
  width: 280px;
  background: rgba(220,210,188,.82);
  border-left: 1px solid var(--border);
  overflow-y: auto; flex-shrink: 0;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 26px, rgba(170,140,90,.09) 26px, rgba(170,140,90,.09) 27px);
}
.psec { padding: 14px; border-bottom: 1px solid var(--border); }
.ptitle {
  font-family: 'Special Elite', monospace; font-size: 9px; color: var(--muted);
  letter-spacing: .16em; text-transform: uppercase; margin-bottom: 10px;
  display: flex; align-items: center; gap: 5px;
}
.badge { background: var(--rust); color: var(--cream); font-size: 6.5px; padding: 2px 5px; letter-spacing: .06em; }
.preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
.preset-btn { padding: 8px 4px; border: 1.5px solid var(--border); cursor: pointer; text-align: center; transition: all .12s; background: rgba(245,234,210,.55); font-family: 'Special Elite', monospace; box-shadow: 1px 1px 0 rgba(44,26,14,.05); }
.preset-btn:hover { border-color: var(--amber); }
.preset-btn.active { border-color: var(--rust); background: rgba(196,120,58,.08); box-shadow: 2px 2px 0 rgba(139,58,26,.1); }
.preset-ico { font-size: 14px; margin-bottom: 2px; }
.preset-name { font-size: 8.5px; color: var(--brown); letter-spacing: .05em; display: block; }
.ai-loader { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px 10px; text-align: center; color: var(--muted); }
.quill { font-size: 22px; display: inline-block; animation: q 1.4s ease-in-out infinite; }
@keyframes q { 0%,100%{transform:rotate(-10deg) translateY(0)} 50%{transform:rotate(6deg) translateY(-5px)} }
.ai-loader span { font-family: 'Caveat', cursive; font-size: 13px; }
.sug-card { background: rgba(245,234,210,.7); border: 1.5px solid var(--border); padding: 10px; margin-bottom: 7px; cursor: pointer; transition: all .12s; }
.sug-card:hover { border-color: var(--amber); background: rgba(196,120,58,.06); }
.sug-card.sel { border-color: var(--rust); background: rgba(196,120,58,.08); }
.sug-title { font-family: 'Caveat', cursive; font-size: 16px; font-weight: 600; color: var(--brown); margin-bottom: 3px; }
.sug-desc { font-family: 'Special Elite', monospace; font-size: 9.5px; color: var(--sepia); line-height: 1.65; letter-spacing: .01em; }
.sug-q { font-family: 'Caveat', cursive; font-size: 12px; color: var(--muted); font-style: italic; margin-top: 4px; border-top: 1px solid var(--border); padding-top: 3px; }
.sug-meta { font-family: 'Special Elite', monospace; font-size: 8.5px; color: var(--muted); margin-top: 2px; letter-spacing: .04em; }
.regen-btn { width: 100%; padding: 6px; background: none; border: 1.5px solid var(--border); font-family: 'Special Elite', monospace; font-size: 10px; color: var(--sepia); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: all .12s; margin-top: 5px; letter-spacing: .05em; }
.regen-btn:hover { border-color: var(--amber); color: var(--rust); }
.layer-list { display: flex; flex-direction: column; gap: 4px; }
.layer-item { display: flex; align-items: center; gap: 6px; padding: 5px 6px; background: rgba(245,234,210,.55); border: 1px solid var(--border); transition: all .12s; }
.layer-item:hover { border-color: var(--amber); }
.lthumb { width: 28px; height: 28px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
.linfo { flex: 1; min-width: 0; }
.lname { font-family: 'Special Elite', monospace; font-size: 9.5px; color: var(--brown); letter-spacing: .04em; }
.ldel { background: none; border: none; cursor: pointer; font-size: 11px; opacity: .4; transition: opacity .12s; flex-shrink: 0; }
.ldel:hover { opacity: 1; }
.decor-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
.decor-btn { padding: 7px 2px; background: rgba(245,234,210,.5); border: 1.5px solid var(--border); cursor: pointer; text-align: center; transition: all .12s; font-family: 'Special Elite', monospace; font-size: 8.5px; color: var(--sepia); letter-spacing: .04em; }
.decor-btn:hover { border-color: var(--amber); background: rgba(196,120,58,.06); }
.di { font-size: 14px; display: block; margin-bottom: 2px; }
.toggle-row { display: flex; align-items: center; gap: 7px; margin-bottom: 9px; }
.tog { position: relative; width: 28px; height: 16px; flex-shrink: 0; }
.tog input { opacity: 0; width: 0; height: 0; }
.tslider { position: absolute; inset: 0; cursor: pointer; background: var(--border); border-radius: 8px; transition: .16s; }
.tslider::before { content: ''; position: absolute; width: 10px; height: 10px; left: 3px; top: 3px; background: white; border-radius: 50%; transition: .16s; }
.tog input:checked+.tslider { background: var(--rust); }
.tog input:checked+.tslider::before { transform: translateX(12px); }
.tog-lbl { font-family: 'Special Elite', monospace; font-size: 8.5px; color: var(--muted); letter-spacing: .07em; cursor: pointer; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
  position: fixed; inset: 0; z-index: 400;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .2s;
}
.overlay::before { content: ''; position: absolute; inset: 0; background: rgba(20,12,4,.72); backdrop-filter: blur(6px); }
.overlay.open { opacity: 1; pointer-events: all; }
.modal {
  position: relative;
  background: var(--paper);
  border: 1px solid var(--border);
  box-shadow: 0 28px 70px rgba(0,0,0,.35), 5px 5px 0 rgba(44,26,14,.1);
  padding: 30px; width: 90%; max-width: 400px;
  transform: scale(.96) translateY(8px); transition: transform .22s;
}
.overlay.open .modal { transform: scale(1) translateY(0); }
.modal-title { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 500; color: var(--brown); letter-spacing: .04em; margin-bottom: 4px; }
.modal-sub { font-family: 'Crimson Pro', serif; font-style: italic; font-size: 13px; color: var(--sepia); margin-bottom: 22px; }
.flabel { display: block; font-family: 'Special Elite', monospace; font-size: 10px; color: var(--sepia); letter-spacing: .12em; margin-bottom: 6px; }
.finput {
  width: 100%; padding: 9px 11px;
  border: 1.5px solid var(--border);
  font-family: 'Caveat', cursive; font-size: 18px;
  color: var(--brown); background: rgba(255,252,244,.9);
  outline: none; transition: border-color .12s; margin-bottom: 16px;
}
.finput:focus { border-color: var(--amber); }
.color-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
.csw { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all .12s; position: relative; }
.csw.sel { border-color: var(--brown); transform: scale(1.2); }
.csw.sel::after { content: 'âœ“'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,.9); font-size: 11px; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,.5); }
.modal-acts { display: flex; justify-content: flex-end; gap: 10px; margin-top: 22px; padding-top: 16px; border-top: 1px solid var(--border); }
.modal-btn-s { padding: 8px 18px; font-family: 'Special Elite', monospace; font-size: 11px; letter-spacing: .08em; cursor: pointer; background: var(--paper); color: var(--brown); border: 1.5px solid var(--border); transition: all .12s; }
.modal-btn-s:hover { background: var(--parchment); }
.modal-btn-p { padding: 8px 18px; font-family: 'Special Elite', monospace; font-size: 11px; letter-spacing: .08em; cursor: pointer; background: var(--rust); color: var(--cream); border: 1.5px solid rgba(196,120,58,.4); transition: all .12s; box-shadow: 2px 2px 0 rgba(44,26,14,.12); }
.modal-btn-p:hover { background: #6a2810; }

/* Auth modal */
.auth-tabs { display: flex; margin-bottom: 20px; border: 1.5px solid var(--border); overflow: hidden; }
.auth-tab { flex: 1; padding: 8px; font-family: 'Special Elite', monospace; font-size: 10px; letter-spacing: .08em; cursor: pointer; border: none; background: transparent; color: var(--muted); transition: all .12s; }
.auth-tab.active { background: var(--rust); color: var(--cream); }
.auth-err { font-family: 'Special Elite', monospace; font-size: 9px; color: #8b1a1a; margin-bottom: 8px; letter-spacing: .04em; min-height: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARE OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.share-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(20,12,4,.9); backdrop-filter: blur(10px);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.share-overlay.open { opacity: 1; pointer-events: all; }
.share-box {
  background: var(--paper); border: 1px solid var(--border);
  box-shadow: 0 28px 70px rgba(0,0,0,.45), 5px 5px 0 rgba(44,26,14,.12);
  padding: 26px; max-width: 520px; width: 90%; position: relative;
}
.share-title { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 500; color: var(--brown); letter-spacing: .04em; margin-bottom: 3px; }
.share-sub { font-family: 'Crimson Pro', serif; font-style: italic; font-size: 13px; color: var(--sepia); margin-bottom: 18px; }
.share-preview { width: 100%; aspect-ratio: 3/4; max-height: 340px; object-fit: cover; border: 1px solid var(--border); margin-bottom: 14px; display: block; }
.share-acts { display: flex; gap: 8px; }
.share-close { position: absolute; top: 13px; right: 15px; background: none; border: none; font-size: 18px; cursor: pointer; color: var(--muted); line-height: 1; padding: 2px 5px; }
.share-close:hover { color: var(--brown); }
.share-url { width: 100%; padding: 8px 10px; border: 1.5px solid var(--border); font-family: 'Special Elite', monospace; font-size: 10px; color: var(--sepia); background: rgba(245,234,210,.7); outline: none; margin-bottom: 10px; letter-spacing: .04em; cursor: text; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(14px);
  background: var(--brown); color: var(--cream);
  padding: 8px 18px; font-family: 'Special Elite', monospace;
  font-size: 11px; letter-spacing: .06em;
  opacity: 0; transition: all .24s; z-index: 9999; pointer-events: none;
  box-shadow: 3px 3px 0 rgba(0,0,0,.2);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .topbar { padding: 0 14px; height: 52px; }
  .logo-name { font-size: 18px; }
  .logo-tag { display: none; }
  .hero-title { font-size: 38px; }
  .hero-subtitle { font-size: 15px; }
  .features-grid { grid-template-columns: 1fr; }
  .feature { padding: 24px 20px; }
  .hero-preview { display: none; }
  .library { padding: 0 16px 40px; }
  .library-hero { padding: 80px 16px 0; }
  .jgrid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
  .editor { height: calc(100vh - 52px); margin-top: 52px; }
  .ed-body { flex-direction: column; overflow: visible; }
  .ed-hdr { height: auto; min-height: 44px; flex-wrap: wrap; padding: 8px 12px; gap: 6px; }
  .ed-jname { font-size: 13px; order: -1; width: 100%; flex: none; }
  .pg-sb {
    position: fixed; left: 0; top: 0; bottom: 0; z-index: 300;
    transform: translateX(-100%); transition: transform .24s ease;
    width: 110px; padding-top: 60px; box-shadow: 4px 0 20px rgba(44,26,14,.2);
  }
  .pg-sb.open { transform: translateX(0); }
  .pg-backdrop { display: none; position: fixed; inset: 0; z-index: 299; background: rgba(44,26,14,.4); backdrop-filter: blur(2px); }
  .pg-sb.open ~ .pg-backdrop, body.pgopen .pg-backdrop { display: block; }
  .pg-fab {
    display: flex; position: fixed; bottom: 80px; left: 12px; z-index: 298;
    width: 44px; height: 44px; border-radius: 50%;
    background: var(--rust); color: var(--cream); border: none; cursor: pointer;
    align-items: center; justify-content: center; font-size: 16px;
    box-shadow: 0 4px 14px rgba(44,26,14,.3); transition: all .15s;
  }
  .pg-fab:active { transform: scale(.92); }
  .canvas-area { padding: 14px 8px 16px; justify-content: center; overflow-x: hidden; }
  .journal-page { width: min(560px, calc(100vw - 16px)); min-height: auto; }
  .rpanel { width: 100%; border-left: none; border-top: 2px solid var(--border); max-height: none; overflow: visible; }
  .share-box { padding: 18px; width: 96%; }
  .share-preview { max-height: 220px; }
}

@media print {
  .topbar, .ed-hdr, .pg-sb, .rpanel { display: none !important; }
  .canvas-area { padding: 0; background: none !important; }
  .journal-page { box-shadow: none; width: 100%; }
}
</style>

<!-- Supabase client - loads from CDN with local fallback stub -->
<script>
// Minimal Supabase stub - used when CDN unavailable (offline/local dev)
// Full Supabase SDK loaded from CDN below; this stub only activates if CDN fails
window.__supabaseStub = {
  createClient(url, key) {
    const _callbacks = [];
    const _session = (() => {
      try {
        const s = localStorage.getItem('paperly_session');
        return s ? JSON.parse(s) : null;
      } catch(e) { return null; }
    })();

    const auth = {
      onAuthStateChange(cb) {
        _callbacks.push(cb);
        // Fire INITIAL_SESSION immediately (async)
        setTimeout(() => cb('INITIAL_SESSION', _session), 0);
        return { data: { subscription: { unsubscribe() {} } } };
      },
      async signInWithPassword({ email, password }) {
        // Stub: create a local "user" - real auth needs Supabase
        const user = { id: 'local_' + btoa(email), email };
        const session = { user };
        localStorage.setItem('paperly_session', JSON.stringify(session));
        _callbacks.forEach(cb => cb('SIGNED_IN', session));
        return { data: { user, session }, error: null };
      },
      async signUp({ email, password }) {
        return auth.signInWithPassword({ email, password });
      },
      async signOut() {
        localStorage.removeItem('paperly_session');
        _callbacks.forEach(cb => cb('SIGNED_OUT', null));
        return { error: null };
      }
    };

    const from = (table) => ({
      upsert: (data, opts) => Promise.resolve({ error: null }),
      select: (cols) => ({
        eq: (col, val) => ({
          order: (col, opts) => Promise.resolve({ data: [], error: null })
        })
      }),
      delete: () => ({
        eq: (col, val) => ({
          eq: (c2, v2) => Promise.resolve({ error: null })
        })
      })
    });

    return { auth, from };
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"
  onerror="console.warn('Supabase CDN unavailable - using local stub'); window.supabase = window.__supabaseStub; window.__supabaseUsingStub = true;">
</script>

</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="topbar topbar-lib" id="main-topbar">
  <div class="logo" onclick="showLib()">
    <div class="logo-mark">P</div>
    <div class="logo-text">
      <div class="logo-name">Paperly</div>
      <div class="logo-tag">junk journal co-pilot</div>
    </div>
  </div>
  <div class="topbar-r">
    <div class="auth-bar" id="auth-bar">
      <button class="btn btn-s" onclick="openModal('m-auth')" style="font-size:10.5px">Sign in</button>
    </div>
    <button class="btn btn-p" onclick="showNewModal()">+ New Journal</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIBRARY VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="view-lib" class="view active">

  <!-- Landing background layers -->
  <div class="landing-bg" id="landing-bg"></div>
  <div class="candle-glow" id="candle-glow"></div>
  <div class="floaters" id="floaters"></div>

  <!-- HERO (shown when logged out) -->
  <section class="hero" id="hero-section">
    <div class="hero-eyebrow">âœ¦ &nbsp; every moment deserves to be kept &nbsp; âœ¦</div>

    <h1 class="hero-title">
      Your memories,<br><em>made beautiful.</em>
    </h1>

    <p class="hero-subtitle">
      Upload a photo. Claude reads the light, the feeling, the story â€” and writes your journal page for you.
    </p>

    <!-- Preview stack of journal pages -->
    <div class="hero-preview" id="hero-preview">
      <!-- filled by JS -->
    </div>

    <div class="hero-acts" id="hero-acts">
      <button class="btn-hero-p" onclick="openModal('m-auth')">Begin your collection</button>
      <button class="btn-hero-s" onclick="showDemo()">See a demo â†’</button>
    </div>

    <div class="scroll-hint">
      <span>scroll</span>
      <div class="scroll-hint-line"></div>
    </div>
  </section>

  <!-- FEATURES (shown when logged out) -->
  <section class="features" id="features-section">
    <div class="features-inner">
      <div class="features-label">âœ¦ &nbsp; what paperly does &nbsp; âœ¦</div>
      <div class="features-grid">
        <div class="feature">
          <span class="feature-ico">ğŸ“¸</span>
          <div class="feature-name">Drop a photo</div>
          <p class="feature-desc">Any photo from your camera roll. Paperly crops and tears the edges the way a real junk journal would.</p>
        </div>
        <div class="feature">
          <span class="feature-ico">âœ¨</span>
          <div class="feature-name">Claude writes it</div>
          <p class="feature-desc">Claude looks at your image and writes a title, caption, and memory quote â€” in your chosen voice. Vintage. Moody. Botanical.</p>
        </div>
        <div class="feature">
          <span class="feature-ico">ğŸª¡</span>
          <div class="feature-name">Add ephemera</div>
          <p class="feature-desc">Washi tape, postmarks, botanical stickers, torn scrap paper. Drag and arrange until it feels right.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- PULL QUOTE -->
  <section class="pullquote" id="pullquote-section">
    <div class="pullquote-text">
      "Some photos deserve more than an album. They deserve <em>a page, a voice, a memory that breathes.</em>"
    </div>
    <div class="pullquote-attr">âœ¦ &nbsp; PAPERLY &nbsp; âœ¦</div>
  </section>

  <!-- LIBRARY SHELF (logged-in users see this instead of hero) -->
  <div id="library-shell" style="display:none">
    <div class="library-wrap">
      <div class="library-hero">
        <div class="library-greeting" id="lib-greeting">welcome back</div>
        <h1 class="library-heading">Your <em>journals</em></h1>
        <p class="library-sub" id="lib-sub">a shelf full of little somethings</p>
        <div class="library-divider">âœ¦ &nbsp; COLLECTION &nbsp; âœ¦</div>
      </div>
      <div class="library">
        <div class="jgrid" id="jgrid"></div>
      </div>
    </div>
  </div>

</div><!-- /view-lib -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EDITOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="view-ed" class="view">
  <div class="editor">
    <div class="ed-hdr">
      <button class="ed-back" onclick="showLib()">â† Library</button>
      <div style="width:1px;height:18px;background:rgba(196,168,100,.18)"></div>
      <div class="ed-jname" id="ed-jname"></div>
      <div style="display:flex;gap:6px;margin-left:auto">
        <button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="openShare()">â†— Share</button>
        <button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="window.print()">â†“ Export</button>
        <button class="btn btn-g" style="font-size:12px;padding:4px 8px" onclick="delPage()" title="Delete page">ğŸ—‘</button>
      </div>
    </div>
    <div class="ed-body">
      <div class="pg-sb" id="pg-sb">
        <div class="sb-lbl">PAGES</div>
        <div id="pglist"></div>
        <button class="addpg" onclick="addPage()">
          <span style="font-size:16px">+</span><span>page</span>
        </button>
      </div>
      <div class="pg-backdrop" id="pg-backdrop" onclick="closePgDrawer()"></div>
      <button class="pg-fab" id="pg-fab" onclick="togglePgDrawer()" title="Pages">ğŸ“„</button>
      <div class="canvas-area">
        <div class="journal-page" id="jpage">
          <div class="page-content" id="pcontent"></div>
        </div>
      </div>
      <div class="rpanel">
        <div class="psec">
          <div class="ptitle">ğŸ“· ADD PHOTO</div>
          <div class="dropzone" id="main-dz"
            ondragover="event.preventDefault();this.classList.add('dv')"
            ondragleave="this.classList.remove('dv')"
            ondrop="onDrop(event,'main')">
            <input type="file" accept="image/*" id="main-file-input" onchange="onFile(event,'main')">
            <div class="dz-ico">ğŸ–¼</div>
            <div class="dz-txt"><strong>Click or drag photo</strong><br>appears instantly</div>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle">ğŸ¨ STYLE</div>
          <div class="preset-grid">
            <button class="preset-btn active" data-p="vintage" onclick="setPreset('vintage',this)"><div class="preset-ico">ğŸ“œ</div><span class="preset-name">VINTAGE</span></button>
            <button class="preset-btn" data-p="darkacademia" onclick="setPreset('darkacademia',this)"><div class="preset-ico">ğŸ“š</div><span class="preset-name">DARK ACADEMIA</span></button>
            <button class="preset-btn" data-p="botanical" onclick="setPreset('botanical',this)"><div class="preset-ico">ğŸŒ¿</div><span class="preset-name">BOTANICAL</span></button>
            <button class="preset-btn" data-p="summer" onclick="setPreset('summer',this)"><div class="preset-ico">â˜€ï¸</div><span class="preset-name">FADED SUMMER</span></button>
            <button class="preset-btn" data-p="moody" onclick="setPreset('moody',this)"><div class="preset-ico">ğŸŒ§</div><span class="preset-name">MOODY</span></button>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle">âœ¦ AI SUGGESTIONS <span class="badge">CLAUDE</span></div>
          <div id="ai-panel">
            <div style="font-family:'Caveat',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Upload a photo â€” Claude writes your page</div>
          </div>
        </div>
        <div class="psec" id="api-key-sec">
          <div class="ptitle">ğŸ”‘ CLAUDE API KEY</div>
          <div style="font-family:'Crimson Pro',serif;font-style:italic;font-size:12px;color:var(--sepia);margin-bottom:8px;line-height:1.5">Required for AI suggestions. Get yours at console.anthropic.com</div>
          <div style="position:relative;margin-bottom:6px">
            <input id="api-key-inp" type="password" class="finput" placeholder="sk-ant-â€¦"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
              style="font-size:13px;font-family:'Special Elite',monospace;letter-spacing:.04em;padding-right:36px;width:100%;box-sizing:border-box;-webkit-text-security:disc"
              oninput="saveApiKey(this.value)" value="">
            <button onclick="(function(){var i=document.getElementById('api-key-inp');i.type=i.type==='password'?'text':'password';})()" 
              style="position:absolute;right:6px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:14px;color:var(--muted);padding:2px 4px" 
              type="button" title="Show/hide key">ğŸ‘</button>
          </div>
          <div id="api-key-status" style="font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);letter-spacing:.06em;min-height:14px"></div>
        </div>
        <div class="psec">
          <div class="ptitle">âœ‚ MEMORY SCRAP</div>
          <div class="toggle-row">
            <label class="tog"><input type="checkbox" id="scrap-tog" onchange="toggleScrap(this.checked)"><span class="tslider"></span></label>
            <span class="tog-lbl">TORN PAPER MODE</span>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle">ğŸ–¼ COLLAGE LAYERS</div>
          <div class="dropzone" style="padding:10px 7px;margin-bottom:6px"
            ondragover="event.preventDefault();this.classList.add('dv')"
            ondragleave="this.classList.remove('dv')"
            ondrop="onDrop(event,'layer')">
            <input type="file" accept="image/*" onchange="onFile(event,'layer')">
            <div class="dz-txt" style="font-size:12px"><strong>+ Add layer</strong></div>
          </div>
          <div class="layer-list" id="layer-list"><div style="font-family:'Caveat',cursive;font-size:12px;color:var(--muted)">No layers yet</div></div>
        </div>
        <div class="psec">
          <div class="ptitle">ğŸª¡ EPHEMERA</div>
          <div class="decor-grid">
            <button class="decor-btn" onclick="addDecor('tape-floral')"><span class="di">ğŸŒ¸</span>FLORAL</button>
            <button class="decor-btn" onclick="addDecor('tape-stripe')"><span class="di">ğŸ“</span>STRIPE</button>
            <button class="decor-btn" onclick="addDecor('tape-kraft')"><span class="di">ğŸ“¦</span>KRAFT</button>
            <button class="decor-btn" onclick="addDecor('postmark')"><span class="di">ğŸ“®</span>POSTMARK</button>
            <button class="decor-btn" onclick="addDecor('botanical')"><span class="di">ğŸŒ¿</span>PLANT</button>
            <button class="decor-btn" onclick="addDecor('stamp')"><span class="di">ğŸ”–</span>STAMP</button>
            <button class="decor-btn" onclick="addDecor('divider')"><span class="di">âœ¦</span>DIVIDER</button>
            <button class="decor-btn" onclick="addDecor('text')"><span class="di">âœ</span>TEXT</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="m-new">
  <div class="modal">
    <div class="modal-title">New Journal</div>
    <div class="modal-sub">every collection starts with a name</div>
    <label class="flabel">JOURNAL NAME</label>
    <input class="finput" type="text" id="inp-name" placeholder="Autumn Wanderingsâ€¦" maxlength="50" onkeydown="if(event.key==='Enter')createJournal()">
    <label class="flabel">COVER COLOUR</label>
    <div class="color-row">
      <div class="csw sel" data-c="#7a4020" style="background:#7a4020" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#3a4a5a" style="background:#3a4a5a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#4a5a3a" style="background:#4a5a3a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#6a2020" style="background:#6a2020" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#1e3a30" style="background:#1e3a30" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#4a3a6a" style="background:#4a3a6a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#5a4a30" style="background:#5a4a30" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#8a6a10" style="background:#8a6a10" onclick="pickColor(this)"></div>
    </div>
    <div class="modal-acts">
      <button class="modal-btn-s" onclick="closeModal('m-new')">Cancel</button>
      <button class="modal-btn-p" onclick="createJournal()">Create</button>
    </div>
  </div>
</div>

<div class="share-overlay" id="share-overlay" tabindex="-1">
  <div class="share-box">
    <button class="share-close" onclick="closeShare()">âœ•</button>
    <div class="share-title">Share this page</div>
    <div class="share-sub">your journal page, ready to share</div>
    <canvas id="share-canvas" style="display:none"></canvas>
    <img id="share-img" class="share-preview" alt="Journal page preview" style="display:none">
    <input class="share-url" id="share-url" readonly onclick="this.select()" value="">
    <div class="share-acts">
      <button class="modal-btn-p" style="flex:1;justify-content:center" onclick="copyShareUrl()">ğŸ“‹ Copy link</button>
      <button class="modal-btn-s" style="flex:1;justify-content:center" onclick="downloadPage()">â†“ Save image</button>
    </div>
  </div>
</div>

<div class="overlay" id="m-auth">
  <div class="modal" style="max-width:360px">
    <div class="modal-title">Welcome to Paperly</div>
    <div class="modal-sub">sign in to keep your memories</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-in" onclick="switchAuthTab('in')">SIGN IN</button>
      <button class="auth-tab" id="tab-up" onclick="switchAuthTab('up')">CREATE ACCOUNT</button>
    </div>
    <div class="auth-err" id="auth-err"></div>
    <label class="flabel">EMAIL</label>
    <input class="finput" type="email" id="auth-email" placeholder="you@example.com" style="margin-bottom:10px" onkeydown="if(event.key==='Enter')document.getElementById('auth-pass').focus()">
    <label class="flabel">PASSWORD</label>
    <input class="finput" type="password" id="auth-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')submitAuth()">
    <div class="modal-acts">
      <button class="modal-btn-s" onclick="closeModal('m-auth')">Cancel</button>
      <button class="modal-btn-p" id="auth-submit-btn" onclick="submitAuth()">Sign in</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€â”€ SEEDED RNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkRng(seed) {
  let s = Math.abs(seed)|0||1;
  return ()=>{ s=(Math.imul(1664525,s)+1013904223)|0; return (s>>>0)/4294967295; };
}
function strHash(str) {
  let h=0; for(let i=0;i<str.length;i++) h=(Math.imul(31,h)+str.charCodeAt(i))|0; return Math.abs(h);
}

// â”€â”€â”€ PRESETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRESET_CSS = {
  vintage:      'sepia(.65) brightness(.88) contrast(1.06) saturate(.78)',
  darkacademia: 'sepia(.35) brightness(.72) contrast(1.2) saturate(.48)',
  botanical:    'sepia(.15) brightness(1.04) contrast(1.04) saturate(.9) hue-rotate(14deg)',
  summer:       'sepia(.1) brightness(1.1) contrast(.96) saturate(1.2)',
  moody:        'sepia(.45) brightness(.68) contrast(1.22) saturate(.4) hue-rotate(-10deg)',
};
const PRESET_NAMES = { vintage:'VINTAGE', darkacademia:'DARK ACADEMIA', botanical:'BOTANICAL', summer:'FADED SUMMER', moody:'MOODY' };
const PRESET_VOICE = {
  vintage:      "Write in a warm antique voice â€” like a letter found in a grandmother's attic. Poetic, nostalgic.",
  darkacademia: "Write with literary melancholy â€” candlelight, old books, autumn, the quiet pursuit of beauty.",
  botanical:    "Write with a naturalist's reverence â€” gentle, observational, in awe of living things.",
  summer:       "Write with sun-bleached nostalgia â€” a perfect afternoon, faded and bittersweet.",
  moody:        "Write with cinematic introspection â€” rain, ink, quiet sadness that feels like a gift.",
};
const BOTANICALS = ['ğŸŒ¿','ğŸƒ','ğŸŒ¾','ğŸ‚','ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ¹','ğŸ€','ğŸŒµ'];
const STAMPS = ['PASSED','RECEIVED','FRAGILE','SPECIAL','MEMORIES','FOUND','RARE','ARCHIVAL'];
const COVER_PATS = [
  'repeating-linear-gradient(45deg,rgba(255,255,255,.07) 0,rgba(255,255,255,.07) 2px,transparent 2px,transparent 12px)',
  'repeating-linear-gradient(135deg,rgba(255,255,255,.05) 0,rgba(255,255,255,.05) 1px,transparent 1px,transparent 8px)',
  'radial-gradient(ellipse at 30% 30%,rgba(255,255,255,.1) 0%,transparent 55%)',
  'repeating-linear-gradient(0deg,rgba(255,255,255,.05) 0,rgba(255,255,255,.05) 1px,transparent 1px,transparent 16px)',
];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = { journals:[], jid:null, pidx:0, preset:'vintage', scrapMode:false, isDemo:false };

// â”€â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPA_URL = 'https://dgqvpttyrnsunsjjfqwv.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRncXZwdHR5cm5zdW5zampmcXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDUyNDcsImV4cCI6MjA4NzM4MTI0N30.-zdMprzTCFUKdtWYDKekLbHmxJs4iAhKh9itb8g398o';
const sb = (window.supabase || window.__supabaseStub).createClient(SUPA_URL, SUPA_KEY);
let currentUser = null, saveTimer = null;

function save() {
  if (S.isDemo) return;
  try {
    const lite = S.journals.map(j=>({...j,pages:j.pages.map(p=>({...p,rawImage:p.rawImage?'__R__':null,layers:(p.layers||[]).map(l=>({...l,raw:'__R__'}))}))}));
    localStorage.setItem('paperly6', JSON.stringify(lite));
    S.journals.forEach(j=>j.pages.forEach(p=>{
      if(p.rawImage) try{localStorage.setItem('pr_'+p.id,p.rawImage);}catch(e){}
      (p.layers||[]).forEach(l=>{if(l.raw) try{localStorage.setItem('pr_'+l.id,l.raw);}catch(e){}});
    }));
  } catch(e) {}
  if (currentUser) { setSyncDot('syncing'); clearTimeout(saveTimer); saveTimer = setTimeout(syncToCloud, 1500); }
}

async function syncToCloud() {
  if (!currentUser||!S.journals.length) { setSyncDot('ok'); return; }
  try {
    for(const j of S.journals) {
      // Strip base64 images before sending to cloud â€” store only metadata
      const cloudJ = {...j, pages: j.pages.map(p => ({
        ...p,
        rawImage: p.rawImage ? '__R__' : null,
        layers: (p.layers||[]).map(l => ({...l, raw: '__R__'}))
      }))};
      const {error} = await sb.from('journals').upsert({id:j.id,user_id:currentUser.id,data:cloudJ,updated_at:new Date().toISOString()},{onConflict:'id'});
      if(error) throw error;
    }
    setSyncDot('ok');
  } catch(err) { console.warn('Cloud sync failed:',err.message); setSyncDot('offline'); toast('Saved locally â€” cloud sync failed'); }
}

function load() {
  try {
    const raw = localStorage.getItem('paperly6'); if(!raw) return;
    S.journals = JSON.parse(raw);
    S.journals.forEach(j=>j.pages.forEach(p=>{
      if(p.rawImage==='__R__') p.rawImage=localStorage.getItem('pr_'+p.id)||null;
      (p.layers||[]).forEach(l=>{if(l.raw==='__R__') l.raw=localStorage.getItem('pr_'+l.id)||null;});
    }));
  } catch(e) { S.journals=[]; }
}

async function loadFromCloud() {
  if(!currentUser) return;
  try {
    const {data,error} = await sb.from('journals').select('data').eq('user_id',currentUser.id).order('updated_at',{ascending:false});
    if(error) throw error;
    if(data&&data.length) {
      S.journals=data.map(r=>r.data);
      // Restore base64 images from localStorage (cloud stores only '__R__' markers)
      S.journals.forEach(j=>j.pages.forEach(p=>{
        if(p.rawImage==='__R__') p.rawImage=localStorage.getItem('pr_'+p.id)||null;
        (p.layers||[]).forEach(l=>{if(l.raw==='__R__') l.raw=localStorage.getItem('pr_'+l.id)||null;});
      }));
      save();
    }
    setSyncDot('ok');
  } catch(err) { console.warn('Cloud load failed:',err.message); setSyncDot('offline'); }
}

async function deleteFromCloud(id) {
  if(!currentUser) return;
  try { await sb.from('journals').delete().eq('id',id).eq('user_id',currentUser.id); } catch(err) {}
}

function setSyncDot(state) {
  const dot=document.getElementById('sync-dot'); if(!dot) return;
  dot.className='sync-dot'+(state==='syncing'?' syncing':state==='offline'?' offline':'');
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let authMode = 'in';
function switchAuthTab(mode) {
  authMode=mode;
  document.getElementById('tab-in').classList.toggle('active',mode==='in');
  document.getElementById('tab-up').classList.toggle('active',mode==='up');
  document.getElementById('auth-submit-btn').textContent=mode==='in'?'Sign in':'Create account';
  document.getElementById('auth-err').textContent='';
}

async function submitAuth() {
  const email=document.getElementById('auth-email').value.trim();
  const pass=document.getElementById('auth-pass').value;
  const errEl=document.getElementById('auth-err');
  errEl.textContent='';
  if(!email||!pass){errEl.textContent='EMAIL AND PASSWORD REQUIRED';return;}
  const btn=document.getElementById('auth-submit-btn');
  btn.textContent='â€¦'; btn.disabled=true;
  try {
    if(authMode==='in') {
      const {error}=await sb.auth.signInWithPassword({email,password:pass});
      if(error){if(error.message.toLowerCase().includes('invalid login'))throw new Error('Incorrect email or password.');throw error;}
    } else {
      const {error:e1}=await sb.auth.signUp({email,password:pass});
      if(e1){if(e1.message.toLowerCase().includes('already registered'))throw new Error('Email already registered â€” switch to Sign In.');throw e1;}
      // Try signing in immediately â€” works if email confirmation is disabled
      const {error:e2}=await sb.auth.signInWithPassword({email,password:pass});
      if(e2){
        if(e2.message.toLowerCase().includes('confirm')||e2.message.toLowerCase().includes('not confirmed'))
          throw new Error('Account created! Check your email to confirm, then sign in.');
        throw e2;
      }
      toast('Welcome to Paperly âœ“');
    }
    closeModal('m-auth');
    document.getElementById('auth-email').value='';
    document.getElementById('auth-pass').value='';
  } catch(err) { errEl.textContent=err.message; }
  finally { btn.textContent=authMode==='in'?'Sign in':'Create account'; btn.disabled=false; }
}

async function signOut() {
  // Update UI immediately â€” don't wait for Supabase round-trip
  currentUser=null; S.journals=[]; load();
  const hp=document.getElementById('hero-preview');
  if(hp) { hp.innerHTML=''; delete hp.dataset.built; }
  renderAuthBar(null); renderLib(); toast('Signed out');
  // Then actually sign out from Supabase in background
  try { await sb.auth.signOut(); } catch(e) { console.warn('Sign-out error:', e); }
}

function renderAuthBar(user) {
  const bar=document.getElementById('auth-bar');
  if(!user) {
    bar.innerHTML='<button class="btn btn-s" onclick="openModal(\'m-auth\')" style="font-size:10.5px">Sign in</button>';
  } else {
    const ini=user.email.slice(0,2).toUpperCase();
    bar.innerHTML=
      '<div class="user-chip"><div class="user-avatar">'+ini+'</div>'
      +'<span>'+user.email.split('@')[0]+'</span>'
      +'<span class="sync-dot" id="sync-dot"></span></div>'
      +'<button class="btn btn-g" onclick="signOut()" style="font-size:10px">Sign out</button>';
  }
}

sb.auth.onAuthStateChange(async (event, session) => {
  if(event==='TOKEN_REFRESHED'&&!session) return;
  currentUser=session?.user||null;
  renderAuthBar(currentUser);
  // Show a one-time notice if using the offline stub
  if(currentUser && window.__supabaseUsingStub && !sessionStorage.getItem('stubNotified')) {
    sessionStorage.setItem('stubNotified','1');
    setTimeout(()=>toast('Offline mode â€” data saves locally only'),800);
  }
  if(currentUser) {
    // Show library IMMEDIATELY â€” don't wait for cloud sync
    renderLib();
    // Then sync in background for SIGNED_IN and INITIAL_SESSION
    if(event==='SIGNED_IN'||event==='INITIAL_SESSION') {
      if(event==='SIGNED_IN') toast('Signed in â€” syncingâ€¦');
      setSyncDot('syncing');
      const localSnap=[...S.journals];
      try {
        await loadFromCloud();
        for(const lj of localSnap) { if(!S.journals.find(j=>j.id===lj.id)) S.journals.push(lj); }
        if(localSnap.length) await syncToCloud();
        if(event==='SIGNED_IN') toast('Journals synced âœ“');
        renderLib(); // Refresh grid with synced journals
      } catch(e) { console.warn('Sync error:', e); }
    }
  } else {
    if(event==='SIGNED_OUT') {
      S.journals=[]; load();
      const hp=document.getElementById('hero-preview');
      if(hp) { hp.innerHTML=''; delete hp.dataset.built; }
      renderLib();
    }
    if(event==='INITIAL_SESSION') renderLib();
  }
});

const gid = ()=>Date.now().toString(36)+Math.random().toString(36).slice(2,5);

function getJ() { if(S.isDemo) return DEMO_JOURNAL; return S.journals.find(j=>j.id===S.jid)||null; }
function getP() { if(S.isDemo) return DEMO_PAGES[S.pidx]||null; const j=getJ(); return j?(j.pages[S.pidx]||null):null; }
const blank = ()=>({id:gid(),rawImage:null,preset:'vintage',title:'',desc:'',quote:'',date:'',location:'',decorations:[],layers:[]});

// â”€â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLib() {
  S.isDemo=false;
  document.getElementById('view-lib').classList.add('active');
  document.getElementById('view-ed').classList.remove('active');
  // topbar-lib (transparent) only on landing; library shelf needs solid bar
  document.getElementById('main-topbar').classList.toggle('topbar-lib', !currentUser);
  renderLib();
}

function showEd(jid) {
  S.isDemo=false; S.jid=jid; S.pidx=0;
  document.getElementById('view-lib').classList.remove('active');
  document.getElementById('view-ed').classList.add('active');
  document.getElementById('main-topbar').classList.remove('topbar-lib');
  renderEditor();
}

// â”€â”€â”€ RENDER LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLib() {
  // Ensure library view is active
  document.getElementById('view-lib').classList.add('active');
  document.getElementById('view-ed').classList.remove('active');
  if (!currentUser) {
    // Show landing
    document.getElementById('hero-section').style.display='';
    document.getElementById('features-section').style.display='';
    document.getElementById('pullquote-section').style.display='';
    document.getElementById('library-shell').style.display='none';
    document.getElementById('landing-bg').style.display='';
    document.getElementById('candle-glow').style.display='';
    buildHeroPreview();
    buildFloaters();
    return;
  }

  // Logged in â€” show shelf, hide landing content; ensure topbar is solid
  document.getElementById('main-topbar').classList.remove('topbar-lib');
  document.getElementById('hero-section').style.display='none';
  document.getElementById('features-section').style.display='none';
  document.getElementById('pullquote-section').style.display='none';
  document.getElementById('library-shell').style.display='';
  document.getElementById('landing-bg').style.display='none';
  document.getElementById('candle-glow').style.display='none';

  // Personalized greeting
  const name = currentUser.email.split('@')[0];
  const hr = new Date().getHours();
  const greeting = hr < 12 ? 'good morning' : hr < 17 ? 'good afternoon' : 'good evening';
  document.getElementById('lib-greeting').textContent = greeting + ', ' + name;
  document.getElementById('lib-sub').textContent = S.journals.length > 0
    ? S.journals.length + ' journal' + (S.journals.length!==1?'s':'')+' Â· '+S.journals.reduce((a,j)=>a+(j.pages?.length||0),0)+' pages'
    : 'your first journal is waiting to be made';

  const grid = document.getElementById('jgrid');
  grid.innerHTML='';

  // Demo card
  const demoCard=document.createElement('div'); demoCard.className='jcard'; demoCard.onclick=showDemo;
  demoCard.innerHTML=
    '<div class="jcov" style="background:#2a3a4a">'
    +'<div class="jcov-grain"></div><div class="jspine"></div>'
    +'<div class="demo-badge">DEMO</div>'
    +'<div class="jcov-txt"><div class="jcov-name">A Year in Fragments</div><div class="jcov-ct">4 pages Â· tap to explore</div></div></div>'
    +'<div class="jmeta"><div class="jmeta-name">Demo Journal</div><div class="jmeta-date">see what\'s possible</div></div>';
  // Inject demo thumbnail - getDemoImg/DEMO_FILTERS defined later in script
  if(typeof getDemoImg==='function'){
    const th=document.createElement('img');th.className='jthumb';
    th.src=getDemoImg('__d1__',180,240);th.style.filter=DEMO_FILTERS['moody'];
    const badge=demoCard.querySelector('.demo-badge');
    if(badge) badge.parentNode.insertBefore(th,badge);
  }
  grid.appendChild(demoCard);

  if (!S.journals.length) {
    const e=document.createElement('div'); e.className='lib-empty';
    e.innerHTML='<div class="lib-empty-text">Your journals will appear here.<br><em>Every great collection starts with one page.</em></div>';
    grid.appendChild(e);
  } else {
    S.journals.forEach((j,i)=>{
      const thumb=j.pages.find(p=>p.rawImage);
      const pc=j.pages.length;
      const pat=COVER_PATS[i%COVER_PATS.length];
      const card=document.createElement('div'); card.className='jcard';
      card.onclick=(e)=>{if(!e.target.closest('.jacts'))showEd(j.id);};
      card.innerHTML='<div class="jacts">'
        +'<button class="icobtn" onclick="event.stopPropagation();renameJ(\''+j.id+'\')" title="Rename">âœï¸</button>'
        +'<button class="icobtn" onclick="event.stopPropagation();deleteJ(\''+j.id+'\')" title="Delete">ğŸ—‘</button></div>'
        +'<div class="jcov" style="background:'+j.color+';background-image:'+pat+'">' 
        +'<div class="jcov-grain"></div><div class="jspine"></div>'
        +(thumb?'<img class="jthumb" src="'+thumb.rawImage+'">'  :'')
        +'<div class="jcov-txt"><div class="jcov-name">'+esc(j.name)+'</div>'
        +'<div class="jcov-ct">'+pc+' page'+(pc!==1?'s':'')+'</div></div></div>'
        +'<div class="jmeta"><div class="jmeta-name">'+esc(j.name)+'</div>'
        +'<div class="jmeta-date">'+fmtD(j.createdAt)+'</div></div>';
      grid.appendChild(card);
    });
  }

  const nc=document.createElement('div');
  nc.innerHTML='<div class="newcard" onclick="showNewModal()"><div class="newcard-ico">ï¼‹</div><div class="newcard-lbl">new journal</div></div>';
  grid.appendChild(nc.firstElementChild);
}

const fmtD=ts=>new Date(ts).toLocaleDateString('en-US',{month:'long',year:'numeric'});

// â”€â”€â”€ HERO PREVIEW PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHeroPreview() {
  const wrap = document.getElementById('hero-preview');
  if (!wrap || wrap.dataset.built) return;
  // Guard: getDemoImg defined later in script; defer if not ready yet
  if (typeof getDemoImg !== 'function') { setTimeout(buildHeroPreview, 0); return; }
  wrap.dataset.built='1';

  const pageConfigs = [
    { left:'8%', top:'10px', rot:'-7deg', z:1, w:120, sceneId:'__d1__', title:'Tokyo Nights', date:'a thursday in november', filter: DEMO_FILTERS.moody },
    { left:'28%', top:'-20px', rot:'2deg', z:3, w:138, sceneId:'__d2__', title:'Light through the canopy', date:'early september', filter: DEMO_FILTERS.botanical },
    { left:'52%', top:'5px', rot:'-3deg', z:2, w:125, sceneId:'__d3__', title:'Marginal notes', date:'an october afternoon', filter: DEMO_FILTERS.darkacademia },
    { left:'72%', top:'30px', rot:'6deg', z:1, w:118, sceneId:'__d4__', title:'Letters unfinished', date:'found in march', filter: DEMO_FILTERS.vintage },
  ];

  pageConfigs.forEach((cfg,i)=>{
    const page = document.createElement('div');
    page.className='preview-page';
    page.style.cssText=`left:${cfg.left};top:${cfg.top};transform:rotate(${cfg.rot});z-index:${cfg.z};width:${cfg.w}px;aspect-ratio:3/4`;
    page.onclick=showDemo;

    const tapeColors=['rgba(196,168,140,.7)','rgba(155,178,140,.65)','rgba(182,140,168,.62)','rgba(100,128,180,.6)'];
    const tape=document.createElement('div'); tape.className='preview-tape';
    tape.style.cssText=`left:25%;width:50px;background-color:${tapeColors[i%tapeColors.length]};transform:rotate(${(i%2===0?-2:2)}deg)`;
    page.appendChild(tape);

    const inner=document.createElement('div'); inner.className='preview-page-inner';
    const img=document.createElement('img'); img.className='preview-page-img';
    img.src=getDemoImg(cfg.sceneId, 300, 225);
    img.style.filter=cfg.filter;
    const title=document.createElement('div'); title.className='preview-page-title'; title.textContent=cfg.title;
    const date=document.createElement('div'); date.className='preview-page-date'; date.textContent=cfg.date;
    inner.appendChild(img); inner.appendChild(title); inner.appendChild(date);
    page.appendChild(inner);
    wrap.appendChild(page);
  });
}

// â”€â”€â”€ FLOATING PAPER FRAGMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFloaters() {
  const container=document.getElementById('floaters');
  if(!container||container.dataset.built) return;
  container.dataset.built='1';
  const shapes=[
    { w:80, h:60 }, { w:50, h:40 }, { w:120, h:16 }, { w:30, h:30 },
    { w:90, h:70 }, { w:60, h:50 }, { w:100, h:80 }, { w:40, h:35 },
  ];
  shapes.forEach((sh,i)=>{
    const el=document.createElement('div'); el.className='floater';
    const leftPct=5+Math.random()*85;
    const topPct=5+Math.random()*80;
    const rot0=(Math.random()-0.5)*20;
    const rot1=rot0+(Math.random()-0.5)*12;
    const dur=12+Math.random()*16;
    const delay=Math.random()*-18;
    const maxOp=0.06+Math.random()*0.08;
    el.style.cssText=`
      left:${leftPct}%;top:${topPct}%;
      width:${sh.w}px;height:${sh.h}px;
      --dur:${dur}s;--delay:${delay}s;
      --rot0:${rot0}deg;--rot1:${rot1}deg;
      --max-op:${maxOp};
    `;
    container.appendChild(el);
  });
}

// â”€â”€â”€ JOURNAL CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selColor='#7a4020';
function pickColor(el){document.querySelectorAll('.csw').forEach(s=>s.classList.remove('sel'));el.classList.add('sel');selColor=el.dataset.c;}
function showNewModal(){if(!currentUser){openModal('m-auth');toast('Sign in to create a journal');return;}document.getElementById('inp-name').value='';openModal('m-new');setTimeout(()=>document.getElementById('inp-name').focus(),200);}
function createJournal(){
  if(!currentUser){openModal('m-auth');return;}
  const name=document.getElementById('inp-name').value.trim()||'Untitled Journal';
  S.journals.unshift({id:gid(),name,color:selColor,createdAt:Date.now(),pages:[blank()]});
  save(); closeModal('m-new'); showEd(S.journals[0].id);
}
function deleteJ(id){if(!confirm('Delete this journal?'))return;S.journals=S.journals.filter(j=>j.id!==id);save();deleteFromCloud(id);renderLib();toast('Journal deleted');}
function renameJ(id){const j=S.journals.find(j=>j.id===id);const n=prompt('Rename:',j.name);if(n&&n.trim()){j.name=n.trim();save();renderLib();}}

// â”€â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEditor(){
  const j=getJ(); if(!j) return;
  document.getElementById('ed-jname').textContent=j.name;
  S.preset=getP()?.preset||'vintage';
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===S.preset));
  document.getElementById('scrap-tog').checked=S.scrapMode;
  renderSidebar(); renderPage(); resetAiPanel();
}

function renderSidebar(){
  if(S.isDemo){renderDemoSidebar();return;}
  const j=getJ(); if(!j) return;
  const list=document.getElementById('pglist'); list.innerHTML='';
  j.pages.forEach((p,i)=>{
    const t=document.createElement('div'); t.className='pgthumb'+(i===S.pidx?' active':'');
    t.onclick=()=>selectPage(i);
    if(p.rawImage){const img=document.createElement('img');img.src=p.rawImage;img.style.cssText='position:absolute;inset:0;width:100%;height:100%;object-fit:cover';t.appendChild(img);}
    else{t.style.cssText='font-family:Caveat,cursive;font-size:10px;color:var(--muted)';t.textContent='blank';}
    const num=document.createElement('span');num.className='pgnum';num.textContent=i+1;
    t.appendChild(num); list.appendChild(t);
  });
}

function selectPage(i){
  if(S.isDemo){S.pidx=i;renderDemoSidebar();renderDemoPage(i);closePgDrawer();return;}
  S.pidx=i;
  const p=getP(); S.scrapMode=p?!!(p.scrapMode):false;
  renderSidebar(); renderPage(); resetAiPanel(); closePgDrawer();
}

function addPage(){if(S.isDemo)return;const j=getJ();if(!j)return;j.pages.push(blank());S.pidx=j.pages.length-1;S.scrapMode=false;save();renderSidebar();renderPage();resetAiPanel();toast('New page added');}
function delPage(){
  if(S.isDemo){toast('Demo pages cannot be deleted');return;}
  const j=getJ(); if(!j)return; if(j.pages.length<=1){toast('Cannot delete last page');return;}
  if(!confirm('Delete this page?'))return;
  j.pages.splice(S.pidx,1); S.pidx=Math.max(0,S.pidx-1);
  save();
  // Re-read scrap mode from new current page before rendering
  const newP=getP(); S.scrapMode=newP?!!(newP.scrapMode):false;
  renderEditor(); toast('Page deleted');
}

// â”€â”€â”€ TORN CLIP PATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeTornClipPath(pageId) {
  const rng=mkRng(strHash(pageId+'torn'));
  const jag=(t,style)=>{
    if(style==='rough') return (rng()-.5)*4.5;
    if(style==='deckled') return Math.sin(t*7)*2.2+(rng()-.5)*2.8;
    return rng()>.88?(rng()-.5)*9:(rng()-.5)*1.5;
  };
  const styles=['rough','deckled','cut'];
  const ts=styles[Math.floor(rng()*styles.length)];
  const bs=styles[Math.floor(rng()*styles.length)];
  const ls=styles[Math.floor(rng()*styles.length)];
  const rs=styles[Math.floor(rng()*styles.length)];
  const N=18; const pts=[];
  for(let i=0;i<=N;i++){const t=i/N;pts.push(`${Math.min(100,Math.max(0,t*100+jag(t,ts))).toFixed(1)}% ${Math.min(8,Math.max(0,jag(t,ts)*.6+1.5)).toFixed(1)}%`);}
  for(let i=1;i<=N;i++){const t=i/N;pts.push(`${Math.min(100,Math.max(92,100+jag(t,rs)*.7)).toFixed(1)}% ${(t*100+jag(t,rs)*.4).toFixed(1)}%`);}
  for(let i=N;i>=0;i--){const t=i/N;pts.push(`${Math.min(100,Math.max(0,t*100+jag(t,bs))).toFixed(1)}% ${Math.min(100,Math.max(92,100+jag(t,bs)*.6)).toFixed(1)}%`);}
  for(let i=N;i>=0;i--){const t=i/N;pts.push(`${Math.min(8,Math.max(0,jag(t,ls)*.7+1.5)).toFixed(1)}% ${(t*100+jag(t,ls)*.4).toFixed(1)}%`);}
  return `polygon(${pts.join(',')})`;
}

function washiStyle(pid){
  const rng=mkRng(strHash(pid+'washi'));
  const colors=['rgba(196,168,140,.65)','rgba(155,178,140,.62)','rgba(182,140,168,.58)','rgba(100,128,180,.52)','rgba(200,140,100,.62)','rgba(160,100,100,.55)','rgba(180,165,120,.6)','rgba(130,160,130,.58)'];
  return{color:colors[Math.floor(rng()*colors.length)],width:48+Math.floor(rng()*40),left:15+Math.floor(rng()*55),angle:(rng()-.5)*6};
}
function postmarkStyle(pid){
  const rng=mkRng(strHash(pid+'pm'));
  if(rng()>.62) return null;
  return{size:44+Math.floor(rng()*18),right:rng()>.5,x:8+Math.floor(rng()*14),bottom:10+Math.floor(rng()*16),angle:(rng()-.5)*18};
}

// â”€â”€â”€ RENDER PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPage(){
  if(S.isDemo){renderDemoPage(S.pidx);return;}
  const p=getP(); if(!p) return;
  S.preset=p.preset||'vintage';
  S.scrapMode = (p.scrapMode !== undefined) ? p.scrapMode : false;
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===S.preset));
  document.getElementById('scrap-tog').checked=S.scrapMode;
  const content=document.getElementById('pcontent'); content.innerHTML='';
  if(p.rawImage){
    content.appendChild(makePhotoEl(p));
    (p.layers||[]).forEach((l,li)=>{if(l.raw) content.appendChild(makeLayerEl(l,li));});
  } else { content.appendChild(makeDzEl()); }
  // Always show text fields when there's a photo (or when content exists)
  // Always show text entry fields in the editor
  const sep=document.createElement('div');sep.className='divider-orn';sep.textContent='âœ¦ âœ¦ âœ¦';content.appendChild(sep);
  content.appendChild(mkTA('f-title','add a titleâ€¦',p.title,'title',1));
  content.appendChild(mkTA('f-desc','your captionâ€¦',p.desc,'desc',3));
  content.appendChild(makeQuoteBlock(p));
  content.querySelectorAll('textarea').forEach(autoR);
  renderDecorations(p); renderLayers();
}

function makePhotoEl(p){
  const rng=mkRng(strHash(p.id+'tilt'));
  const tilts=[-2.5,-1.6,-.8,0,.8,1.6,2.5];
  const tilt=tilts[Math.floor(rng()*tilts.length)];
  const frame=document.createElement('div'); frame.className='photo-frame'; frame.style.transform=`rotate(${tilt}deg)`;
  const clip=document.createElement('div'); clip.className='photo-clip'; clip.style.clipPath=makeTornClipPath(p.id);
  const img=document.createElement('img'); img.src=p.rawImage; img.alt=''; img.style.cssText='display:block;width:100%;height:auto'; img.style.filter=PRESET_CSS[p.preset||S.preset]||PRESET_CSS.vintage;
  clip.appendChild(img); frame.appendChild(clip);
  const ws=washiStyle(p.id);
  const tape=document.createElement('div'); tape.className='photo-tape';
  tape.style.cssText=`left:${ws.left}%;width:${ws.width}px;background-color:${ws.color};transform:rotate(${ws.angle}deg)`;
  frame.appendChild(tape);
  const ps=postmarkStyle(p.id);
  if(ps){const pm=document.createElement('div');pm.className='photo-postmark';pm.style.cssText=`width:${ps.size}px;height:${ps.size}px;bottom:${ps.bottom}px;${ps.right?'right':'left'}:${ps.x}px;transform:rotate(${ps.angle}deg)`;pm.innerHTML='PAPERLY<br>âœ¦<br>'+new Date().getFullYear();pm.style.fontSize=Math.round(ps.size*.13)+'px';frame.appendChild(pm);}
  return frame;
}

function makeLayerEl(layer,li){
  const rng=mkRng(strHash(layer.id+'lt'));
  const tilts=[-2.5,-1.6,-.8,0,.8,1.6,2.5]; const tilt=tilts[Math.floor(rng()*tilts.length)];
  const scales=[.54,.62,.47,.58,.51]; const sc=scales[li%scales.length];
  const offs=[[-8,20],[36,-12],[10,42],[-4,16],[30,8]]; const [lx,ly]=offs[li%offs.length];
  const frame=document.createElement('div'); frame.className='photo-frame';
  frame.style.cssText=`transform:rotate(${tilt}deg) translate(${lx}px,${ly}px);width:${Math.round(sc*100)}%;position:relative;z-index:${li+2};margin-top:${Math.round(ly-50)}px;margin-left:${lx>0?lx:0}px`;
  const clip=document.createElement('div'); clip.className='photo-clip'; clip.style.clipPath=makeTornClipPath(layer.id);
  const img=document.createElement('img'); img.src=layer.raw; img.alt=''; img.style.cssText='display:block;width:100%;height:auto'; img.style.filter=PRESET_CSS[S.preset]||PRESET_CSS.vintage;
  clip.appendChild(img); frame.appendChild(clip);
  const ws=washiStyle(layer.id);
  const tape=document.createElement('div'); tape.className='photo-tape';
  tape.style.cssText=`left:${ws.left}%;width:${ws.width*.7}px;background-color:${ws.color};transform:rotate(${ws.angle}deg)`;
  frame.appendChild(tape); return frame;
}

function makeDzEl(){
  const dz=document.createElement('div'); dz.className='dropzone'; dz.style.marginBottom='14px';
  dz.ondragover=e=>{e.preventDefault();dz.classList.add('dv');}; dz.ondragleave=()=>dz.classList.remove('dv'); dz.ondrop=e=>onDrop(e,'main');
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange=e=>onFile(e,'main');
  dz.appendChild(inp);
  const ico=document.createElement('div');ico.className='dz-ico';ico.textContent='ğŸ–¼';
  const txt=document.createElement('div');txt.className='dz-txt';txt.innerHTML='<strong>Drop a photo here</strong><br><span style="font-family:\'Special Elite\',monospace;font-size:10px">or use the panel â†’</span>';
  dz.appendChild(ico);dz.appendChild(txt); return dz;
}

function mkTA(cls,ph,val,field,rows){
  const ta=document.createElement('textarea'); ta.className=cls; ta.placeholder=ph; ta.value=val||''; ta.rows=rows;
  ta.oninput=function(){autoR(this);saveF(field,this.value);}; return ta;
}

function makeQuoteBlock(p){
  if(S.scrapMode){
    const rng=mkRng(strHash(p.id+'sc'));
    const tapeColors=['rgba(196,168,140,.65)','rgba(155,178,140,.62)','rgba(182,140,168,.58)','rgba(100,128,180,.52)','rgba(200,140,100,.62)'];
    const tc=tapeColors[Math.floor(rng()*tapeColors.length)];
    const scR=[-1.3,-.6,0,.6,1.3][Math.floor(rng()*5)]; const tR=[-2,-1,0,1,2][Math.floor(rng()*5)];
    const wrap=document.createElement('div');wrap.className='scrap-wrap';wrap.style.transform=`rotate(${scR}deg)`;
    const tape=document.createElement('div');tape.className='scrap-tape-el';tape.style.cssText=`left:calc(50% - 26px);width:52px;background-color:${tc};transform:rotate(${tR}deg)`;
    const paper=document.createElement('div');paper.className='scrap-paper';
    const qEl=document.createElement('div');qEl.contentEditable='true';qEl.style.cssText='font-family:Caveat,cursive;font-size:19px;font-weight:600;color:var(--brown);min-height:28px;outline:none';qEl.textContent=p.quote||'';qEl.onblur=()=>saveF('quote',qEl.textContent);
    const footer=document.createElement('div');footer.className='quote-footer';footer.appendChild(mkInp('f-qdate','dateâ€¦',p.date,'date'));footer.appendChild(mkInp('f-qloc','somewhereâ€¦',p.location,'location'));
    paper.appendChild(qEl);paper.appendChild(footer);wrap.appendChild(tape);wrap.appendChild(paper); return wrap;
  } else {
    const wrap=document.createElement('div');wrap.className='quote-inline';
    wrap.appendChild(mkTA('f-quote','a quote or memoryâ€¦',p.quote,'quote',2));
    const footer=document.createElement('div');footer.className='quote-footer';footer.appendChild(mkInp('f-qdate','Sept. 2024',p.date,'date'));footer.appendChild(mkInp('f-qloc','somewhere warmâ€¦',p.location,'location'));
    wrap.appendChild(footer); return wrap;
  }
}

function mkInp(cls,ph,val,field){
  const inp=document.createElement('input');inp.type='text';inp.className=cls;inp.placeholder=ph;inp.value=val||'';inp.oninput=()=>saveF(field,inp.value); return inp;
}

function makeDecorEl(d){
  const rng=mkRng(strHash(d.id));
  const page=document.getElementById('jpage');
  const wrap=document.createElement('div');
  wrap.dataset.did=d.id;
  wrap.style.cssText=`position:absolute;left:${d.x}%;top:${d.y}%;transform:rotate(${d.rot||0}deg);z-index:20;cursor:grab;user-select:none;touch-action:none`;
  const del=document.createElement('button');del.textContent='âœ•';del.title='Remove';
  del.style.cssText='position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--rust);color:var(--cream);border:none;font-size:9px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:30;line-height:1;padding:0';
  del.onclick=e=>{e.stopPropagation();rmDecor(d.id);};
  wrap.appendChild(del);
  wrap.addEventListener('mouseenter',()=>del.style.display='flex');
  wrap.addEventListener('mouseleave',()=>del.style.display='none');
  const inner=document.createElement('div');
  const tapeColors={'tape-floral':'rgba(182,140,168,.7)','tape-stripe':'rgba(155,178,140,.7)','tape-kraft':'rgba(196,168,140,.72)'};
  if(tapeColors[d.type]){inner.style.cssText=`width:90px;height:24px;background-color:${tapeColors[d.type]};background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.28) 4px,rgba(255,255,255,.28) 5px);box-shadow:0 2px 6px rgba(0,0,0,.15)`;}
  else if(d.type==='postmark'){inner.style.cssText='width:52px;height:52px;border-radius:50%;border:2.5px solid rgba(100,28,28,.55);outline:1.2px solid rgba(100,28,28,.35);outline-offset:-6px;display:flex;align-items:center;justify-content:center;font-family:\'Special Elite\',monospace;font-size:6.5px;color:rgba(100,28,28,.7);text-align:center;line-height:1.4;background:rgba(253,245,228,.6)';inner.innerHTML='PAPERLY<br>'+['ğŸŒ¿','âš“','âœˆ','ğŸ“œ','ğŸ”­'][Math.floor(rng()*5)]+'<br>'+new Date().getFullYear();}
  else if(d.type==='botanical'){inner.style.cssText='font-size:34px;line-height:1;filter:sepia(.25)';inner.textContent=BOTANICALS[Math.floor(rng()*BOTANICALS.length)];}
  else if(d.type==='stamp'){inner.style.cssText='font-family:\'Special Elite\',monospace;font-size:11px;color:rgba(139,26,26,.68);border:2.5px solid rgba(139,26,26,.52);padding:3px 10px;letter-spacing:.13em;background:rgba(253,245,228,.55)';inner.textContent=STAMPS[Math.floor(rng()*STAMPS.length)];}
  else if(d.type==='divider'){inner.style.cssText='font-family:\'Special Elite\',monospace;font-size:10px;color:var(--muted);letter-spacing:.35em;white-space:nowrap;padding:2px 4px';inner.textContent='â€” âœ¦ âœ¦ âœ¦ â€”';}
  else if(d.type==='text'){inner.contentEditable='true';inner.style.cssText='font-family:Caveat,cursive;font-size:17px;color:var(--sepia);font-style:italic;min-width:80px;min-height:24px;outline:none;border-bottom:1px dashed rgba(160,128,80,.35);padding:1px 2px';inner.textContent=d.content||'write hereâ€¦';inner.onblur=()=>{d.content=inner.textContent;save();};inner.onmousedown=e=>e.stopPropagation();}
  wrap.appendChild(inner);
  let dragging=false,startX,startY,startLeft,startTop;
  function dragStart(cx,cy){dragging=true;wrap.style.cursor='grabbing';wrap.style.zIndex='50';startX=cx;startY=cy;const r=page.getBoundingClientRect();startLeft=d.x/100*r.width;startTop=d.y/100*r.height;}
  function dragMove(cx,cy){if(!dragging)return;const r=page.getBoundingClientRect();d.x=(Math.max(0,Math.min(r.width-10,startLeft+cx-startX))/r.width)*100;d.y=(Math.max(0,Math.min(r.height-10,startTop+cy-startY))/r.height)*100;wrap.style.left=d.x+'%';wrap.style.top=d.y+'%';}
  function dragEnd(){if(!dragging)return;dragging=false;wrap.style.cursor='grab';wrap.style.zIndex='20';save();}
  wrap.addEventListener('mousedown',e=>{if(e.target===del)return;e.preventDefault();dragStart(e.clientX,e.clientY);const mm=e=>dragMove(e.clientX,e.clientY);const mu=()=>{dragEnd();window.removeEventListener('mousemove',mm);window.removeEventListener('mouseup',mu);};window.addEventListener('mousemove',mm);window.addEventListener('mouseup',mu);});
  wrap.addEventListener('touchstart',e=>{if(e.target===del)return;const t=e.touches[0];dragStart(t.clientX,t.clientY);},{passive:true});
  wrap.addEventListener('touchmove',e=>{const t=e.touches[0];dragMove(t.clientX,t.clientY);e.preventDefault();},{passive:false});
  wrap.addEventListener('touchend',dragEnd);
  return wrap;
}

function rmDecor(did){if(S.isDemo)return;const p=getP();if(!p)return;p.decorations=(p.decorations||[]).filter(d=>d.id!==did);save();renderPage();toast('Ephemera removed');}
function renderDecorations(p){const page=document.getElementById('jpage');page.querySelectorAll('.decor-sticker').forEach(el=>el.remove());(p.decorations||[]).forEach(d=>{const el=makeDecorEl(d);el.classList.add('decor-sticker');page.appendChild(el);});}
function renderLayers(){
  const p=getP();const list=document.getElementById('layer-list');
  if(!p||!(p.layers||[]).length){list.innerHTML='<div style="font-family:Caveat,cursive;font-size:12px;color:var(--muted)">No layers yet</div>';return;}
  list.innerHTML='';
  (p.layers||[]).forEach((l,i)=>{
    const item=document.createElement('div');item.className='layer-item';
    const th=document.createElement('img');th.className='lthumb';th.src=l.raw||'';
    const info=document.createElement('div');info.className='linfo';
    const nm=document.createElement('div');nm.className='lname';nm.textContent='Layer '+(i+2);
    const hn=document.createElement('div');hn.style.cssText='font-family:\'Crimson Pro\',serif;font-style:italic;font-size:10px;color:var(--muted)';hn.textContent='collage image';
    const del=document.createElement('button');del.className='ldel';del.textContent='âœ•';del.onclick=()=>rmLayer(l.id);
    info.appendChild(nm);info.appendChild(hn);item.appendChild(th);item.appendChild(info);item.appendChild(del);list.appendChild(item);
  });
}
function rmLayer(lid){if(S.isDemo)return;const p=getP();if(!p)return;p.layers=(p.layers||[]).filter(l=>l.id!==lid);save();renderPage();toast('Layer removed');}

// â”€â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDrop(e,type){e.preventDefault();document.querySelectorAll('.dropzone').forEach(z=>z.classList.remove('dv'));if(S.isDemo){toast('Switch to your own journal to add photos');return;}const f=e.dataTransfer&&e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))type==='layer'?addLayer(f):addMainPhoto(f);}
function onFile(e,type){if(S.isDemo){toast('Switch to your own journal');e.target.value='';return;}const f=e.target&&e.target.files[0];if(f)type==='layer'?addLayer(f):addMainPhoto(f);e.target.value='';}
function addMainPhoto(file){
  const p=getP();if(!p){toast('Open a journal first');return;}
  const reader=new FileReader();
  reader.onload=function(e){p.rawImage=e.target.result;p.preset=S.preset;save();renderSidebar();renderPage();resetAiPanel();toast('Photo added âœ“');runAI();};
  reader.onerror=()=>toast('Could not read file');reader.readAsDataURL(file);
}
function addLayer(file){
  const p=getP();if(!p)return;if(!p.layers)p.layers=[];if(p.layers.length>=4){toast('Max 4 layers per page');return;}
  const reader=new FileReader();reader.onload=function(e){p.layers.push({id:gid(),raw:e.target.result});save();renderPage();toast('Layer added âœ“');};reader.readAsDataURL(file);
}

// â”€â”€â”€ PRESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPreset(preset,btn){
  S.preset=preset;if(!S.isDemo){const p=getP();if(p){p.preset=preset;save();}}
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===preset));
  document.querySelectorAll('.photo-clip img').forEach(img=>img.style.filter=PRESET_CSS[preset]||PRESET_CSS.vintage);
  toast('Style: '+PRESET_NAMES[preset]);
}

// â”€â”€â”€ DECORATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addDecor(type){
  if(S.isDemo){toast('Switch to your own journal to add ephemera');return;}
  const p=getP();if(!p)return;if(!p.decorations)p.decorations=[];
  const rng=mkRng(strHash(type+Date.now()));
  const x=10+rng()*55,y=5+rng()*35,rot=(rng()-.5)*16;
  p.decorations.push({id:gid(),type,x,y,rot,content:''});
  save();renderPage();toast('Drag to position âœ¦');
}

// â”€â”€â”€ AI (CLAUDE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetAiPanel(){
  const panel=document.getElementById('ai-panel');if(!panel)return;
  if(S.isDemo){panel.innerHTML='<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Upload a photo in your own journal â€” Claude will write your page</div>';return;}
  const p=getP();
  if(p&&p.rawImage&&!p.title) panel.innerHTML='<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Generating page contentâ€¦</div>';
  else if(p&&p.title) panel.innerHTML='<div style="font-family:\'Caveat\',cursive;font-size:12px;color:var(--muted);margin-bottom:7px">Content applied âœ“</div><button class="regen-btn" style="width:100%" onclick="runAI()">â†º REGENERATE</button>';
  else panel.innerHTML='<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Upload a photo â€” Claude writes your page</div>';
}

function downsizeForAI(dataUrl){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{const MAX=512,scale=Math.min(1,MAX/Math.max(img.naturalWidth,img.naturalHeight)),w=Math.round(img.naturalWidth*scale),h=Math.round(img.naturalHeight*scale),c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);resolve(c.toDataURL('image/jpeg',.8));};
    img.onerror=()=>resolve(dataUrl);img.src=dataUrl;
  });
}

async function runAI(){
  if(S.isDemo)return;
  const p=getP();if(!p||!p.rawImage)return;
  document.getElementById('ai-panel').innerHTML='<div class="ai-loader"><span class="quill">âœ¨</span><span>Claude is writing<br>your pageâ€¦</span></div>';
  try {
    const smallDataUrl=await downsizeForAI(p.rawImage);
    const base64Data=smallDataUrl.split(',')[1];
    const prompt='You are a junk journal co-pilot. Voice style: '+PRESET_VOICE[S.preset]+'\n\nLook at this photo and write 3 journal page suggestions. Be evocative and personal.\nBrief: titles 4-6 words, desc 1-2 sentences, quote under 12 words, date poetic, location intimate.\nRespond with ONLY valid JSON:\n{"suggestions":[{"title":"","desc":"","quote":"","date":"","location":""},{"title":"","desc":"","quote":"","date":"","location":""},{"title":"","desc":"","quote":"","date":"","location":""}]}';
    const response=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':(localStorage.getItem('paperly_api_key')||''),'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-calls':'true'},body:JSON.stringify({model:'claude-3-5-sonnet-20241022',max_tokens:800,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:'image/jpeg',data:base64Data}},{type:'text',text:prompt}]}]})});
    if(!response.ok){const e=await response.json().catch(()=>({}));const m=e?.error?.message||`HTTP ${response.status}`;if(response.status===401)throw new Error('API key required. Open browser console and run: localStorage.setItem("paperly_api_key","sk-ant-...") then retry.');throw new Error(m);}
    const data=await response.json();
    let raw=(data.content||[]).map(b=>b.text||'').join('').replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();
    const i0=raw.indexOf('{'),i1=raw.lastIndexOf('}');
    if(i0<0||i1<0)throw new Error('Unexpected response format. Please try again.');
    const parsed=JSON.parse(raw.slice(i0,i1+1));
    const sugs=parsed.suggestions;
    if(!Array.isArray(sugs)||!sugs.length)throw new Error('No suggestions returned.');
    applyS(sugs[0]);renderSugCards(sugs);
  } catch(err) {
    let msg=err.message||'Unknown error';
    if(msg.includes('Failed to fetch')||msg.includes('NetworkError')||msg.includes('Load failed'))
      msg = location.protocol==='file:'
        ? 'CORS error: API calls are blocked from file:// â€” host the app on a local server (e.g. python -m http.server) or deploy online.'
        : 'Network error â€” Anthropic API blocked direct browser calls. Ensure your API key has browser access enabled.';
    else if(msg.includes('fetch')||msg.includes('network'))msg='Network error â€” check your connection and API key.';
    else if(msg.includes('401')||msg.includes('auth'))msg='Invalid API key. Check your key at console.anthropic.com';
    else if(msg.includes('quota')||msg.includes('rate'))msg='Rate limit â€” wait a moment and retry.';
    else if(msg.length>200)msg=msg.slice(0,197)+'â€¦';
    document.getElementById('ai-panel').innerHTML='<div style="font-family:\'Special Elite\',monospace;font-size:10px;color:#8b1a1a;line-height:1.8;padding:6px 0">âš  '+esc(msg)+'</div><button class="regen-btn" onclick="runAI()">â†º RETRY</button>';
  }
}

function applyS(s){if(S.isDemo)return;const p=getP();if(!p||!s)return;p.title=s.title||'';p.desc=s.desc||'';p.quote=s.quote||'';p.date=s.date||'';p.location=s.location||'';save();renderPage();}
function renderSugCards(sugs){
  const panel=document.getElementById('ai-panel');panel.innerHTML='';
  sugs.forEach((s,i)=>{
    const card=document.createElement('div');card.className='sug-card'+(i===0?' sel':'');
    const t=document.createElement('div');t.className='sug-title';t.textContent=s.title||'';
    const d=document.createElement('div');d.className='sug-desc';d.textContent=s.desc||'';
    const q=document.createElement('div');q.className='sug-q';q.textContent='"'+(s.quote||'')+'"';
    const m=document.createElement('div');m.className='sug-meta';m.textContent=(s.date||'')+(s.location?' Â· '+s.location:'');
    card.appendChild(t);card.appendChild(d);card.appendChild(q);card.appendChild(m);
    card.onclick=()=>{document.querySelectorAll('.sug-card').forEach((c,ci)=>c.classList.toggle('sel',ci===i));applyS(s);toast('Suggestion applied âœ“');};
    panel.appendChild(card);
  });
  const rb=document.createElement('button');rb.className='regen-btn';rb.textContent='â†º REGENERATE';rb.onclick=runAI;panel.appendChild(rb);
}

function toggleScrap(on){
  S.scrapMode=on;if(!S.isDemo){const p=getP();if(p){p.scrapMode=on;save();renderPage();}}
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoR(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}
function saveF(f,v){if(S.isDemo)return;const p=getP();if(p){p[f]=v;save();}}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.querySelectorAll('.overlay.open').forEach(m=>m.classList.remove('open'));closeShare();}});
document.querySelectorAll('.overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

// â”€â”€â”€ SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShare(){
  const p=getP();if(!p){toast('Nothing to share yet');return;}
  const simg=document.getElementById('share-img');simg.src='';simg.style.display='none';document.getElementById('share-url').value='Generatingâ€¦';const shareEl=document.getElementById('share-overlay');shareEl.classList.add('open');
  const fontReady=document.fonts&&document.fonts.ready?document.fonts.ready:Promise.resolve();
  const shareData={t:p.title||'',d:p.desc||'',q:p.quote||'',dt:p.date||'',l:p.location||'',pr:p.preset||'vintage'};
  fontReady.then(()=>renderPageToCanvas(p)).then(dataUrl=>{
    simg.src=dataUrl;simg.style.display='block';
    const encoded=btoa(encodeURIComponent(JSON.stringify(shareData)));
    const baseUrl=location.href.split('?')[0];
    const shareUrl=baseUrl+'?page='+encoded;
    document.getElementById('share-url').value=shareUrl;
    if(location.protocol==='file:') toast('Tip: host the app online for shareable links');
  }).catch(()=>{document.getElementById('share-url').value='Preview failed â€” try again';toast('Preview failed');});
}
function closeShare(){document.getElementById('share-overlay').classList.remove('open');}
function copyShareUrl(){
  const url=document.getElementById('share-url').value;
  if(!url||url==='Generatingâ€¦')return;
  if(navigator.clipboard&&window.isSecureContext){
    navigator.clipboard.writeText(url).then(()=>toast('Link copied âœ“')).catch(()=>fallbackCopy(url));
  } else {
    fallbackCopy(url);
  }
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;left:-9999px;top:-9999px;opacity:0';document.body.appendChild(ta);ta.select();ta.setSelectionRange(0,99999);
  try{const ok=document.execCommand('copy');toast(ok?'Link copied âœ“':'Select the URL to copy manually');}
  catch(e){toast('Select the URL to copy manually');}
  document.body.removeChild(ta);
}
function downloadPage(){const img=document.getElementById('share-img');if(!img.src||!img.src.startsWith('data:')){toast('Preview not ready');return;}const a=document.createElement('a');a.href=img.src;a.download='paperly-page.png';a.click();toast('Saved âœ“');}
document.getElementById('share-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('share-overlay'))closeShare();});
document.getElementById('share-overlay').addEventListener('keydown',e=>{if(e.key==='Escape')closeShare();});

function renderPageToCanvas(p){
  return new Promise(resolve=>{
    const W=560,H=780,canvas=document.createElement('canvas');canvas.width=W*2;canvas.height=H*2;const ctx=canvas.getContext('2d');ctx.scale(2,2);
    ctx.fillStyle='#f6ecd6';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='rgba(150,110,70,.18)';ctx.lineWidth=1;for(let y=28;y<H;y+=28){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    ctx.strokeStyle='rgba(150,45,45,.2)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(50,0);ctx.lineTo(50,H);ctx.stroke();
    const pad={top:30,left:58,right:30};let y=pad.top;const maxW=W-pad.left-pad.right;
    const drawText=(text,font,color,mw,lineH)=>{ctx.font=font;ctx.fillStyle=color;const words=String(text||'').split(' ');let line='';for(const word of words){const test=line+(line?' ':'')+word;if(ctx.measureText(test).width>mw&&line){ctx.fillText(line,pad.left,y);y+=lineH;line=word;}else line=test;}if(line){ctx.fillText(line,pad.left,y);y+=lineH;}y+=4;};
    const _isDemo=S.isDemo; const imgSrc=p.rawImage||(_isDemo?getDemoImg(p.id,600,400):null);
    if(imgSrc){const img=new Image();img.crossOrigin='anonymous';img.onload=()=>{const rng=mkRng(strHash(p.id+'tilt'));const tilts=[-2.5,-1.6,-.8,0,.8,1.6,2.5];const tilt=tilts[Math.floor(rng()*tilts.length)]*Math.PI/180;const iW=Math.min(maxW,380),iH=Math.round(iW*img.naturalHeight/img.naturalWidth);ctx.save();ctx.translate(pad.left+iW/2,y+iH/2);ctx.rotate(tilt);ctx.shadowColor='rgba(44,26,14,.3)';ctx.shadowBlur=12;ctx.shadowOffsetX=3;ctx.shadowOffsetY=5;ctx.drawImage(img,-iW/2,-iH/2,iW,iH);ctx.shadowColor='transparent';ctx.restore();y+=iH+24;drawContent();resolve(canvas.toDataURL('image/png'));};img.onerror=()=>{drawContent();resolve(canvas.toDataURL('image/png'));};img.src=imgSrc;}
    else{drawContent();resolve(canvas.toDataURL('image/png'));}
    function drawContent(){if(!p.title&&!p.desc&&!p.quote)return;ctx.strokeStyle='rgba(180,150,100,.35)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.left,y+8);ctx.lineTo(W-pad.right,y+8);ctx.stroke();y+=22;if(p.title)drawText(p.title,'bold 24px Caveat,cursive','#2c1a0e',maxW,30);if(p.desc)drawText(p.desc,'12px "Special Elite",monospace','#7a5030',maxW,20);if(p.quote){y+=8;ctx.strokeStyle='rgba(85,92,60,.5)';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(pad.left-10,y);ctx.lineTo(pad.left-10,y+50);ctx.stroke();drawText('"'+p.quote+'"','italic 18px Caveat,cursive','#2c1a0e',maxW,26);}if(p.date||p.location){ctx.font='10px "Special Elite",monospace';ctx.fillStyle='#9a7050';ctx.fillText([p.date,p.location].filter(Boolean).join(' Â· '),pad.left,y+8);}}
  });
}

// â”€â”€â”€ MOBILE DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePgDrawer(){const sb=document.getElementById('pg-sb');sb.classList.toggle('open');document.body.classList.toggle('pgopen',sb.classList.contains('open'));}
function closePgDrawer(){document.getElementById('pg-sb').classList.remove('open');document.body.classList.remove('pgopen');}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _tt;
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('show'),2800);}

// â”€â”€â”€ DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Generate rich atmospheric scene paintings as base64 data URLs
function genSceneCanvas(sceneId, w, h) {
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  const rng = mkRng(strHash(sceneId));

  if (sceneId === '__d1__') {
    // MOODY: Rainy night city â€” dark blues, neon reflections on wet pavement
    const sky = ctx.createLinearGradient(0,0,0,h);
    sky.addColorStop(0, '#0a0814'); sky.addColorStop(.5, '#0e0c1a'); sky.addColorStop(1, '#1a1228');
    ctx.fillStyle = sky; ctx.fillRect(0,0,w,h);
    // Buildings silhouette
    const bldgs = [[0,.35,120,.65],[100,.25,90,.75],[180,.42,80,.58],[250,.3,110,.7],[340,.38,100,.62],[420,.22,130,.78],[520,.45,80,.55]];
    bldgs.forEach(([x,yt,bw,yb])=>{
      ctx.fillStyle=`hsl(240,${12+rng()*8}%,${6+rng()*6}%)`;
      ctx.fillRect(x*w/600,yt*h,bw*w/600,(yb-yt)*h);
      // windows
      for(let wy=yt*h+8;wy<yb*h-8;wy+=12){
        for(let wx=x*w/600+6;wx<(x+bw)*w/600-6;wx+=10){
          if(rng()>.55){
            const bright=rng()>.7;
            ctx.fillStyle=bright?`rgba(255,${200+rng()*55},${80+rng()*60},.85)`:`rgba(${80+rng()*60},${80+rng()*80},${140+rng()*80},.4)`;
            ctx.fillRect(wx,wy,6,8);
          }
        }
      }
    });
    // Neon signs glow
    const neons=[['#ff4488',.28,.62],['#44ffee',.52,.55],['#ff8844',.72,.48],['#aa44ff',.15,.68]];
    neons.forEach(([col,nx,ny])=>{
      const grd=ctx.createRadialGradient(nx*w,ny*h,0,nx*w,ny*h,40);
      grd.addColorStop(0,`rgba(${parseInt(col.slice(1,3),16)},${parseInt(col.slice(3,5),16)},${parseInt(col.slice(5,7),16)},0.22)`);
      grd.addColorStop(1,'transparent');
      ctx.fillStyle=grd; ctx.fillRect(0,0,w,h);
      ctx.fillStyle=col; ctx.fillRect(nx*w-18,ny*h-4,36,8);
    });
    // Wet pavement reflection strip
    const ref=ctx.createLinearGradient(0,h*.72,0,h);
    ref.addColorStop(0,'rgba(30,25,50,.0)'); ref.addColorStop(.3,'rgba(20,18,42,.7)'); ref.addColorStop(1,'rgba(10,8,22,.9)');
    ctx.fillStyle=ref; ctx.fillRect(0,h*.65,w,h*.35);
    // Reflection shimmer
    neons.forEach(([col,nx,ny])=>{
      const ry=h*.85+rng()*h*.1;
      const grd=ctx.createRadialGradient(nx*w,ry,0,nx*w,ry,30+rng()*20);
      grd.addColorStop(0,col+'55'); grd.addColorStop(1,'transparent');
      ctx.fillStyle=grd; ctx.fillRect(0,0,w,h);
    });
    // Rain streaks
    ctx.strokeStyle='rgba(180,190,220,.04)'; ctx.lineWidth=1;
    for(let i=0;i<80;i++){const rx=rng()*w,ry=rng()*h;ctx.beginPath();ctx.moveTo(rx,ry);ctx.lineTo(rx-3,ry+18);ctx.stroke();}

  } else if (sceneId === '__d2__') {
    // BOTANICAL: Forest canopy looking up â€” dappled light, deep greens
    const sky=ctx.createRadialGradient(w*.5,0,0,w*.5,0,w*.9);
    sky.addColorStop(0,'#c8e8f0'); sky.addColorStop(.4,'#a8d4c0'); sky.addColorStop(1,'#5a9060');
    ctx.fillStyle=sky; ctx.fillRect(0,0,w,h);
    // Light beam
    const beam=ctx.createRadialGradient(w*.5,0,0,w*.5,h*.6,w*.7);
    beam.addColorStop(0,'rgba(255,252,200,.45)'); beam.addColorStop(.3,'rgba(240,230,160,.12)'); beam.addColorStop(1,'rgba(200,220,160,.0)');
    ctx.fillStyle=beam; ctx.fillRect(0,0,w,h);
    // Leaf canopy shapes
    function leaf(lx,ly,lr,col,alpha){
      ctx.save(); ctx.globalAlpha=alpha;
      ctx.fillStyle=col;
      for(let i=0;i<6;i++){
        const a=rng()*Math.PI*2,r=lr*(0.5+rng()*.8);
        ctx.beginPath();ctx.ellipse(lx+Math.cos(a)*r*.4,ly+Math.sin(a)*r*.3,r*(0.6+rng()*.8),r*.35,a,0,Math.PI*2);ctx.fill();
      }
      ctx.restore();
    }
    const greens=['#1a4a20','#2a6030','#3a7040','#224828','#4a8050','#1e3a1a','#3a6848','#52904a'];
    for(let i=0;i<55;i++){leaf(rng()*w*(1.2)-(w*.1),rng()*h*.75,18+rng()*44,greens[Math.floor(rng()*greens.length)],0.55+rng()*.4);}
    // Sunlight dapple spots
    for(let i=0;i<18;i++){
      const sx=rng()*w,sy=rng()*h*.9,sr=8+rng()*28;
      const sd=ctx.createRadialGradient(sx,sy,0,sx,sy,sr);
      sd.addColorStop(0,'rgba(255,250,200,.28)'); sd.addColorStop(1,'transparent');
      ctx.fillStyle=sd; ctx.fillRect(0,0,w,h);
    }
    // Foreground dark leaves
    ctx.globalAlpha=0.85;
    for(let i=0;i<22;i++){leaf(rng()*w*1.3-(w*.15),h*.4+rng()*h*.7,25+rng()*60,greens[Math.floor(rng()*3)],0.9);}
    ctx.globalAlpha=1;

  } else if (sceneId === '__d3__') {
    // DARK ACADEMIA: Books on table, window rain â€” warm sepia browns
    const bg=ctx.createLinearGradient(0,0,0,h);
    bg.addColorStop(0,'#2a1e12'); bg.addColorStop(1,'#1a120a');
    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
    // Window on left â€” grey rain light
    const win=ctx.createLinearGradient(0,0,0,h*.65);
    win.addColorStop(0,'rgba(160,170,190,.18)'); win.addColorStop(1,'rgba(100,110,130,.06)');
    ctx.fillStyle=win; ctx.fillRect(w*.04,h*.06,w*.32,h*.58);
    ctx.strokeStyle='rgba(120,100,60,.6)'; ctx.lineWidth=3;
    ctx.strokeRect(w*.04,h*.06,w*.32,h*.58);
    ctx.strokeStyle='rgba(120,100,60,.4)'; ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(w*.2,h*.06);ctx.lineTo(w*.2,h*.64);ctx.stroke();
    ctx.beginPath();ctx.moveTo(w*.04,h*.36);ctx.lineTo(w*.36,h*.36);ctx.stroke();
    // Rain on window
    ctx.strokeStyle='rgba(180,200,220,.12)'; ctx.lineWidth=1;
    for(let i=0;i<30;i++){const rx=w*.04+rng()*w*.32,ry=rng()*h*.58+h*.06;ctx.beginPath();ctx.moveTo(rx,ry);ctx.lineTo(rx-2,ry+14);ctx.stroke();}
    // Table surface
    const table=ctx.createLinearGradient(0,h*.6,0,h);
    table.addColorStop(0,'#3a2414'); table.addColorStop(1,'#2a1a0c');
    ctx.fillStyle=table; ctx.fillRect(0,h*.6,w,h*.4);
    // Books stack
    const books=[[w*.42,h*.12,w*.14,h*.5,'#8a3a1a'],[w*.55,h*.08,w*.12,h*.54,'#3a4a6a'],[w*.66,h*.15,w*.11,h*.47,'#2a4a2a'],[w*.76,h*.1,w*.13,h*.52,'#6a4a1a'],[w*.87,h*.18,w*.1,h*.44,'#5a2a1a']];
    books.forEach(([bx,by,bw,bh,col])=>{
      ctx.fillStyle=col; ctx.fillRect(bx,by,bw,bh);
      ctx.fillStyle='rgba(255,220,150,.12)'; ctx.fillRect(bx,by,3,bh);
      ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(bx+bw-2,by,2,bh);
      for(let ly=by+bh*.2;ly<by+bh*.8;ly+=bh*.15){ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(bx,ly);ctx.lineTo(bx+bw,ly);ctx.stroke();}
    });
    // Coffee cup
    ctx.fillStyle='#f5e8d0'; ctx.beginPath(); ctx.ellipse(w*.28,h*.72,w*.08,w*.04,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#e0d0b8'; ctx.beginPath(); ctx.ellipse(w*.28,h*.72,w*.08,w*.04,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#3a2010'; ctx.beginPath(); ctx.ellipse(w*.28,h*.71,w*.055,w*.027,0,0,Math.PI*2); ctx.fill();
    // Ambient candle glow
    const candleG=ctx.createRadialGradient(w*.22,h*.55,0,w*.22,h*.55,w*.3);
    candleG.addColorStop(0,'rgba(255,180,60,.16)'); candleG.addColorStop(1,'transparent');
    ctx.fillStyle=candleG; ctx.fillRect(0,0,w,h);

  } else if (sceneId === '__d4__') {
    // VINTAGE: Shoebox contents â€” old photos, letters, faded paper on warm surface
    const bg=ctx.createLinearGradient(0,0,w*.3,h);
    bg.addColorStop(0,'#d4b888'); bg.addColorStop(1,'#c8a870');
    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
    // Paper texture grain
    for(let i=0;i<800;i++){
      ctx.fillStyle=`rgba(${80+rng()*80},${50+rng()*60},${20+rng()*30},${rng()*.04})`;
      ctx.fillRect(rng()*w,rng()*h,1+rng()*2,1+rng()*2);
    }
    // Old photo cards scattered
    const cards=[[.06,.08,.32,.44,-8],[.35,.04,.3,.42,4],[.65,.06,.28,.40,-3],[.1,.5,.34,.44,6],[.42,.48,.36,.44,-5],[.72,.46,.22,.46,3]];
    cards.forEach(([cx,cy,cw,ch,cr])=>{
      ctx.save(); ctx.translate((cx+cw/2)*w,(cy+ch/2)*h); ctx.rotate(cr*Math.PI/180);
      // photo border (white/cream border)
      ctx.fillStyle='#f5eedd'; ctx.fillRect(-cw*w/2-4,-ch*h/2-4,cw*w+8,ch*h+8);
      ctx.fillStyle='#ede0c8'; ctx.fillRect(-cw*w/2-2,-ch*h/2-2,cw*w+4,ch*h+4);
      // photo content â€” faded abstract shapes
      const pGrd=ctx.createLinearGradient(-cw*w/2,-ch*h/2,cw*w/2,ch*h/2);
      const hues=[['#9a8060','#7a6040'],['#6a7860','#4a5840'],['#807060','#604838'],['#908070','#706050']];
      const hp=hues[Math.floor(rng()*hues.length)];
      pGrd.addColorStop(0,hp[0]); pGrd.addColorStop(1,hp[1]);
      ctx.fillStyle=pGrd; ctx.fillRect(-cw*w/2,-ch*h/2,cw*w,ch*h);
      // silhouette shapes inside
      ctx.fillStyle='rgba(0,0,0,.15)';
      if(rng()>.5){// mountain/horizon
        ctx.beginPath();ctx.moveTo(-cw*w/2,ch*h*.1);ctx.lineTo(-cw*w*.1,ch*h*(-0.3));ctx.lineTo(cw*w*.15,ch*h*(-.1));ctx.lineTo(cw*w*.4,ch*h*(-.25));ctx.lineTo(cw*w/2,ch*h*.05);ctx.lineTo(cw*w/2,ch*h/2);ctx.lineTo(-cw*w/2,ch*h/2);ctx.closePath();ctx.fill();
      } else {// tree silhouette
        ctx.fillStyle='rgba(0,0,0,.18)';
        ctx.beginPath();ctx.moveTo(0,-ch*h*.35);ctx.quadraticCurveTo(cw*w*.2,-ch*h*.15,cw*w*.12,ch*h*.3);ctx.lineTo(-cw*w*.12,ch*h*.3);ctx.quadraticCurveTo(-cw*w*.2,-ch*h*.15,0,-ch*h*.35);ctx.fill();
      }
      // aged overlay
      ctx.fillStyle='rgba(180,150,80,.1)'; ctx.fillRect(-cw*w/2,-ch*h/2,cw*w,ch*h);
      ctx.restore();
    });
    // A folded letter
    ctx.save(); ctx.translate(w*.3,h*.65); ctx.rotate(-3*Math.PI/180);
    ctx.fillStyle='#f0e8d0'; ctx.fillRect(-w*.18,-h*.16,w*.36,h*.32);
    ctx.strokeStyle='rgba(150,120,60,.3)'; ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(-w*.18,0);ctx.lineTo(w*.18,0);ctx.stroke(); // fold line
    ctx.strokeStyle='rgba(100,80,40,.15)'; ctx.lineWidth=0.5;
    for(let li=0;li<5;li++){ctx.beginPath();ctx.moveTo(-w*.14,-h*.1+li*h*.04);ctx.lineTo(w*.14,-h*.1+li*h*.04);ctx.stroke();}
    ctx.restore();
    // Postage stamp
    ctx.save(); ctx.translate(w*.78,h*.25); ctx.rotate(5*Math.PI/180);
    ctx.fillStyle='#e8d8b8'; ctx.fillRect(-20,-28,40,52);
    ctx.fillStyle='#9a4820'; ctx.fillRect(-14,-22,28,36);
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-14,-22,28,15);
    ctx.restore();
    // Faded ink stains / age spots
    for(let i=0;i<12;i++){
      const sx=rng()*w,sy=rng()*h,sr=4+rng()*18;
      const sg=ctx.createRadialGradient(sx,sy,0,sx,sy,sr);
      sg.addColorStop(0,`rgba(${60+rng()*40},${40+rng()*30},${10+rng()*20},.08)`); sg.addColorStop(1,'transparent');
      ctx.fillStyle=sg; ctx.fillRect(0,0,w,h);
    }
  }

  return c.toDataURL('image/jpeg', 0.88);
}

// Cache generated images
const DEMO_SCENE_CACHE = {};
function getDemoImg(id, w=600, h=400) {
  const key = id+'_'+w+'x'+h;
  if (!DEMO_SCENE_CACHE[key]) DEMO_SCENE_CACHE[key] = genSceneCanvas(id, w, h);
  return DEMO_SCENE_CACHE[key];
}

const DEMO_PAGES = [
  { id:'__d1__', preset:'moody', title:'The city that never quite sleeps', desc:'Somewhere between the neon and the rain, the streets felt like a film I had already seen. Every window a world, every shadow a sentence left unfinished.', quote:'pressed against the glass, the world moved and I stayed still.', date:'a thursday in late november', location:'shinjuku, 2am', tape:'rgba(100,120,180,.52)', tapeAngle:'-1.8deg', tapeLeft:'26%', decorations:[], layers:[] },
  { id:'__d2__', preset:'botanical', title:'Light through the canopy', desc:'The forest held its breath. Light was breaking through in long gold columns, catching the dust of a thousand ordinary mornings.', quote:'I counted seven different greens before I stopped counting.', date:'a sunday in early september', location:'the woods behind the house', tape:'rgba(140,175,100,.52)', tapeAngle:'1.4deg', tapeLeft:'16%', decorations:[], layers:[] },
  { id:'__d3__', preset:'darkacademia', title:'Marginal notes on a rainy afternoon', desc:'The coffee cooled while I read. Outside, the rain made the windows into watercolours.', quote:'the best sentences are the ones someone else underlined first.', date:'an october afternoon', location:'the corner table, usual cafÃ©', tape:'rgba(180,145,85,.52)', tapeAngle:'-2.2deg', tapeLeft:'34%', decorations:[], layers:[] },
  { id:'__d4__', preset:'vintage', title:'Letters we never finished writing', desc:'Found them in a shoebox â€” postcards, half-written letters. Someone kept these. Someone thought they mattered. They were right.', quote:'the handwriting changes partway through. something happened.', date:'found on a tuesday in march', location:"grandmother's attic", tape:'rgba(196,168,140,.55)', tapeAngle:'2.4deg', tapeLeft:'20%', decorations:[], layers:[] },
];
const DEMO_JOURNAL = { id:'__demo__', name:'A Year in Fragments', color:'#2a3a4a', createdAt:Date.now(), isDemo:true, pages:DEMO_PAGES };
const DEMO_FILTERS = { moody:'sepia(.5) brightness(.72) contrast(1.22) saturate(.55) hue-rotate(-8deg)', botanical:'sepia(.18) brightness(1.06) contrast(1.08) saturate(.85) hue-rotate(12deg)', darkacademia:'sepia(.62) brightness(.78) contrast(1.18) saturate(.42)', vintage:'sepia(.75) brightness(.88) contrast(1.06) saturate(.68)', summer:'sepia(.22) brightness(1.12) contrast(.95) saturate(1.1) hue-rotate(8deg)' };

function makeDemoScene(page){
  const rng=mkRng(strHash(page.id+'demo'));
  const tilt=[-2.5,-1.6,-.8,0,.8,1.6,2.5][Math.floor(rng()*7)];
  const frame=document.createElement('div');frame.style.cssText=`transform:rotate(${tilt}deg);position:relative;margin-bottom:18px;isolation:isolate`;
  const clip=document.createElement('div');clip.style.cssText=`clip-path:${makeTornClipPath(page.id)};filter:drop-shadow(4px 6px 10px rgba(44,26,14,.38));overflow:hidden`;
  const img=document.createElement('img');
  img.src = getDemoImg(page.id, 600, 400);
  img.alt=page.title;
  img.style.cssText=`display:block;width:100%;height:220px;object-fit:cover;filter:${DEMO_FILTERS[page.preset]||DEMO_FILTERS.vintage}`;
  clip.appendChild(img);frame.appendChild(clip);
  const tape=document.createElement('div');tape.style.cssText=`position:absolute;top:-10px;left:${page.tapeLeft};width:74px;height:22px;z-index:5;background-color:${page.tape};transform:rotate(${page.tapeAngle});background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.22) 4px,rgba(255,255,255,.22) 5px)`;
  frame.appendChild(tape);return frame;
}

function showDemo(){
  S.isDemo=true;S.jid='__demo__';S.pidx=0;
  S.scrapMode=false;
  document.getElementById('view-lib').classList.remove('active');
  document.getElementById('view-ed').classList.add('active');
  document.getElementById('main-topbar').classList.remove('topbar-lib');
  document.getElementById('ed-jname').textContent='A Year in Fragments â€” Demo âœ¦';
  renderDemoSidebar();renderDemoPage(0);resetAiPanel();
}

function renderDemoSidebar(){
  const list=document.getElementById('pglist');list.innerHTML='';
  DEMO_PAGES.forEach((p,i)=>{
    const t=document.createElement('div');t.className='pgthumb'+(i===S.pidx?' active':'');t.title=p.title;t.style.cssText='overflow:hidden;position:relative';
    const thumbImg = document.createElement('img');
    thumbImg.src = getDemoImg(p.id, 130, 175);
    thumbImg.alt = '';
    thumbImg.style.cssText=`position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:${DEMO_FILTERS[p.preset]}`;
    t.appendChild(thumbImg);
    const num=document.createElement('span');num.className='pgnum';num.textContent=i+1;t.appendChild(num);
    t.onclick=()=>selectPage(i);list.appendChild(t);
  });
}

function renderDemoPage(idx){
  const p=DEMO_PAGES[idx];
  const content=document.getElementById('pcontent');content.innerHTML='';
  document.getElementById('jpage').querySelectorAll('.decor-sticker').forEach(el=>el.remove());
  S.preset=p.preset;
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===p.preset));
  content.appendChild(makeDemoScene(p));
  const sep=document.createElement('div');sep.className='divider-orn';sep.textContent='âœ¦ âœ¦ âœ¦';content.appendChild(sep);
  const titleEl=document.createElement('div');titleEl.style.cssText='font-family:Caveat,cursive;font-size:28px;font-weight:700;color:var(--brown);line-height:1.2;margin-bottom:7px';titleEl.textContent=p.title;content.appendChild(titleEl);
  const descEl=document.createElement('div');descEl.style.cssText='font-family:"Special Elite",monospace;font-size:11.5px;color:var(--sepia);line-height:1.9;letter-spacing:.015em;margin-bottom:12px';descEl.textContent=p.desc;content.appendChild(descEl);
  const qi=document.createElement('div');qi.className='quote-inline';
  const qtext=document.createElement('div');qtext.style.cssText='font-family:Caveat,cursive;font-size:20px;color:var(--brown);margin-bottom:6px;font-style:italic;line-height:1.3';qtext.textContent='\u201c'+p.quote+'\u201d';
  const qfooter=document.createElement('div');qfooter.style.cssText='display:flex;flex-direction:column;gap:3px';
  const qdate=document.createElement('div');qdate.style.cssText='font-family:"Special Elite",monospace;font-size:9px;color:var(--muted);letter-spacing:.08em';qdate.textContent=p.date;
  const qloc=document.createElement('div');qloc.style.cssText='font-family:Caveat,cursive;font-size:13px;color:var(--muted);font-style:italic';qloc.textContent=p.location;
  qfooter.appendChild(qdate);qfooter.appendChild(qloc);qi.appendChild(qtext);qi.appendChild(qfooter);content.appendChild(qi);
  const nav=document.createElement('div');nav.style.cssText='display:flex;align-items:center;justify-content:space-between;margin-top:24px;padding-top:14px;border-top:1px solid var(--border)';
  nav.innerHTML=`<button class="modal-btn-s" style="font-size:10px;padding:4px 10px" onclick="if(S.pidx>0){S.pidx--;renderDemoSidebar();renderDemoPage(S.pidx)}" ${idx===0?'disabled style="opacity:.3"':''}>â† Prev</button>`+`<span style="font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);letter-spacing:.1em">PAGE ${idx+1} / ${DEMO_PAGES.length}</span>`+`<button class="modal-btn-s" style="font-size:10px;padding:4px 10px" onclick="if(S.pidx<${DEMO_PAGES.length-1}){S.pidx++;renderDemoSidebar();renderDemoPage(S.pidx)}" ${idx===DEMO_PAGES.length-1?'disabled style="opacity:.3"':''}>Next â†’</button>`;
  content.appendChild(nav);
  if(idx===DEMO_PAGES.length-1){
    const cta=document.createElement('div');cta.style.cssText='margin-top:20px;padding:20px;background:rgba(44,26,14,.06);border:1px solid rgba(196,168,100,.2);text-align:center';
    cta.innerHTML='<div style="font-family:\'Cormorant Garamond\',serif;font-style:italic;font-size:18px;color:var(--brown);margin-bottom:8px">Begin your own collection</div><div style="font-family:\'Crimson Pro\',serif;font-style:italic;font-size:13px;color:var(--sepia);margin-bottom:14px;line-height:1.6">Upload any photo. Claude writes the words. Every memory, made beautiful.</div><button class="modal-btn-p" style="margin:0 auto" onclick="showLib();setTimeout(()=>currentUser?showNewModal():openModal(\'m-auth\'),100)">+ Start my journal</button>';
    content.appendChild(cta);
  }
  document.getElementById('layer-list').innerHTML='<div style="font-family:Caveat,cursive;font-size:12px;color:var(--muted)">Demo â€” no layers</div>';
}

// â”€â”€â”€ API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveApiKey(val) {
  const v = val.trim();
  const status = document.getElementById('api-key-status');
  if (v) {
    localStorage.setItem('paperly_api_key', v);
    if (status) { status.textContent = 'KEY SAVED âœ“'; status.style.color = '#5a8a5a'; }
    setTimeout(() => { if (status) status.textContent = ''; }, 2500);
  } else {
    localStorage.removeItem('paperly_api_key');
    if (status) { status.textContent = 'KEY CLEARED'; status.style.color = 'var(--muted)'; }
  }
}
function loadApiKeyInput() {
  const inp = document.getElementById('api-key-inp');
  if (!inp) return;
  const saved = localStorage.getItem('paperly_api_key') || '';
  inp.value = saved;
  const status = document.getElementById('api-key-status');
  if (status && saved) { status.textContent = 'KEY SET âœ“'; status.style.color = '#5a8a5a'; }
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init(){
  load(); renderLib(); loadApiKeyInput();
  setTimeout(()=>{if(!S.journals.length&&!currentUser)renderLib();},4000);
})();
</script>
</body>
</html>