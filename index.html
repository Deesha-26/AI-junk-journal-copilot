<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paperly ‚Äî Junk Journal Co-Pilot</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Caveat:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#e2d8c2;--paper:#f7f0de;--paper2:#efe5cc;
  --ink:#2a1f0e;--ink2:#6b5040;--muted:#a08060;
  --border:#d0bc98;--bs:#b89a70;
  --ac:#7a4020;--al:#c07838;--ap:#f0e2cc;
  --red:#8b1a1a;--sage:#4a6040;
  --sh:0 4px 18px rgba(42,31,14,.22),0 1px 4px rgba(42,31,14,.12);
  --shhov:0 14px 36px rgba(42,31,14,.28);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Crimson Pro',Georgia,serif;background:var(--bg);min-height:100vh;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.05'/%3E%3C/svg%3E"),
  linear-gradient(150deg,#ece0c6,#ddd0ae);background-attachment:fixed}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:200;background:rgba(226,216,194,.95);backdrop-filter:blur(12px);
  border-bottom:2px solid var(--border);height:56px;padding:0 22px;
  display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
.logo-stamp{width:36px;height:36px;border:2px solid var(--ac);display:flex;align-items:center;justify-content:center;
  font-family:'Special Elite',monospace;font-size:16px;color:var(--ac);transform:rotate(-3deg);
  background:rgba(247,240,222,.9);box-shadow:2px 2px 0 rgba(122,64,32,.2)}
.logo-name{font-family:'Special Elite',monospace;font-size:18px;color:var(--ink);letter-spacing:.05em}
.logo-tag{font-family:'Crimson Pro',serif;font-style:italic;font-size:11px;color:var(--muted)}
.topbar-r{display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;font-family:'Special Elite',monospace;
  font-size:12px;letter-spacing:.05em;cursor:pointer;border:none;border-radius:1px;transition:all .15s}
.btn-p{background:var(--ac);color:#f5e8d0;border:1.5px solid rgba(122,64,32,.4);box-shadow:2px 2px 0 rgba(42,31,14,.16)}
.btn-p:hover{background:#5a2e10;transform:translate(-1px,-1px);box-shadow:3px 3px 0 rgba(42,31,14,.16)}
.btn-s{background:var(--paper);color:var(--ink);border:1.5px solid var(--bs);box-shadow:2px 2px 0 rgba(42,31,14,.07)}
.btn-s:hover{background:var(--paper2);transform:translate(-1px,-1px)}
.btn-g{background:transparent;color:var(--ink2);border:1.5px solid transparent;padding:5px 9px}
.btn-g:hover{background:var(--ap);border-color:var(--border)}
.view{display:none}.view.active{display:block}

/* LIBRARY */
.library{max-width:1060px;margin:0 auto;padding:44px 22px}
.lib-h{font-family:'Special Elite',monospace;font-size:28px;color:var(--ink);letter-spacing:.04em}
.lib-s{font-family:'Crimson Pro',serif;font-style:italic;font-size:14px;color:var(--muted);margin-top:2px}
.sep{display:flex;align-items:center;gap:10px;margin:20px 0 18px;
  font-family:'Special Elite',monospace;font-size:10px;color:var(--muted);letter-spacing:.2em}
.sep::before,.sep::after{content:'';flex:1;height:1px;background:linear-gradient(to right,transparent,var(--border),transparent)}
.jgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(178px,1fr));gap:24px}
.jcard{cursor:pointer;transition:all .2s;position:relative}
.jcard:hover{transform:translateY(-6px) rotate(.3deg)}
.jcard:hover .jcov{box-shadow:var(--shhov)}
.jcov{aspect-ratio:3/4;box-shadow:var(--sh),4px 4px 0 rgba(42,31,14,.06);
  position:relative;overflow:hidden;display:flex;align-items:flex-end;padding:14px;transition:box-shadow .2s}
.jcov-grain{position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='.07'/%3E%3C/svg%3E");pointer-events:none;z-index:2}
.jspine{position:absolute;left:0;top:0;bottom:0;width:8px;background:rgba(0,0,0,.22);z-index:3}
.jthumb{position:absolute;inset:0;object-fit:cover;opacity:.22;mix-blend-mode:multiply;z-index:1}
.jcov-txt{position:relative;z-index:4;color:rgba(255,245,218,.95)}
.jcov-name{font-family:'Special Elite',monospace;font-size:13px;line-height:1.2;text-shadow:0 1px 4px rgba(0,0,0,.45);letter-spacing:.03em}
.jcov-ct{font-family:'Crimson Pro',serif;font-style:italic;font-size:11px;opacity:.85;margin-top:2px}
.jmeta{padding:8px 1px 0}
.jmeta-name{font-family:'Special Elite',monospace;font-size:11px;color:var(--ink);letter-spacing:.03em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.jmeta-date{font-family:'Crimson Pro',serif;font-style:italic;font-size:10px;color:var(--muted);margin-top:1px}
.jacts{position:absolute;top:6px;right:6px;opacity:0;transition:opacity .12s;display:flex;gap:3px;z-index:10}
.jcard:hover .jacts{opacity:1}
.icobtn{width:24px;height:24px;border-radius:50%;background:rgba(247,240,222,.92);border:1px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .12s;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.icobtn:hover{background:white;transform:scale(1.1)}
.newcard{cursor:pointer;border:2px dashed var(--bs);aspect-ratio:3/4;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:6px;color:var(--muted);transition:all .18s;background:rgba(247,240,222,.3);border-radius:1px}
.newcard:hover{border-color:var(--al);color:var(--ac);background:var(--ap);transform:translateY(-4px)}
.newcard-lbl{font-family:'Caveat',cursive;font-size:15px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(42,31,14,.52);backdrop-filter:blur(5px);
  z-index:400;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--paper);border-radius:1px;box-shadow:0 24px 60px rgba(0,0,0,.28),4px 4px 0 rgba(42,31,14,.1);
  border:1px solid var(--bs);padding:28px;width:90%;max-width:400px;
  transform:scale(.96) translateY(8px);transition:transform .2s}
.overlay.open .modal{transform:scale(1) translateY(0)}
.modal-title{font-family:'Special Elite',monospace;font-size:18px;color:var(--ink);letter-spacing:.04em;margin-bottom:2px}
.modal-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:12px;color:var(--muted);margin-bottom:18px}
.flabel{display:block;font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);letter-spacing:.12em;margin-bottom:5px}
.finput{width:100%;padding:8px 10px;border:1.5px solid var(--bs);font-family:'Caveat',cursive;font-size:17px;
  color:var(--ink);background:rgba(255,252,244,.85);outline:none;border-radius:1px;transition:border-color .12s;margin-bottom:14px}
.finput:focus{border-color:var(--al)}
.color-row{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:4px}
.csw{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .12s;position:relative}
.csw.sel{border-color:var(--ink);transform:scale(1.18)}
.csw.sel::after{content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.9);font-size:11px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
.modal-acts{display:flex;justify-content:flex-end;gap:8px;margin-top:20px;padding-top:14px;border-top:1px solid var(--border)}

/* EDITOR */
.editor{display:flex;flex-direction:column;height:calc(100vh - 56px)}
.ed-hdr{background:rgba(226,214,190,.97);border-bottom:2px solid var(--border);
  padding:0 16px;height:46px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.ed-back{font-family:'Special Elite',monospace;font-size:11px;color:var(--ink2);cursor:pointer;
  padding:4px 9px;background:none;border:1.5px solid transparent;border-radius:1px;transition:all .12s;letter-spacing:.04em}
.ed-back:hover{border-color:var(--border);background:var(--ap);color:var(--ac)}
.ed-jname{font-family:'Special Elite',monospace;font-size:13px;color:var(--ink);flex:1;letter-spacing:.04em}
.ed-body{display:flex;flex:1;overflow:hidden}

/* PAGES SIDEBAR */
.pg-sb{width:130px;background:rgba(220,210,188,.7);border-right:1px solid var(--border);
  overflow-y:auto;flex-shrink:0;padding:10px 8px;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 19px,rgba(180,150,100,.12) 19px,rgba(180,150,100,.12) 20px)}
.sb-lbl{font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);letter-spacing:.16em;margin-bottom:8px}
.pgthumb{aspect-ratio:3/4;background:var(--paper);border-radius:1px;border:2px solid var(--border);
  cursor:pointer;margin-bottom:6px;transition:all .12s;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;box-shadow:1px 2px 0 rgba(42,31,14,.06)}
.pgthumb.active{border-color:var(--ac);box-shadow:0 0 0 1px var(--ac)}
.pgthumb:hover:not(.active){border-color:var(--al)}
.pgthumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.pgnum{position:absolute;bottom:2px;right:3px;font-family:'Special Elite',monospace;font-size:7px;color:var(--muted)}
.addpg{width:100%;aspect-ratio:3/4;border:2px dashed var(--bs);background:none;border-radius:1px;
  cursor:pointer;font-family:'Caveat',cursive;font-size:11px;color:var(--muted);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .12s}
.addpg:hover{border-color:var(--al);color:var(--ac);background:var(--ap)}

/* CANVAS AREA */
.canvas-area{flex:1;overflow:auto;display:flex;justify-content:center;padding:28px 18px;
  background:#c4ae8a;
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 28px,rgba(140,110,60,.1) 28px,rgba(140,110,60,.1) 29px),
    repeating-linear-gradient(90deg,transparent,transparent 28px,rgba(140,110,60,.05) 28px,rgba(140,110,60,.05) 29px)}

/* THE JOURNAL PAGE */
.journal-page{
  width:560px;min-height:780px;position:relative;flex-shrink:0;align-self:flex-start;
  background-color:#f6ecd6;
  background-image:
    radial-gradient(ellipse 70px 58px at 88% 10%,rgba(100,65,25,.08) 52%,transparent 74%),
    radial-gradient(ellipse 58px 50px at 86% 8.5%,transparent 48%,rgba(100,65,25,.04) 54%,transparent 66%),
    url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='p'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.72' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23p)' opacity='.07'/%3E%3C/svg%3E"),
    repeating-linear-gradient(0deg,transparent,transparent 27px,rgba(150,110,70,.18) 27px,rgba(150,110,70,.18) 28px);
  box-shadow:0 6px 24px rgba(42,31,14,.22),5px 8px 0 rgba(42,31,14,.08)}
.journal-page::before{content:'';position:absolute;left:50px;top:0;bottom:0;width:1px;
  background:rgba(150,45,45,.2);z-index:1;pointer-events:none}
.journal-page::after{content:'';position:absolute;left:12px;top:0;bottom:0;width:24px;
  background:
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 72px,
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 234px,
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 396px,
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 558px;
  background-repeat:no-repeat;z-index:1;pointer-events:none}
.page-content{position:relative;z-index:10;padding:30px 30px 50px 58px;min-height:780px}

.photo-frame{display:block;position:relative;margin-bottom:18px;}
.photo-clip{position:relative;display:block;overflow:hidden;filter:drop-shadow(4px 6px 10px rgba(42,31,14,.35));}
.photo-clip img{display:block;width:100%;height:auto;}
.photo-tape{position:absolute;top:-11px;height:22px;z-index:5;
  background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.25) 4px,rgba(255,255,255,.25) 5px);}
.decor-sticker:hover{outline:1.5px dashed rgba(122,64,32,.35);outline-offset:4px;border-radius:2px}
.decor-sticker:active{cursor:grabbing!important}

.photo-postmark{position:absolute;z-index:5;border-radius:50%;border:2.5px solid rgba(110,25,25,.6);
  display:flex;align-items:center;justify-content:center;font-family:'Special Elite',monospace;font-size:6px;
  color:rgba(110,25,25,.7);text-align:center;line-height:1.3;outline:1.2px solid rgba(110,25,25,.4);outline-offset:-6px;}

/* DROP ZONE */
.dropzone{border:2px dashed var(--bs);border-radius:1px;padding:28px 14px;
  text-align:center;cursor:pointer;background:rgba(247,240,222,.5);
  transition:all .16s;position:relative;margin-bottom:14px}
.dropzone:hover,.dropzone.dv{border-color:var(--al);background:var(--ap)}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;font-size:0}
.dz-ico{font-size:22px;margin-bottom:5px}
.dz-txt{font-family:'Caveat',cursive;font-size:14px;color:var(--muted)}
.dz-txt strong{color:var(--ac)}

/* TEXT FIELDS */
.divider-orn{display:flex;align-items:center;gap:8px;
  font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);
  letter-spacing:.25em;margin:12px 0 10px}
.divider-orn::before,.divider-orn::after{content:'';flex:1;height:1px;background:var(--border)}
.f-title{font-family:'Caveat',cursive;font-size:28px;font-weight:700;color:var(--ink);
  line-height:1.15;width:100%;border:none;background:transparent;outline:none;resize:none;overflow:hidden;
  display:block;margin-bottom:5px}
.f-title:focus{outline:2px dashed rgba(122,64,32,.28);outline-offset:3px;border-radius:1px}
.f-desc{font-family:'Special Elite',monospace;font-size:12px;color:var(--ink2);line-height:1.9;
  width:100%;border:none;background:transparent;outline:none;resize:none;min-height:48px;letter-spacing:.02em;display:block;margin-bottom:7px}
.f-desc:focus{outline:2px dashed rgba(122,64,32,.2);outline-offset:3px;border-radius:1px}
.quote-inline{border-left:3px solid rgba(85,92,60,.5);padding:5px 0 5px 11px;margin:10px 0}
.f-quote{font-family:'Caveat',cursive;font-size:19px;color:var(--ink);
  width:100%;border:none;background:transparent;outline:none;resize:none;min-height:28px;display:block}
.f-quote:focus{outline:2px dashed rgba(85,92,60,.3);outline-offset:2px;border-radius:1px}
.quote-footer{display:flex;flex-direction:column;gap:5px;margin-top:6px}
.f-qdate,.f-qloc{font-family:'Special Elite',monospace;font-size:10px;color:var(--muted);
  border:none;background:transparent;outline:none;border-bottom:1px solid rgba(160,130,80,.28);
  width:100%;min-width:0;letter-spacing:.06em;padding-bottom:1px}
.f-qdate:focus,.f-qloc:focus{border-bottom-color:var(--al);outline:none}
.f-qloc{font-family:'Caveat',cursive;font-size:13px;font-style:italic}
.prompt-wrap{margin-top:10px;padding:8px 11px;border-left:3px solid rgba(70,92,60,.48);background:rgba(70,92,60,.05)}
.prompt-lbl{font-family:'Special Elite',monospace;font-size:9px;color:var(--sage);letter-spacing:.14em;margin-bottom:2px}
.f-prompt{font-family:'Caveat',cursive;font-size:15px;color:var(--sage);
  width:100%;border:none;background:transparent;outline:none;resize:none;min-height:28px;display:block}
.scrap-wrap{position:relative;display:inline-block;max-width:94%;margin:12px 0}
.scrap-paper{background:#fdf5dc;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 20px,rgba(130,100,65,.1) 20px,rgba(130,100,65,.1) 21px);
  padding:14px 14px 26px;
  clip-path:polygon(0% 2%,3% 0%,6% 2%,9% 0%,12% 2%,15% 0%,18% 1%,21% 0%,24% 2%,27% 0%,30% 1%,33% 0%,36% 2%,39% 0%,42% 1%,45% 0%,48% 2%,51% 0%,54% 1%,57% 0%,60% 2%,63% 0%,66% 1%,69% 0%,72% 2%,75% 0%,78% 1%,81% 0%,84% 2%,87% 0%,90% 1%,93% 0%,96% 2%,99% 0%,100% 2%,100% 100%,97% 96%,94% 100%,91% 96%,88% 100%,85% 95%,82% 100%,79% 96%,76% 100%,73% 95%,70% 100%,67% 96%,64% 100%,61% 95%,58% 100%,55% 96%,52% 100%,49% 95%,46% 100%,43% 96%,40% 100%,37% 95%,34% 100%,31% 96%,28% 100%,25% 95%,22% 100%,19% 96%,16% 100%,13% 95%,10% 100%,7% 96%,4% 100%,1% 96%,0% 100%);
  box-shadow:2px 3px 9px rgba(42,31,14,.15)}
.scrap-tape-el{position:absolute;top:-9px;height:18px;z-index:5;
  background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.22) 4px,rgba(255,255,255,.22) 5px)}
.inline-tape{display:block;height:20px;margin:6px -3px;opacity:.85}
.inline-div{text-align:center;font-family:'Special Elite',monospace;font-size:10px;
  color:var(--muted);letter-spacing:.35em;margin:10px 0;opacity:.65}
.inline-txt{font-family:'Caveat',cursive;font-size:17px;color:var(--ink2);
  padding:3px 0;font-style:italic;outline:none;min-height:28px;display:block}

/* RIGHT PANEL */
.rpanel{width:276px;background:rgba(224,212,188,.8);border-left:1px solid var(--border);
  overflow-y:auto;flex-shrink:0;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 26px,rgba(170,140,90,.09) 26px,rgba(170,140,90,.09) 27px)}
.psec{padding:14px;border-bottom:1px solid var(--border)}
.ptitle{font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);
  letter-spacing:.16em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:5px}
.badge{background:var(--ac);color:#f5e0c0;font-size:6.5px;padding:2px 4px;border-radius:1px;letter-spacing:.06em}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.preset-btn{padding:8px 4px;border-radius:1px;border:1.5px solid var(--border);cursor:pointer;
  text-align:center;transition:all .12s;background:rgba(247,240,222,.55);font-family:'Special Elite',monospace;
  box-shadow:1px 1px 0 rgba(42,31,14,.05)}
.preset-btn:hover{border-color:var(--al)}
.preset-btn.active{border-color:var(--ac);background:var(--ap);box-shadow:2px 2px 0 rgba(122,64,32,.1)}
.preset-ico{font-size:14px;margin-bottom:2px}
.preset-name{font-size:8.5px;color:var(--ink);letter-spacing:.05em;display:block}
.ai-loader{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 10px;text-align:center;color:var(--muted)}
.quill{font-size:22px;display:inline-block;animation:q 1.4s ease-in-out infinite}
@keyframes q{0%,100%{transform:rotate(-10deg) translateY(0)}50%{transform:rotate(6deg) translateY(-5px)}}
.ai-loader span{font-family:'Caveat',cursive;font-size:13px}
.sug-card{background:rgba(247,240,222,.7);border:1.5px solid var(--border);border-radius:1px;
  padding:10px;margin-bottom:7px;cursor:pointer;transition:all .12s;box-shadow:1px 1px 0 rgba(42,31,14,.04)}
.sug-card:hover{border-color:var(--al);background:var(--ap)}
.sug-card.sel{border-color:var(--ac);background:var(--ap);box-shadow:2px 2px 0 rgba(122,64,32,.08)}
.sug-title{font-family:'Caveat',cursive;font-size:16px;font-weight:600;color:var(--ink);margin-bottom:3px}
.sug-desc{font-family:'Special Elite',monospace;font-size:9.5px;color:var(--ink2);line-height:1.65;letter-spacing:.01em}
.sug-q{font-family:'Caveat',cursive;font-size:12px;color:var(--muted);font-style:italic;
  margin-top:4px;border-top:1px solid var(--border);padding-top:3px}
.sug-meta{font-family:'Special Elite',monospace;font-size:8.5px;color:var(--muted);margin-top:2px;letter-spacing:.04em}
.regen-btn{width:100%;padding:6px;background:none;border:1.5px solid var(--border);border-radius:1px;
  font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:4px;transition:all .12s;margin-top:5px;letter-spacing:.05em}
.regen-btn:hover{border-color:var(--al);color:var(--ac)}
.layer-list{display:flex;flex-direction:column;gap:4px}
.layer-item{display:flex;align-items:center;gap:6px;padding:5px 6px;
  background:rgba(247,240,222,.55);border:1px solid var(--border);border-radius:1px;transition:all .12s}
.layer-item:hover{border-color:var(--al)}
.lthumb{width:28px;height:28px;object-fit:cover;border-radius:1px;border:1px solid var(--border);flex-shrink:0}
.linfo{flex:1;min-width:0}
.lname{font-family:'Special Elite',monospace;font-size:9.5px;color:var(--ink);letter-spacing:.04em}
.ldel{background:none;border:none;cursor:pointer;font-size:11px;opacity:.4;transition:opacity .12s;flex-shrink:0}
.ldel:hover{opacity:1}
.decor-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
.decor-btn{padding:7px 2px;background:rgba(247,240,222,.5);border:1.5px solid var(--border);
  border-radius:1px;cursor:pointer;text-align:center;transition:all .12s;
  font-family:'Special Elite',monospace;font-size:8.5px;color:var(--ink2);letter-spacing:.04em}
.decor-btn:hover{border-color:var(--al);background:var(--ap)}
.di{font-size:14px;display:block;margin-bottom:2px}
.toggle-row{display:flex;align-items:center;gap:7px;margin-bottom:9px}
.tog{position:relative;width:28px;height:16px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0}
.tslider{position:absolute;inset:0;cursor:pointer;background:var(--bs);border-radius:8px;transition:.16s}
.tslider::before{content:'';position:absolute;width:10px;height:10px;left:3px;top:3px;
  background:white;border-radius:50%;transition:.16s}
.tog input:checked+.tslider{background:var(--ac)}
.tog input:checked+.tslider::before{transform:translateX(12px)}
.tog-lbl{font-family:'Special Elite',monospace;font-size:8.5px;color:var(--muted);letter-spacing:.07em;cursor:pointer}

/* Toast */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(14px);
  background:var(--ink);color:#f5e0c0;padding:7px 16px;border-radius:1px;
  font-family:'Special Elite',monospace;font-size:11px;letter-spacing:.06em;
  opacity:0;transition:all .24s;z-index:9999;pointer-events:none;box-shadow:3px 3px 0 rgba(0,0,0,.2)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* SHARE OVERLAY */
.share-overlay{position:fixed;inset:0;z-index:500;background:rgba(30,20,10,.88);
  backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;
  justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.share-overlay.open{opacity:1;pointer-events:all}
.share-box{background:var(--paper);border:1px solid var(--bs);
  box-shadow:0 24px 60px rgba(0,0,0,.4),5px 5px 0 rgba(42,31,14,.12);
  padding:24px;max-width:520px;width:90%;position:relative}
.share-title{font-family:'Special Elite',monospace;font-size:16px;color:var(--ink);
  letter-spacing:.06em;margin-bottom:3px}
.share-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:12px;
  color:var(--muted);margin-bottom:18px}
.share-preview{width:100%;aspect-ratio:3/4;max-height:340px;object-fit:cover;
  border:1px solid var(--border);margin-bottom:14px;display:block}
.share-acts{display:flex;gap:8px}
.share-close{position:absolute;top:12px;right:14px;background:none;border:none;
  font-size:18px;cursor:pointer;color:var(--muted);line-height:1;padding:2px 5px}
.share-close:hover{color:var(--ink)}
.share-url{width:100%;padding:7px 10px;border:1.5px solid var(--bs);
  font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);
  background:rgba(247,240,222,.7);outline:none;border-radius:1px;margin-bottom:10px;
  letter-spacing:.04em;cursor:text}

/* DEMO HERO */
.demo-hero{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:32px;
  align-items:center;padding:32px 0 24px;border-bottom:1px solid var(--border);margin-bottom:28px}
.demo-text{padding-right:12px}
.demo-eyebrow{font-family:'Special Elite',monospace;font-size:9px;color:var(--ac);
  letter-spacing:.22em;margin-bottom:10px}
.demo-headline{font-family:'Special Elite',monospace;font-size:22px;color:var(--ink);
  line-height:1.3;letter-spacing:.03em;margin-bottom:10px}
.demo-body{font-family:'Crimson Pro',serif;font-style:italic;font-size:15px;
  color:var(--ink2);line-height:1.65;margin-bottom:18px}
.demo-acts{display:flex;gap:10px;flex-wrap:wrap}
.demo-page-preview{position:relative;cursor:pointer}
.demo-page-preview:hover .demo-cover{box-shadow:var(--shhov);transform:translateY(-4px) rotate(.5deg)}
.demo-cover{
  aspect-ratio:3/4;background:#3a2810;
  background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 2px,transparent 2px,transparent 12px);
  box-shadow:var(--sh),4px 4px 0 rgba(42,31,14,.08);
  transition:all .2s;position:relative;overflow:hidden;
  display:flex;align-items:flex-end;padding:14px}
.demo-cover-grain{position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='.08'/%3E%3C/svg%3E");pointer-events:none;z-index:2}
.demo-cover-spine{position:absolute;left:0;top:0;bottom:0;width:8px;background:rgba(0,0,0,.25);z-index:3}
.demo-cover-txt{position:relative;z-index:4;color:rgba(255,245,218,.95)}
.demo-cover-name{font-family:'Special Elite',monospace;font-size:13px;line-height:1.2;
  text-shadow:0 1px 4px rgba(0,0,0,.5);letter-spacing:.03em}
.demo-cover-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:11px;opacity:.8;margin-top:3px}
.demo-badge{position:absolute;top:10px;right:10px;background:var(--ac);color:#f5e0c0;
  font-family:'Special Elite',monospace;font-size:8px;letter-spacing:.1em;
  padding:3px 7px;z-index:5;box-shadow:1px 1px 0 rgba(0,0,0,.2)}

/* AUTH */
.auth-bar{display:flex;align-items:center;gap:8px}
.user-chip{display:flex;align-items:center;gap:6px;padding:4px 10px;
  background:rgba(247,240,222,.7);border:1.5px solid var(--border);border-radius:1px;
  font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);letter-spacing:.04em}
.user-avatar{width:20px;height:20px;border-radius:50%;background:var(--ac);
  display:flex;align-items:center;justify-content:center;color:#f5e0c0;font-size:9px;font-weight:700}
.sync-dot{width:6px;height:6px;border-radius:50%;background:#4a9a4a;display:inline-block;margin-left:2px}
.sync-dot.syncing{background:var(--al);animation:pulse .8s ease-in-out infinite}
.sync-dot.offline{background:var(--muted)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.auth-modal .modal-title{margin-bottom:6px}
.auth-tabs{display:flex;gap:0;margin-bottom:18px;border:1.5px solid var(--border);border-radius:1px;overflow:hidden}
.auth-tab{flex:1;padding:7px;font-family:'Special Elite',monospace;font-size:10px;
  letter-spacing:.08em;cursor:pointer;border:none;background:transparent;
  color:var(--muted);transition:all .12s}
.auth-tab.active{background:var(--ac);color:#f5e0c0}
.auth-err{font-family:'Special Elite',monospace;font-size:9px;color:var(--red);
  margin-bottom:8px;letter-spacing:.04em;min-height:14px}

@media print{.topbar,.ed-hdr,.pg-sb,.rpanel{display:none!important}.canvas-area{padding:0;background:none!important}.journal-page{box-shadow:none;width:100%}}

@media(max-width:768px){
  .topbar{padding:0 14px;height:50px}
  .logo-name{font-size:15px}
  .logo-tag{display:none}
  .btn{padding:5px 10px;font-size:11px}
  .editor{height:auto;min-height:calc(100vh - 50px)}
  .ed-body{flex-direction:column;overflow:visible}
  .ed-hdr{height:auto;min-height:44px;flex-wrap:wrap;padding:8px 12px;gap:6px}
  .ed-jname{font-size:11px;order:-1;width:100%;flex:none}
  .pg-sb{
    position:fixed;left:0;top:0;bottom:0;z-index:300;
    transform:translateX(-100%);transition:transform .24s ease;
    width:110px;padding-top:60px;
    box-shadow:4px 0 20px rgba(42,31,14,.2);
  }
  .pg-sb.open{transform:translateX(0)}
  .pg-backdrop{
    display:none;position:fixed;inset:0;z-index:299;
    background:rgba(42,31,14,.4);backdrop-filter:blur(2px)
  }
  .pg-sb.open ~ .pg-backdrop,
  body.pgopen .pg-backdrop{display:block}
  .pg-fab{
    display:flex;position:fixed;bottom:80px;left:12px;z-index:298;
    width:44px;height:44px;border-radius:50%;
    background:var(--ac);color:#f5e0c0;border:none;cursor:pointer;
    align-items:center;justify-content:center;font-size:16px;
    box-shadow:0 4px 14px rgba(42,31,14,.3);transition:all .15s
  }
  .pg-fab:active{transform:scale(.92)}
  .canvas-area{padding:16px 10px 20px;min-height:auto;justify-content:center;overflow-x:hidden;}
  .journal-page{width:min(560px, calc(100vw - 20px));min-height:auto;}
  .rpanel{width:100%;border-left:none;border-top:2px solid var(--border);max-height:none;overflow:visible;}
  .psec{padding:12px 14px}
  .dropzone{padding:18px 12px}
  .sug-card{padding:10px}
  .sug-title{font-size:15px}
  .share-box{padding:18px;width:96%}
  .share-preview{max-height:220px}
  .modal{padding:20px;width:94%}
  .jgrid{grid-template-columns:repeat(2,1fr);gap:16px}
  .lib-h{font-size:22px}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<nav class="topbar">
  <div class="logo" onclick="showLib()">
    <div class="logo-stamp">P</div>
    <div><div class="logo-name">PAPERLY</div><div class="logo-tag">junk journal co-pilot</div></div>
  </div>
  <div class="topbar-r">
    <div class="auth-bar" id="auth-bar">
      <button class="btn btn-s" id="sign-in-btn" onclick="openModal('m-auth')" style="font-size:10px">‚Üó SIGN IN</button>
    </div>
    <button class="btn btn-p" onclick="showNewModal()">+ NEW JOURNAL</button>
  </div>
</nav>

<!-- LIBRARY -->
<div id="view-lib" class="view active">
  <div class="library">
    <div class="lib-h">YOUR JOURNALS</div>
    <div class="lib-s">a shelf full of little somethings</div>
    <div class="sep">‚ú¶ COLLECTION ‚ú¶</div>
    <div class="jgrid" id="jgrid"></div>
  </div>
</div>

<!-- EDITOR -->
<div id="view-ed" class="view">
  <div class="editor">
    <div class="ed-hdr">
      <button class="ed-back" onclick="showLib()">‚Üê BACK</button>
      <div style="width:1px;height:18px;background:var(--border)"></div>
      <div class="ed-jname" id="ed-jname"></div>
      <div style="display:flex;gap:6px;margin-left:auto">
        <button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="openShare()">‚Üó SHARE</button>
        <button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="window.print()">‚Üì EXPORT</button>
        <button class="btn btn-g" style="font-size:12px" onclick="delPage()" title="Delete page">üóë</button>
      </div>
    </div>
    <div class="ed-body">
      <div class="pg-sb" id="pg-sb">
        <div class="sb-lbl">PAGES</div>
        <div id="pglist"></div>
        <button class="addpg" onclick="addPage()">
          <span style="font-size:16px">+</span><span>page</span>
        </button>
      </div>
      <div class="pg-backdrop" id="pg-backdrop" onclick="closePgDrawer()"></div>
      <button class="pg-fab" id="pg-fab" onclick="togglePgDrawer()" title="Pages">üìÑ</button>
      <div class="canvas-area">
        <div class="journal-page" id="jpage">
          <div class="page-content" id="pcontent"></div>
        </div>
      </div>
      <div class="rpanel">
        <div class="psec">
          <div class="ptitle">üì∑ ADD PHOTO</div>
          <div class="dropzone" id="main-dz"
            ondragover="event.preventDefault();this.classList.add('dv')"
            ondragleave="this.classList.remove('dv')"
            ondrop="onDrop(event,'main')">
            <input type="file" accept="image/*" id="main-file-input" onchange="onFile(event,'main')">
            <div class="dz-ico">üñº</div>
            <div class="dz-txt"><strong>Click or drag photo</strong><br>appears instantly</div>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle">üé® STYLE</div>
          <div class="preset-grid" id="preset-grid">
            <button class="preset-btn active" data-p="vintage" onclick="setPreset('vintage',this)"><div class="preset-ico">üìú</div><span class="preset-name">VINTAGE</span></button>
            <button class="preset-btn" data-p="darkacademia" onclick="setPreset('darkacademia',this)"><div class="preset-ico">üìö</div><span class="preset-name">DARK ACADEMIA</span></button>
            <button class="preset-btn" data-p="botanical" onclick="setPreset('botanical',this)"><div class="preset-ico">üåø</div><span class="preset-name">BOTANICAL</span></button>
            <button class="preset-btn" data-p="summer" onclick="setPreset('summer',this)"><div class="preset-ico">‚òÄÔ∏è</div><span class="preset-name">FADED SUMMER</span></button>
            <button class="preset-btn" data-p="moody" onclick="setPreset('moody',this)"><div class="preset-ico">üåß</div><span class="preset-name">MOODY</span></button>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle">‚ú¶ AI SUGGESTIONS <span class="badge">CLAUDE</span></div>
          <div id="ai-panel">
            <div style="font-family:'Caveat',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">
              Upload a photo ‚Äî Claude automatically writes your page
            </div>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle"><span style="display:inline-block;width:13px;height:13px;border:1.5px solid var(--muted);border-radius:2px;vertical-align:middle;margin-right:4px;position:relative;top:-1px"></span>MEMORY SCRAP</div>
          <div class="toggle-row">
            <label class="tog"><input type="checkbox" id="scrap-tog" onchange="toggleScrap(this.checked)"><span class="tslider"></span></label>
            <span class="tog-lbl">TORN PAPER SCRAP MODE</span>
          </div>
        </div>
        <div class="psec">
          <div class="ptitle">üñº COLLAGE LAYERS</div>
          <div class="dropzone" style="padding:10px 7px;margin-bottom:6px"
            ondragover="event.preventDefault();this.classList.add('dv')"
            ondragleave="this.classList.remove('dv')"
            ondrop="onDrop(event,'layer')">
            <input type="file" accept="image/*" onchange="onFile(event,'layer')">
            <div class="dz-txt" style="font-size:12px"><strong>+ Add layer</strong></div>
          </div>
          <div class="layer-list" id="layer-list"><div style="font-family:'Caveat',cursive;font-size:12px;color:var(--muted)">No layers yet</div></div>
        </div>
        <div class="psec">
          <div class="ptitle">ü™° EPHEMERA</div>
          <div class="decor-grid">
            <button class="decor-btn" onclick="addDecor('tape-floral')"><span class="di">üå∏</span>FLORAL</button>
            <button class="decor-btn" onclick="addDecor('tape-stripe')"><span class="di">üìê</span>STRIPE</button>
            <button class="decor-btn" onclick="addDecor('tape-kraft')"><span class="di">üì¶</span>KRAFT</button>
            <button class="decor-btn" onclick="addDecor('postmark')"><span class="di">üìÆ</span>POSTMARK</button>
            <button class="decor-btn" onclick="addDecor('botanical')"><span class="di">üåø</span>PLANT</button>
            <button class="decor-btn" onclick="addDecor('stamp')"><span class="di">üîñ</span>STAMP</button>
            <button class="decor-btn" onclick="addDecor('divider')"><span class="di">‚ú¶</span>DIVIDER</button>
            <button class="decor-btn" onclick="addDecor('text')"><span class="di">‚úç</span>TEXT</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW JOURNAL MODAL -->
<div class="overlay" id="m-new">
  <div class="modal">
    <div class="modal-title">CREATE JOURNAL</div>
    <div class="modal-sub">every collection starts with a name</div>
    <label class="flabel">JOURNAL NAME</label>
    <input class="finput" type="text" id="inp-name" placeholder="Autumn Wanderings‚Ä¶" maxlength="50" onkeydown="if(event.key==='Enter')createJournal()">
    <label class="flabel">COVER COLOR</label>
    <div class="color-row">
      <div class="csw sel" data-c="#7a4020" style="background:#7a4020" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#3a4a5a" style="background:#3a4a5a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#4a5a3a" style="background:#4a5a3a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#6a2020" style="background:#6a2020" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#1e3a30" style="background:#1e3a30" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#4a3a6a" style="background:#4a3a6a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#5a4a30" style="background:#5a4a30" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#8a6a10" style="background:#8a6a10" onclick="pickColor(this)"></div>
    </div>
    <div class="modal-acts">
      <button class="btn btn-s" onclick="closeModal('m-new')">CANCEL</button>
      <button class="btn btn-p" onclick="createJournal()">CREATE</button>
    </div>
  </div>
</div>

<!-- SHARE OVERLAY -->
<div class="share-overlay" id="share-overlay">
  <div class="share-box">
    <button class="share-close" onclick="closeShare()">‚úï</button>
    <div class="share-title">SHARE THIS PAGE</div>
    <div class="share-sub">your journal page, ready to share</div>
    <canvas id="share-canvas" style="display:none"></canvas>
    <img id="share-img" class="share-preview" alt="Journal page preview">
    <input class="share-url" id="share-url" readonly onclick="this.select()" value="">
    <div class="share-acts">
      <button class="btn btn-p" style="flex:1;justify-content:center" onclick="copyShareUrl()">üìã COPY LINK</button>
      <button class="btn btn-s" style="flex:1;justify-content:center" onclick="downloadPage()">‚Üì SAVE IMAGE</button>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="overlay" id="m-auth">
  <div class="modal auth-modal" style="max-width:360px">
    <div class="modal-title">WELCOME TO PAPERLY</div>
    <div class="modal-sub">sign in to save your journals to the cloud</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-in" onclick="switchAuthTab('in')">SIGN IN</button>
      <button class="auth-tab" id="tab-up" onclick="switchAuthTab('up')">CREATE ACCOUNT</button>
    </div>
    <div class="auth-err" id="auth-err"></div>
    <label class="flabel">EMAIL</label>
    <input class="finput" type="email" id="auth-email" placeholder="you@example.com" style="margin-bottom:10px"
      onkeydown="if(event.key==='Enter')document.getElementById('auth-pass').focus()">
    <label class="flabel">PASSWORD</label>
    <input class="finput" type="password" id="auth-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter')submitAuth()">
    <div class="modal-acts">
      <button class="btn btn-s" onclick="closeModal('m-auth')">CANCEL</button>
      <button class="btn btn-p" id="auth-submit-btn" onclick="submitAuth()">SIGN IN</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEEDED RNG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkRng(seed) {
  let s = Math.abs(seed) | 0 || 1;
  return () => { s = (Math.imul(1664525, s) + 1013904223) | 0; return (s >>> 0) / 4294967295; };
}
function strHash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (Math.imul(31, h) + str.charCodeAt(i)) | 0;
  return Math.abs(h);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSS FILTER PRESETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PRESET_CSS = {
  vintage:      'sepia(.65) brightness(.88) contrast(1.06) saturate(.78)',
  darkacademia: 'sepia(.35) brightness(.72) contrast(1.2) saturate(.48)',
  botanical:    'sepia(.15) brightness(1.04) contrast(1.04) saturate(.9) hue-rotate(14deg)',
  summer:       'sepia(.1) brightness(1.1) contrast(.96) saturate(1.2)',
  moody:        'sepia(.45) brightness(.68) contrast(1.22) saturate(.4) hue-rotate(-10deg)',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TORN EDGE CLIP PATH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeTornClipPath(pageId) {
  const rng = mkRng(strHash(pageId + 'torn'));
  const W = 100, H = 100;
  const jag = (t, style) => {
    if (style === 'rough')   return (rng() - .5) * 4.5;
    if (style === 'deckled') return Math.sin(t * 7) * 2.2 + (rng() - .5) * 2.8;
    return rng() > .88 ? (rng() - .5) * 9 : (rng() - .5) * 1.5;
  };
  const styles = ['rough', 'deckled', 'cut'];
  const ts = styles[Math.floor(rng() * styles.length)];
  const bs = styles[Math.floor(rng() * styles.length)];
  const ls = styles[Math.floor(rng() * styles.length)];
  const rs = styles[Math.floor(rng() * styles.length)];
  const N = 18;
  const pts = [];
  for (let i = 0; i <= N; i++) {
    const t = i / N;
    pts.push(`${Math.min(100, Math.max(0, t * W + jag(t, ts))).toFixed(1)}% ${Math.min(8, Math.max(0, jag(t, ts) * .6 + 1.5)).toFixed(1)}%`);
  }
  for (let i = 1; i <= N; i++) {
    const t = i / N;
    pts.push(`${Math.min(100, Math.max(92, W + jag(t, rs) * .7)).toFixed(1)}% ${(t * H + jag(t, rs) * .4).toFixed(1)}%`);
  }
  for (let i = N; i >= 0; i--) {
    const t = i / N;
    pts.push(`${Math.min(100, Math.max(0, t * W + jag(t, bs))).toFixed(1)}% ${Math.min(100, Math.max(92, H + jag(t, bs) * .6)).toFixed(1)}%`);
  }
  for (let i = N; i >= 0; i--) {
    const t = i / N;
    pts.push(`${Math.min(8, Math.max(0, jag(t, ls) * .7 + 1.5)).toFixed(1)}% ${(t * H + jag(t, ls) * .4).toFixed(1)}%`);
  }
  return `polygon(${pts.join(',')})`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WASHI TAPE / POSTMARK STYLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function washiStyle(pageId) {
  const rng = mkRng(strHash(pageId + 'washi'));
  const colors = [
    'rgba(196,168,140,.65)', 'rgba(155,178,140,.62)', 'rgba(182,140,168,.58)',
    'rgba(100,128,180,.52)', 'rgba(200,140,100,.62)', 'rgba(160,100,100,.55)',
    'rgba(180,165,120,.6)',  'rgba(130,160,130,.58)',
  ];
  const color = colors[Math.floor(rng() * colors.length)];
  const width = 48 + Math.floor(rng() * 40);
  const left  = 15 + Math.floor(rng() * 55);
  const angle = (rng() - .5) * 6;
  return { color, width, left, angle };
}

function postmarkStyle(pageId) {
  const rng = mkRng(strHash(pageId + 'pm'));
  if (rng() > .62) return null;
  const size  = 44 + Math.floor(rng() * 18);
  const right = rng() > .5;
  const x     = 8 + Math.floor(rng() * 14);
  const bottom= 10 + Math.floor(rng() * 16);
  const angle = (rng() - .5) * 18;
  return { size, right, x, bottom, angle };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  journals: [],
  jid: null,
  pidx: 0,
  preset: 'vintage',
  scrapMode: false,
  isDemo: false,   // FIX: explicit demo mode flag
};

const PRESET_NAMES = {
  vintage: 'VINTAGE', darkacademia: 'DARK ACADEMIA',
  botanical: 'BOTANICAL', summer: 'FADED SUMMER', moody: 'MOODY',
};

const PRESET_VOICE = {
  vintage:      "Write in a warm antique voice ‚Äî like a letter found in a grandmother's attic. Poetic, nostalgic.",
  darkacademia: "Write with literary melancholy ‚Äî candlelight, old books, autumn, the quiet pursuit of beauty.",
  botanical:    "Write with a naturalist's reverence ‚Äî gentle, observational, in awe of living things.",
  summer:       "Write with sun-bleached nostalgia ‚Äî a perfect afternoon, faded and bittersweet.",
  moody:        "Write with cinematic introspection ‚Äî rain, ink, quiet sadness that feels like a gift.",
};

const BOTANICALS  = ['üåø','üçÉ','üåæ','üçÇ','üå∏','üå∫','üåª','üåπ','üçÄ','üåµ'];
const STAMPS      = ['PASSED','RECEIVED','FRAGILE','SPECIAL','MEMORIES','FOUND','RARE','ARCHIVAL'];
const COVER_PATS  = [
  'repeating-linear-gradient(45deg,rgba(255,255,255,.07) 0,rgba(255,255,255,.07) 2px,transparent 2px,transparent 12px)',
  'repeating-linear-gradient(135deg,rgba(255,255,255,.05) 0,rgba(255,255,255,.05) 1px,transparent 1px,transparent 8px)',
  'radial-gradient(ellipse at 30% 30%,rgba(255,255,255,.1) 0%,transparent 55%)',
  'repeating-linear-gradient(0deg,rgba(255,255,255,.05) 0,rgba(255,255,255,.05) 1px,transparent 1px,transparent 16px)',
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPA_URL  = 'https://dgqvpttyrnsunsjjfqwv.supabase.co';
const SUPA_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRncXZwdHR5cm5zdW5zampmcXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDUyNDcsImV4cCI6MjA4NzM4MTI0N30.-zdMprzTCFUKdtWYDKekLbHmxJs4iAhKh9itb8g398o';
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

let currentUser = null;
let saveTimer   = null;

function save() {
  // FIX: Never save when in demo mode
  if (S.isDemo) return;

  try {
    const lite = S.journals.map(j => ({
      ...j,
      pages: j.pages.map(p => ({
        ...p,
        rawImage: p.rawImage ? '__R__' : null,
        layers: (p.layers || []).map(l => ({ ...l, raw: '__R__' })),
      })),
    }));
    localStorage.setItem('paperly6', JSON.stringify(lite));
    S.journals.forEach(j => j.pages.forEach(p => {
      if (p.rawImage) try { localStorage.setItem('pr_' + p.id, p.rawImage); } catch(e) {}
      (p.layers || []).forEach(l => {
        if (l.raw) try { localStorage.setItem('pr_' + l.id, l.raw); } catch(e) {}
      });
    }));
  } catch(e) {}

  if (currentUser) {
    setSyncDot('syncing');
    clearTimeout(saveTimer);
    saveTimer = setTimeout(syncToCloud, 1500);
  }
}

async function syncToCloud() {
  if (!currentUser || !S.journals.length) { setSyncDot('ok'); return; }
  try {
    for (const j of S.journals) {
      const { error } = await sb.from('journals').upsert({
        id: j.id,
        user_id: currentUser.id,
        data: j,
        updated_at: new Date().toISOString(),
      }, { onConflict: 'id' });
      if (error) throw error;
    }
    setSyncDot('ok');
  } catch(err) {
    console.warn('Cloud sync failed:', err.message);
    setSyncDot('offline');
    toast('Saved locally ‚Äî cloud sync failed');
  }
}

function load() {
  try {
    const raw = localStorage.getItem('paperly6');
    if (!raw) return;
    S.journals = JSON.parse(raw);
    S.journals.forEach(j => j.pages.forEach(p => {
      if (p.rawImage === '__R__') p.rawImage = localStorage.getItem('pr_' + p.id) || null;
      (p.layers || []).forEach(l => {
        if (l.raw === '__R__') l.raw = localStorage.getItem('pr_' + l.id) || null;
      });
    }));
  } catch(e) { S.journals = []; }
}

async function loadFromCloud() {
  if (!currentUser) return;
  try {
    const { data, error } = await sb
      .from('journals')
      .select('data')
      .eq('user_id', currentUser.id)
      .order('updated_at', { ascending: false });
    if (error) throw error;
    if (data && data.length) {
      S.journals = data.map(r => r.data);
      save();
    }
    setSyncDot('ok');
  } catch(err) {
    console.warn('Cloud load failed:', err.message);
    setSyncDot('offline');
  }
}

async function deleteFromCloud(id) {
  if (!currentUser) return;
  try {
    await sb.from('journals').delete().eq('id', id).eq('user_id', currentUser.id);
  } catch(err) { console.warn('Cloud delete failed:', err.message); }
}

function setSyncDot(state) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (state === 'syncing' ? ' syncing' : state === 'offline' ? ' offline' : '');
  dot.title = state === 'ok' ? 'Saved to cloud' : state === 'syncing' ? 'Saving‚Ä¶' : 'Offline ‚Äî saved locally';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let authMode = 'in';

function switchAuthTab(mode) {
  authMode = mode;
  document.getElementById('tab-in').classList.toggle('active', mode === 'in');
  document.getElementById('tab-up').classList.toggle('active', mode === 'up');
  document.getElementById('auth-submit-btn').textContent = mode === 'in' ? 'SIGN IN' : 'CREATE ACCOUNT';
  document.getElementById('auth-err').textContent = '';
}

async function submitAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const pass  = document.getElementById('auth-pass').value;
  const errEl = document.getElementById('auth-err');
  errEl.textContent = '';

  if (!email || !pass) { errEl.textContent = 'EMAIL AND PASSWORD REQUIRED'; return; }
  const btn = document.getElementById('auth-submit-btn');
  btn.textContent = '‚Ä¶'; btn.disabled = true;

  try {
    if (authMode === 'in') {
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) {
        if (error.message.toLowerCase().includes('invalid login')) {
          throw new Error('Incorrect email or password. Need an account? Switch to "Create Account".');
        }
        throw error;
      }
    } else {
      const { error: signUpError } = await sb.auth.signUp({ email, password: pass });
      if (signUpError) {
        if (signUpError.message.toLowerCase().includes('already registered')) {
          throw new Error('Email already registered. Switch to "Sign In".');
        }
        throw signUpError;
      }
      const { error: signInError } = await sb.auth.signInWithPassword({ email, password: pass });
      if (signInError) throw signInError;
      toast('Account created ‚Äî welcome to Paperly ‚úì');
    }
    closeModal('m-auth');
    document.getElementById('auth-email').value = '';
    document.getElementById('auth-pass').value = '';
  } catch(err) {
    errEl.textContent = err.message;
  } finally {
    btn.textContent = authMode === 'in' ? 'SIGN IN' : 'CREATE ACCOUNT';
    btn.disabled = false;
  }
}

async function signOut() {
  await sb.auth.signOut();
  currentUser = null;
  S.journals = [];
  load();
  renderAuthBar(null);
  renderLib();
  toast('Signed out');
}

function renderAuthBar(user) {
  const bar = document.getElementById('auth-bar');
  if (!user) {
    bar.innerHTML = '<button class="btn btn-s" onclick="openModal(\'m-auth\')" style="font-size:10px">‚Üó SIGN IN</button>';
  } else {
    const initials = user.email.slice(0, 2).toUpperCase();
    bar.innerHTML =
      '<div class="user-chip">'
      + '<div class="user-avatar">' + initials + '</div>'
      + '<span>' + user.email.split('@')[0] + '</span>'
      + '<span class="sync-dot" id="sync-dot" title="Saved to cloud"></span>'
      + '</div>'
      + '<button class="btn btn-g" onclick="signOut()" style="font-size:10px">SIGN OUT</button>';
  }
}

sb.auth.onAuthStateChange(async (event, session) => {
  if (event === 'TOKEN_REFRESHED' && !session) return;

  currentUser = session?.user || null;
  renderAuthBar(currentUser);

  if (currentUser) {
    if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
      if (event === 'SIGNED_IN') toast('Signed in ‚Äî syncing journals‚Ä¶');
      setSyncDot('syncing');

      const localSnap = [...S.journals];
      await loadFromCloud();

      for (const lj of localSnap) {
        if (!S.journals.find(j => j.id === lj.id)) {
          S.journals.push(lj);
        }
      }
      if (localSnap.length) await syncToCloud();
      if (event === 'SIGNED_IN') toast('Journals synced ‚úì');
      renderLib();
    }
  } else {
    if (event === 'SIGNED_OUT') {
      S.journals = [];
      load();
      renderLib();
    }
    if (event === 'INITIAL_SESSION') {
      renderLib();
    }
  }
});

const gid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 5);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX (BUG 1): getJ / getP ‚Äî demo-aware, no override shenanigans.
// All code references these directly. They check S.isDemo flag.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getJ() {
  if (S.isDemo) return DEMO_JOURNAL;
  return S.journals.find(j => j.id === S.jid) || null;
}
function getP() {
  if (S.isDemo) return DEMO_PAGES[S.pidx] || null;
  const j = getJ();
  return j ? (j.pages[S.pidx] || null) : null;
}

const blank = () => ({
  id: gid(), rawImage: null, preset: 'vintage',
  title: '', desc: '', quote: '', date: '', location: '',
  decorations: [], layers: [],
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLib() {
  S.isDemo = false;
  document.getElementById('view-lib').classList.add('active');
  document.getElementById('view-ed').classList.remove('active');
  renderLib();
}

function showEd(jid) {
  S.isDemo = false;
  S.jid = jid;
  S.pidx = 0;
  document.getElementById('view-lib').classList.remove('active');
  document.getElementById('view-ed').classList.add('active');
  renderEditor();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLib() {
  const grid = document.getElementById('jgrid');
  grid.innerHTML = '';

  if (!currentUser) {
    const landing = document.createElement('div');
    landing.className = 'demo-hero';
    landing.style.cssText = 'grid-column:1/-1';
    landing.innerHTML = `
      <div class="demo-text">
        <div class="demo-eyebrow">‚ú¶ WELCOME TO PAPERLY</div>
        <div class="demo-headline">Turn any photo into a beautiful journal page</div>
        <div class="demo-body">Upload a photo. Claude reads the image and writes your title, caption, and memory quote ‚Äî instantly. Every page feels handmade.</div>
        <div class="demo-acts">
          <button class="btn btn-p" onclick="openModal('m-auth')">‚Üó SIGN IN TO START</button>
          <button class="btn btn-s" onclick="showDemo()">üëÅ SEE A DEMO</button>
        </div>
      </div>
      <div class="demo-page-preview" onclick="showDemo()">
        <div class="demo-cover">
          <div class="demo-cover-grain"></div>
          <div class="demo-cover-spine"></div>
          <div class="demo-badge">DEMO</div>
          <div class="demo-cover-txt">
            <div class="demo-cover-name">Tokyo Nights</div>
            <div class="demo-cover-sub">a thursday in late november</div>
          </div>
        </div>
      </div>`;
    grid.appendChild(landing);
    return;
  }

  const demoCard = document.createElement('div');
  demoCard.className = 'jcard';
  demoCard.onclick = showDemo;
  demoCard.innerHTML =
    '<div class="jcov" style="background:#2a3a4a;overflow:hidden">'
    + '<div class="jcov-grain"></div><div class="jspine"></div>'
    + `<img class="jthumb" src="${DEMO_PAGES[0].photo}" style="filter:${DEMO_FILTERS[DEMO_PAGES[0].preset]}" onerror="this.style.display='none'">`
    + '<div class="demo-badge" style="top:8px;right:8px">DEMO</div>'
    + '<div class="jcov-txt"><div class="jcov-name">A Year in Fragments</div><div class="jcov-ct">4 pages ¬∑ tap to explore</div></div></div>'
    + '<div class="jmeta"><div class="jmeta-name">Demo Journal</div><div class="jmeta-date">see what\'s possible</div></div>';
  grid.appendChild(demoCard);

  if (!S.journals.length) {
    const empty = document.createElement('div');
    empty.style.cssText = 'grid-column:2/-1;display:flex;align-items:center;padding:20px 0';
    empty.innerHTML = '<div style="font-family:\'Crimson Pro\',serif;font-style:italic;color:var(--muted);font-size:14px">Your journals will appear here once you create one ‚Üí</div>';
    grid.appendChild(empty);
  } else {
    S.journals.forEach((j, i) => {
      const thumb = j.pages.find(p => p.rawImage);
      const pc = j.pages.length;
      const pat = COVER_PATS[i % COVER_PATS.length];
      const card = document.createElement('div');
      card.className = 'jcard';
      card.innerHTML = '<div class="jacts">'
        + '<button class="icobtn" onclick="event.stopPropagation();renameJ(\'' + j.id + '\')" title="Rename">‚úèÔ∏è</button>'
        + '<button class="icobtn" onclick="event.stopPropagation();deleteJ(\'' + j.id + '\')" title="Delete">üóë</button></div>'
        + '<div class="jcov" style="background:' + j.color + ';background-image:' + pat + '" onclick="showEd(\'' + j.id + '\')">'
        + '<div class="jcov-grain"></div><div class="jspine"></div>'
        + (thumb ? '<img class="jthumb" src="' + thumb.rawImage + '">' : '')
        + '<div class="jcov-txt"><div class="jcov-name">' + esc(j.name) + '</div>'
        + '<div class="jcov-ct">' + pc + ' page' + (pc !== 1 ? 's' : '') + '</div></div></div>'
        + '<div class="jmeta"><div class="jmeta-name">' + esc(j.name) + '</div>'
        + '<div class="jmeta-date">' + fmtD(j.createdAt) + '</div></div>';
      grid.appendChild(card);
    });
  }

  const nc = document.createElement('div');
  nc.innerHTML = '<div class="newcard" onclick="showNewModal()"><div style="font-size:22px">Ôºã</div><div class="newcard-lbl">new journal</div></div>';
  grid.appendChild(nc.firstElementChild);
}
const fmtD = ts => new Date(ts).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOURNAL CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selColor = '#7a4020';
function pickColor(el) { document.querySelectorAll('.csw').forEach(s => s.classList.remove('sel')); el.classList.add('sel'); selColor = el.dataset.c; }
function showNewModal() {
  if (!currentUser) { openModal('m-auth'); toast('Sign in to create a journal'); return; }
  document.getElementById('inp-name').value = '';
  openModal('m-new');
  setTimeout(() => document.getElementById('inp-name').focus(), 200);
}
function createJournal() {
  if (!currentUser) { openModal('m-auth'); return; }
  const name = document.getElementById('inp-name').value.trim() || 'Untitled Journal';
  S.journals.unshift({ id: gid(), name, color: selColor, createdAt: Date.now(), pages: [blank()] });
  save(); closeModal('m-new'); showEd(S.journals[0].id);
}
function deleteJ(id) {
  if (!confirm('Delete this journal?')) return;
  S.journals = S.journals.filter(j => j.id !== id);
  save();
  deleteFromCloud(id);
  renderLib();
  toast('Journal deleted');
}
function renameJ(id) { const j = S.journals.find(j => j.id === id); const n = prompt('Rename:', j.name); if (n && n.trim()) { j.name = n.trim(); save(); renderLib(); } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEditor() {
  const j = getJ(); if (!j) return;
  document.getElementById('ed-jname').textContent = j.name;
  S.preset = getP()?.preset || 'vintage';
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === S.preset));
  document.getElementById('scrap-tog').checked = S.scrapMode;
  renderSidebar();
  renderPage();
  resetAiPanel();
}

function renderSidebar() {
  // FIX (BUG 2): Demo mode sidebar is handled by renderDemoSidebar ‚Äî don't mix them
  if (S.isDemo) { renderDemoSidebar(); return; }

  const j = getJ(); if (!j) return;
  const list = document.getElementById('pglist');
  list.innerHTML = '';
  j.pages.forEach((p, i) => {
    const t = document.createElement('div');
    t.className = 'pgthumb' + (i === S.pidx ? ' active' : '');
    t.onclick = () => selectPage(i);
    if (p.rawImage) {
      const img = document.createElement('img');
      img.src = p.rawImage;
      t.appendChild(img);
    } else {
      t.style.cssText = 'font-family:Caveat,cursive;font-size:10px;color:var(--muted)';
      t.textContent = 'blank';
    }
    const num = document.createElement('span'); num.className = 'pgnum'; num.textContent = i + 1;
    t.appendChild(num);
    list.appendChild(t);
  });
}

function selectPage(i) {
  // FIX (BUG 2): Demo page selection goes to demo renderer
  if (S.isDemo) {
    S.pidx = i;
    renderDemoSidebar();
    renderDemoPage(i);
    closePgDrawer();
    return;
  }
  S.pidx = i;
  renderSidebar();
  renderPage();
  resetAiPanel();
  closePgDrawer();
}

function addPage() {
  if (S.isDemo) return; // no-op in demo
  const j = getJ(); j.pages.push(blank()); S.pidx = j.pages.length - 1;
  save(); renderSidebar(); renderPage(); resetAiPanel(); toast('New page added');
}

function delPage() {
  if (S.isDemo) { toast('Demo pages cannot be deleted'); return; }
  const j = getJ();
  if (j.pages.length <= 1) { toast('Cannot delete last page'); return; }
  if (!confirm('Delete this page?')) return;
  j.pages.splice(S.pidx, 1);
  S.pidx = Math.max(0, S.pidx - 1);
  save(); renderEditor(); toast('Page deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER PAGE
// FIX (BUG 3): renderPage now routes to demo renderer when in demo mode
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPage() {
  if (S.isDemo) { renderDemoPage(S.pidx); return; }

  const p = getP(); if (!p) return;
  S.preset = p.preset || 'vintage';
  if (p.scrapMode !== undefined) S.scrapMode = p.scrapMode;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === S.preset));
  document.getElementById('scrap-tog').checked = S.scrapMode;

  const content = document.getElementById('pcontent');
  content.innerHTML = '';

  if (p.rawImage) {
    content.appendChild(makePhotoEl(p));
    (p.layers || []).forEach((layer, li) => { if (layer.raw) content.appendChild(makeLayerEl(layer, li)); });
  } else {
    content.appendChild(makeDzEl());
  }

  if (p.title || p.desc || p.quote || p.date || p.location) {
    const sep = document.createElement('div');
    sep.className = 'divider-orn'; sep.textContent = '‚ú¶ ‚ú¶ ‚ú¶';
    content.appendChild(sep);
    if (p.title || p.desc) {
      content.appendChild(mkTA('f-title', 'add a title‚Ä¶', p.title, 'title', 1));
      content.appendChild(mkTA('f-desc', 'your caption‚Ä¶', p.desc, 'desc', 3));
    }
    if (p.quote || p.date || p.location) content.appendChild(makeQuoteBlock(p));
  }

  content.querySelectorAll('textarea').forEach(autoR);
  renderDecorations(p);
  renderLayers();
}

function makePhotoEl(p) {
  const rng   = mkRng(strHash(p.id + 'tilt'));
  const tilts = [-2.5, -1.6, -.8, 0, .8, 1.6, 2.5];
  const tilt  = tilts[Math.floor(rng() * tilts.length)];

  const frame = document.createElement('div');
  frame.className = 'photo-frame';
  frame.style.transform = 'rotate(' + tilt + 'deg)';

  const clip = document.createElement('div');
  clip.className = 'photo-clip';
  clip.style.clipPath = makeTornClipPath(p.id);

  const img = document.createElement('img');
  img.src = p.rawImage;
  img.alt = '';
  img.style.cssText = 'display:block;width:100%;height:auto';
  img.style.filter = PRESET_CSS[p.preset || S.preset] || PRESET_CSS.vintage;

  clip.appendChild(img);
  frame.appendChild(clip);

  const ws = washiStyle(p.id);
  const tape = document.createElement('div');
  tape.className = 'photo-tape';
  tape.style.cssText = 'left:' + ws.left + '%;width:' + ws.width + 'px;background-color:' + ws.color + ';transform:rotate(' + ws.angle + 'deg)';
  frame.appendChild(tape);

  const ps = postmarkStyle(p.id);
  if (ps) {
    const pm = document.createElement('div');
    pm.className = 'photo-postmark';
    const side = ps.right ? 'right:' + ps.x + 'px' : 'left:' + ps.x + 'px';
    pm.style.cssText = 'width:' + ps.size + 'px;height:' + ps.size + 'px;bottom:' + ps.bottom + 'px;' + side + ';transform:rotate(' + ps.angle + 'deg)';
    pm.innerHTML = 'PAPERLY<br>‚ú¶<br>' + new Date().getFullYear();
    pm.style.fontSize = Math.round(ps.size * .13) + 'px';
    frame.appendChild(pm);
  }

  return frame;
}

function makeLayerEl(layer, li) {
  const rng   = mkRng(strHash(layer.id + 'lt'));
  const tilts = [-2.5, -1.6, -.8, 0, .8, 1.6, 2.5];
  const tilt  = tilts[Math.floor(rng() * tilts.length)];
  const scales= [.54, .62, .47, .58, .51];
  const sc    = scales[li % scales.length];
  const offs  = [[-8, 20], [36, -12], [10, 42], [-4, 16], [30, 8]];
  const [lx, ly] = offs[li % offs.length];

  const frame = document.createElement('div');
  frame.className = 'photo-frame';
  frame.style.cssText = 'transform:rotate(' + tilt + 'deg) translate(' + lx + 'px,' + ly + 'px);width:' + Math.round(sc * 100) + '%;position:relative;z-index:' + (li + 2) + ';margin-top:' + Math.round(ly - 50) + 'px;margin-left:' + (lx > 0 ? lx : 0) + 'px';

  const clip = document.createElement('div');
  clip.className = 'photo-clip';
  clip.style.clipPath = makeTornClipPath(layer.id);

  const img = document.createElement('img');
  img.src = layer.raw;
  img.alt = '';
  img.style.cssText = 'display:block;width:100%;height:auto';
  img.style.filter = PRESET_CSS[S.preset] || PRESET_CSS.vintage;

  clip.appendChild(img);
  frame.appendChild(clip);

  const ws = washiStyle(layer.id);
  const tape = document.createElement('div');
  tape.className = 'photo-tape';
  tape.style.cssText = 'left:' + ws.left + '%;width:' + (ws.width * .7) + 'px;background-color:' + ws.color + ';transform:rotate(' + ws.angle + 'deg)';
  frame.appendChild(tape);

  return frame;
}

function makeDzEl() {
  const dz = document.createElement('div');
  dz.className = 'dropzone';
  dz.style.marginBottom = '14px';
  dz.ondragover = e => { e.preventDefault(); dz.classList.add('dv'); };
  dz.ondragleave = () => dz.classList.remove('dv');
  dz.ondrop = e => onDrop(e, 'main');
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'image/*';
  inp.onchange = e => onFile(e, 'main');
  dz.appendChild(inp);
  const ico = document.createElement('div'); ico.className = 'dz-ico'; ico.textContent = 'üñº';
  const txt = document.createElement('div'); txt.className = 'dz-txt';
  txt.innerHTML = '<strong>Drop a photo here</strong><br><span style="font-family:\'Special Elite\',monospace;font-size:10px">or use the panel ‚Üí</span>';
  dz.appendChild(ico); dz.appendChild(txt);
  return dz;
}

function mkTA(cls, ph, val, field, rows) {
  const ta = document.createElement('textarea');
  ta.className = cls; ta.placeholder = ph; ta.value = val || ''; ta.rows = rows;
  ta.oninput = function() { autoR(this); saveF(field, this.value); };
  return ta;
}

function makeQuoteBlock(p) {
  if (S.scrapMode) {
    const rng = mkRng(strHash(p.id + 'sc'));
    const tapeColors = ['rgba(196,168,140,.65)','rgba(155,178,140,.62)','rgba(182,140,168,.58)','rgba(100,128,180,.52)','rgba(200,140,100,.62)'];
    const tc = tapeColors[Math.floor(rng() * tapeColors.length)];
    const scR = [-1.3, -.6, 0, .6, 1.3][Math.floor(rng() * 5)];
    const tR  = [-2, -1, 0, 1, 2][Math.floor(rng() * 5)];

    const wrap = document.createElement('div'); wrap.className = 'scrap-wrap';
    wrap.style.transform = 'rotate(' + scR + 'deg)';
    const tape = document.createElement('div'); tape.className = 'scrap-tape-el';
    tape.style.cssText = 'left:calc(50% - 26px);width:52px;background-color:' + tc + ';transform:rotate(' + tR + 'deg)';
    const paper = document.createElement('div'); paper.className = 'scrap-paper';

    const qEl = document.createElement('div');
    qEl.contentEditable = 'true';
    qEl.style.cssText = 'font-family:Caveat,cursive;font-size:19px;font-weight:600;color:var(--ink);min-height:28px;outline:none';
    qEl.textContent = p.quote || '';
    qEl.onblur = () => saveF('quote', qEl.textContent);

    const footer = document.createElement('div'); footer.className = 'quote-footer';
    footer.appendChild(mkInp('f-qdate', 'date‚Ä¶', p.date, 'date'));
    footer.appendChild(mkInp('f-qloc', 'somewhere‚Ä¶', p.location, 'location'));

    paper.appendChild(qEl); paper.appendChild(footer);
    wrap.appendChild(tape); wrap.appendChild(paper);
    return wrap;
  } else {
    const wrap = document.createElement('div'); wrap.className = 'quote-inline';
    wrap.appendChild(mkTA('f-quote', 'a quote or memory‚Ä¶', p.quote, 'quote', 2));
    const footer = document.createElement('div'); footer.className = 'quote-footer';
    footer.appendChild(mkInp('f-qdate', 'Sept. 2024', p.date, 'date'));
    footer.appendChild(mkInp('f-qloc', 'somewhere warm‚Ä¶', p.location, 'location'));
    wrap.appendChild(footer);
    return wrap;
  }
}

function mkInp(cls, ph, val, field) {
  const inp = document.createElement('input');
  inp.type = 'text'; inp.className = cls; inp.placeholder = ph; inp.value = val || '';
  inp.oninput = () => saveF(field, inp.value);
  return inp;
}

function makeDecorEl(d) {
  const rng = mkRng(strHash(d.id));
  const page = document.getElementById('jpage');

  const wrap = document.createElement('div');
  wrap.dataset.did = d.id;
  wrap.style.cssText =
    'position:absolute;left:' + d.x + '%;top:' + d.y + '%;' +
    'transform:rotate(' + (d.rot || 0) + 'deg);' +
    'z-index:20;cursor:grab;user-select:none;touch-action:none;' +
    'transition:box-shadow .12s';

  const del = document.createElement('button');
  del.textContent = '‚úï';
  del.title = 'Remove';
  del.style.cssText =
    'position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;' +
    'background:var(--ac);color:#f5e0c0;border:none;font-size:9px;cursor:pointer;' +
    'display:none;align-items:center;justify-content:center;z-index:30;line-height:1;padding:0';
  del.onclick = (e) => { e.stopPropagation(); rmDecor(d.id); };
  wrap.appendChild(del);
  wrap.addEventListener('mouseenter', () => del.style.display = 'flex');
  wrap.addEventListener('mouseleave', () => del.style.display = 'none');

  const inner = document.createElement('div');
  const tapeColors = { 'tape-floral': 'rgba(182,140,168,.7)', 'tape-stripe': 'rgba(155,178,140,.7)', 'tape-kraft': 'rgba(196,168,140,.72)' };

  if (tapeColors[d.type]) {
    inner.style.cssText =
      'width:90px;height:24px;background-color:' + tapeColors[d.type] + ';' +
      'background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.28) 4px,rgba(255,255,255,.28) 5px);' +
      'box-shadow:0 2px 6px rgba(0,0,0,.15)';
  } else if (d.type === 'postmark') {
    inner.style.cssText =
      'width:52px;height:52px;border-radius:50%;border:2.5px solid rgba(100,28,28,.55);' +
      'outline:1.2px solid rgba(100,28,28,.35);outline-offset:-6px;' +
      'display:flex;align-items:center;justify-content:center;' +
      'font-family:\'Special Elite\',monospace;font-size:6.5px;color:rgba(100,28,28,.7);text-align:center;line-height:1.4;' +
      'background:rgba(253,245,228,.6)';
    inner.innerHTML = 'PAPERLY<br>' + ['üåø','‚öì','‚úà','üìú','üî≠'][Math.floor(rng() * 5)] + '<br>' + new Date().getFullYear();
  } else if (d.type === 'botanical') {
    inner.style.cssText = 'font-size:34px;line-height:1;filter:sepia(.25)';
    inner.textContent = BOTANICALS[Math.floor(rng() * BOTANICALS.length)];
  } else if (d.type === 'stamp') {
    inner.style.cssText =
      'font-family:\'Special Elite\',monospace;font-size:11px;color:rgba(139,26,26,.68);' +
      'border:2.5px solid rgba(139,26,26,.52);padding:3px 10px;letter-spacing:.13em;' +
      'background:rgba(253,245,228,.55)';
    inner.textContent = STAMPS[Math.floor(rng() * STAMPS.length)];
  } else if (d.type === 'divider') {
    inner.style.cssText =
      'font-family:\'Special Elite\',monospace;font-size:10px;color:var(--muted);' +
      'letter-spacing:.35em;white-space:nowrap;padding:2px 4px';
    inner.textContent = '‚Äî ‚ú¶ ‚ú¶ ‚ú¶ ‚Äî';
  } else if (d.type === 'text') {
    inner.contentEditable = 'true';
    inner.style.cssText =
      'font-family:Caveat,cursive;font-size:17px;color:var(--ink2);' +
      'font-style:italic;min-width:80px;min-height:24px;outline:none;' +
      'border-bottom:1px dashed rgba(160,128,80,.35);padding:1px 2px';
    inner.textContent = d.content || 'write here‚Ä¶';
    inner.onblur = () => { d.content = inner.textContent; save(); };
    inner.onmousedown = (e) => e.stopPropagation();
  }

  wrap.appendChild(inner);

  let dragging = false, startX, startY, startLeft, startTop;

  function dragStart(cx, cy) {
    dragging = true;
    wrap.style.cursor = 'grabbing';
    wrap.style.zIndex = '50';
    startX = cx; startY = cy;
    const rect = page.getBoundingClientRect();
    startLeft = d.x / 100 * rect.width;
    startTop  = d.y / 100 * rect.height;
  }

  function dragMove(cx, cy) {
    if (!dragging) return;
    const rect = page.getBoundingClientRect();
    const newLeft = Math.max(0, Math.min(rect.width  - 10, startLeft + cx - startX));
    const newTop  = Math.max(0, Math.min(rect.height - 10, startTop  + cy - startY));
    d.x = (newLeft / rect.width)  * 100;
    d.y = (newTop  / rect.height) * 100;
    wrap.style.left = d.x + '%';
    wrap.style.top  = d.y + '%';
  }

  function dragEnd() {
    if (!dragging) return;
    dragging = false;
    wrap.style.cursor = 'grab';
    wrap.style.zIndex = '20';
    save();
  }

  wrap.addEventListener('mousedown', (e) => {
    if (e.target === del) return;
    e.preventDefault();
    dragStart(e.clientX, e.clientY);
    const mm = (e) => dragMove(e.clientX, e.clientY);
    const mu = ()  => { dragEnd(); window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm);
    window.addEventListener('mouseup', mu);
  });

  wrap.addEventListener('touchstart', (e) => {
    if (e.target === del) return;
    const t = e.touches[0];
    dragStart(t.clientX, t.clientY);
  }, { passive: true });
  wrap.addEventListener('touchmove', (e) => {
    const t = e.touches[0];
    dragMove(t.clientX, t.clientY);
    e.preventDefault();
  }, { passive: false });
  wrap.addEventListener('touchend', dragEnd);

  return wrap;
}

function rmDecor(did) {
  if (S.isDemo) return;
  const p = getP(); if (!p) return;
  p.decorations = (p.decorations || []).filter(d => d.id !== did);
  save(); renderPage(); toast('Ephemera removed');
}

function renderDecorations(p) {
  const page = document.getElementById('jpage');
  page.querySelectorAll('.decor-sticker').forEach(el => el.remove());
  (p.decorations || []).forEach(d => {
    const el = makeDecorEl(d);
    el.classList.add('decor-sticker');
    page.appendChild(el);
  });
}

function renderLayers() {
  const p = getP(); const list = document.getElementById('layer-list');
  if (!p || !(p.layers || []).length) { list.innerHTML = '<div style="font-family:Caveat,cursive;font-size:12px;color:var(--muted)">No layers yet</div>'; return; }
  list.innerHTML = '';
  (p.layers || []).forEach((l, i) => {
    const item = document.createElement('div'); item.className = 'layer-item';
    const th = document.createElement('img'); th.className = 'lthumb'; th.src = l.raw || '';
    const info = document.createElement('div'); info.className = 'linfo';
    const nm = document.createElement('div'); nm.className = 'lname'; nm.textContent = 'Layer ' + (i + 2);
    const hn = document.createElement('div'); hn.style.cssText = 'font-family:\'Crimson Pro\',serif;font-style:italic;font-size:10px;color:var(--muted)'; hn.textContent = 'collage image';
    const del = document.createElement('button'); del.className = 'ldel'; del.textContent = '‚úï';
    del.onclick = () => rmLayer(l.id);
    info.appendChild(nm); info.appendChild(hn);
    item.appendChild(th); item.appendChild(info); item.appendChild(del);
    list.appendChild(item);
  });
}
function rmLayer(lid) {
  if (S.isDemo) return;
  const p = getP(); if (!p) return;
  p.layers = (p.layers || []).filter(l => l.id !== lid);
  save(); renderPage(); toast('Layer removed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onDrop(e, type) {
  e.preventDefault();
  document.querySelectorAll('.dropzone').forEach(z => z.classList.remove('dv'));
  if (S.isDemo) { toast('Switch to your own journal to add photos'); return; }
  const f = e.dataTransfer && e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) type === 'layer' ? addLayer(f) : addMainPhoto(f);
}

function onFile(e, type) {
  if (S.isDemo) { toast('Switch to your own journal to add photos'); e.target.value = ''; return; }
  const f = e.target && e.target.files[0];
  if (f) type === 'layer' ? addLayer(f) : addMainPhoto(f);
  e.target.value = '';
}

function addMainPhoto(file) {
  const p = getP();
  if (!p) { toast('Open a journal first'); return; }

  const reader = new FileReader();
  reader.onload = function(e) {
    const raw = e.target.result;
    p.rawImage = raw;
    p.preset = S.preset;
    save();
    renderSidebar();
    renderPage();
    toast('Photo added ‚úì');
    runAI();
  };
  reader.onerror = function() { toast('Could not read file ‚Äî try another image'); };
  reader.readAsDataURL(file);
}

function addLayer(file) {
  const p = getP();
  if (!p) return;
  if (!p.layers) p.layers = [];
  if (p.layers.length >= 4) { toast('Max 4 layers per page'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    p.layers.push({ id: gid(), raw: e.target.result });
    save(); renderPage(); toast('Layer added ‚úì');
  };
  reader.readAsDataURL(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPreset(preset, btn) {
  S.preset = preset;
  if (!S.isDemo) {
    const p = getP();
    if (p) { p.preset = preset; save(); }
  }
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === preset));
  document.querySelectorAll('.photo-clip img').forEach(img => {
    img.style.filter = PRESET_CSS[preset] || PRESET_CSS.vintage;
  });
  toast('Style: ' + PRESET_NAMES[preset]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DECORATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addDecor(type) {
  if (S.isDemo) { toast('Switch to your own journal to add ephemera'); return; }
  const p = getP(); if (!p) return;
  if (!p.decorations) p.decorations = [];
  const rng2 = mkRng(strHash(type + Date.now()));
  const x = 10 + rng2() * 55;
  const y = 5  + rng2() * 35;
  const rot = (rng2() - .5) * 16;
  p.decorations.push({ id: gid(), type, x, y, rot, content: '' });
  save(); renderPage(); toast('Drag to position ‚ú¶');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX (BUG 4): AI switched from Gemini/Puter to Claude via Anthropic API
// Uses the claude-sonnet-4-20250514 model with vision support.
// Image is downsampled and sent as base64 in the messages array.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetAiPanel() {
  const panel = document.getElementById('ai-panel');
  if (!panel) return;
  if (S.isDemo) {
    panel.innerHTML = '<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Upload a photo in your own journal ‚Äî Claude will write your page</div>';
    return;
  }
  const p = getP();
  if (p && p.rawImage && !p.title) {
    panel.innerHTML = '<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Generating page content‚Ä¶</div>';
  } else if (p && p.title) {
    panel.innerHTML =
      '<div style="font-family:\'Caveat\',cursive;font-size:12px;color:var(--muted);margin-bottom:7px">Content applied ‚úì</div>'
      + '<button class="regen-btn" style="width:100%" onclick="runAI()">‚Ü∫ REGENERATE</button>';
  } else {
    panel.innerHTML = '<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Upload a photo ‚Äî Claude automatically writes your page</div>';
  }
}

// Downsize image to 512px max for Claude vision
function downsizeForAI(dataUrl) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const MAX = 512;
      const scale = Math.min(1, MAX / Math.max(img.naturalWidth, img.naturalHeight));
      const w = Math.round(img.naturalWidth * scale);
      const h = Math.round(img.naturalHeight * scale);
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL('image/jpeg', 0.8));
    };
    img.onerror = () => resolve(dataUrl);
    img.src = dataUrl;
  });
}

async function runAI() {
  if (S.isDemo) return;
  const p = getP();
  if (!p || !p.rawImage) return;

  document.getElementById('ai-panel').innerHTML =
    '<div class="ai-loader"><span class="quill">‚ú®</span><span>Claude is writing<br>your page‚Ä¶</span></div>';

  try {
    // Downsize image and extract base64 data
    const smallDataUrl = await downsizeForAI(p.rawImage);
    // Strip the data URL prefix to get raw base64
    const base64Data = smallDataUrl.split(',')[1];

    const prompt =
      'You are a junk journal co-pilot. Voice style: ' + PRESET_VOICE[S.preset] +
      '\n\nLook at this photo and write 3 journal page suggestions. Be evocative and personal, as if the viewer lived this moment.' +
      '\nKeep it brief: titles 4-6 words, desc 1-2 sentences, quote under 12 words, date poetic (e.g. "a late november thursday"), location intimate.' +
      '\nRespond with ONLY valid JSON, no markdown, no explanation:\n' +
      '{"suggestions":[{"title":"","desc":"","quote":"","date":"","location":""},{"title":"","desc":"","quote":"","date":"","location":""},{"title":"","desc":"","quote":"","date":"","location":""}]}';

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': '', // FIX: API key intentionally left blank ‚Äî this app requires the user to configure their own key or use a proxy. See note below.
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-calls': 'true',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: {
                type: 'base64',
                media_type: 'image/jpeg',
                data: base64Data,
              },
            },
            { type: 'text', text: prompt },
          ],
        }],
      }),
    });

    if (!response.ok) {
      const errBody = await response.json().catch(() => ({}));
      const msg = errBody?.error?.message || `HTTP ${response.status}`;
      // FIX: Provide a helpful error for missing API key
      if (response.status === 401) throw new Error('API key required. Add your Anthropic API key to the x-api-key header in the runAI() function.');
      throw new Error(msg);
    }

    const data = await response.json();
    let raw = (data.content || []).map(b => b.text || '').join('');

    // Strip markdown fences if present
    raw = raw.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();

    const i0 = raw.indexOf('{'), i1 = raw.lastIndexOf('}');
    if (i0 < 0 || i1 < 0) throw new Error('Claude returned an unexpected format. Please try again.');
    const parsed = JSON.parse(raw.slice(i0, i1 + 1));
    const sugs = parsed.suggestions;
    if (!Array.isArray(sugs) || !sugs.length) throw new Error('No suggestions returned. Please try again.');

    applyS(sugs[0]);
    renderSugCards(sugs);

  } catch(err) {
    console.error('Claude AI error:', err);
    let msg = err.message || 'Unknown error';
    if (msg.includes('fetch') || msg.includes('network') || msg.includes('Failed to fetch')) {
      msg = 'Network error ‚Äî check your connection and try again.';
    } else if (msg.includes('quota') || msg.includes('rate')) {
      msg = 'Rate limit reached ‚Äî wait a moment and try again.';
    } else if (msg.length > 200) {
      msg = msg.slice(0, 197) + '‚Ä¶';
    }
    document.getElementById('ai-panel').innerHTML =
      '<div style="font-family:\'Special Elite\',monospace;font-size:10px;color:var(--red);line-height:1.8;padding:6px 0">'
      + '‚ö† ' + esc(msg) + '</div>'
      + '<button class="regen-btn" onclick="runAI()">‚Ü∫ RETRY</button>';
  }
}

function applyS(s) {
  if (S.isDemo) return;
  const p = getP(); if (!p || !s) return;
  p.title = s.title || ''; p.desc = s.desc || '';
  p.quote = s.quote || ''; p.date = s.date || ''; p.location = s.location || '';
  save(); renderPage();
}

function renderSugCards(sugs) {
  const panel = document.getElementById('ai-panel');
  panel.innerHTML = '';
  sugs.forEach((s, i) => {
    const card = document.createElement('div');
    card.className = 'sug-card' + (i === 0 ? ' sel' : '');
    const t = document.createElement('div'); t.className = 'sug-title'; t.textContent = s.title || '';
    const d = document.createElement('div'); d.className = 'sug-desc';  d.textContent = s.desc  || '';
    const q = document.createElement('div'); q.className = 'sug-q';    q.textContent = '"' + (s.quote || '') + '"';
    const m = document.createElement('div'); m.className = 'sug-meta'; m.textContent = (s.date || '') + (s.location ? ' ¬∑ ' + s.location : '');
    card.appendChild(t); card.appendChild(d); card.appendChild(q); card.appendChild(m);
    card.onclick = () => {
      document.querySelectorAll('.sug-card').forEach((c, ci) => c.classList.toggle('sel', ci === i));
      applyS(s); toast('Suggestion applied ‚úì');
    };
    panel.appendChild(card);
  });
  const rb = document.createElement('button'); rb.className = 'regen-btn'; rb.textContent = '‚Ü∫ REGENERATE'; rb.onclick = runAI;
  panel.appendChild(rb);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCRAP MODE
// FIX (BUG 5): Guard against saving in demo mode
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleScrap(on) {
  S.scrapMode = on;
  if (!S.isDemo) {
    const p = getP();
    if (p) {
      p.scrapMode = on;
      save();
      renderPage();
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoR(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
function saveF(f, v) {
  if (S.isDemo) return; // FIX (BUG 5): no-op in demo mode
  const p = getP(); if (p) { p[f] = v; save(); }
}
function esc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.overlay.open').forEach(m => m.classList.remove('open'));
    closeShare();
  }
});
document.querySelectorAll('.overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX (BUG 6): SHARE ‚Äî await document.fonts.ready before canvas render
// Also guard properly for demo mode pages (no rawImage, use placeholder)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openShare() {
  const p = getP();
  if (!p) { toast('Nothing to share yet'); return; }

  document.getElementById('share-img').src = '';
  document.getElementById('share-url').value = 'Generating‚Ä¶';
  document.getElementById('share-overlay').classList.add('open');

  const fontReady = (document.fonts && document.fonts.ready)
    ? document.fonts.ready
    : Promise.resolve();

  // Build a shareable page data object ‚Äî works for both demo and real pages
  const shareData = {
    t:  p.title    || '',
    d:  p.desc     || '',
    q:  p.quote    || '',
    dt: p.date     || '',
    l:  p.location || '',
    pr: p.preset   || 'vintage',
  };

  fontReady
    .then(() => renderPageToCanvas(p))
    .then(dataUrl => {
      document.getElementById('share-img').src = dataUrl;
      document.getElementById('share-img').style.display = 'block';
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(shareData))));
      const url = location.href.split('?')[0] + '?page=' + encoded;
      document.getElementById('share-url').value = url;
    })
    .catch(err => {
      console.warn('Share render error:', err);
      document.getElementById('share-url').value = 'Preview failed ‚Äî try again';
      toast('Preview failed ‚Äî please try again');
    });
}

function closeShare() {
  document.getElementById('share-overlay').classList.remove('open');
}

function copyShareUrl() {
  const url = document.getElementById('share-url').value;
  if (!url || url === 'Generating‚Ä¶') return;
  navigator.clipboard.writeText(url).then(() => toast('Link copied ‚úì')).catch(() => {
    document.getElementById('share-url').select();
    document.execCommand('copy');
    toast('Link copied ‚úì');
  });
}

function downloadPage() {
  const img = document.getElementById('share-img');
  if (!img.src || img.src === location.href) { toast('Preview not ready'); return; }
  const a = document.createElement('a');
  a.href = img.src;
  a.download = 'paperly-page.png';
  a.click();
  toast('Saved ‚úì');
}

function renderPageToCanvas(p) {
  return new Promise(resolve => {
    const W = 560, H = 780;
    const canvas = document.createElement('canvas');
    canvas.width = W * 2; canvas.height = H * 2;
    const ctx = canvas.getContext('2d');
    ctx.scale(2, 2);

    ctx.fillStyle = '#f6ecd6';
    ctx.fillRect(0, 0, W, H);

    ctx.strokeStyle = 'rgba(150,110,70,.18)';
    ctx.lineWidth = 1;
    for (let y = 28; y < H; y += 28) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }
    ctx.strokeStyle = 'rgba(150,45,45,.2)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(50, 0); ctx.lineTo(50, H); ctx.stroke();

    const draw = () => {
      const pad = { top: 30, left: 58, right: 30 };
      let y = pad.top;
      const maxW = W - pad.left - pad.right;

      const drawText = (text, font, color, size, maxWidth, lineH) => {
        ctx.font = font;
        ctx.fillStyle = color;
        const words = String(text || '').split(' ');
        let line = '';
        for (const word of words) {
          const test = line + (line ? ' ' : '') + word;
          if (ctx.measureText(test).width > maxWidth && line) {
            ctx.fillText(line, pad.left, y);
            y += lineH; line = word;
          } else { line = test; }
        }
        if (line) { ctx.fillText(line, pad.left, y); y += lineH; }
        y += 4;
      };

      // FIX (BUG 6): handle demo pages which have .photo instead of .rawImage
      const imgSrc = p.rawImage || p.photo || null;

      if (imgSrc) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const rng = mkRng(strHash(p.id + 'tilt'));
          const tilts = [-2.5,-1.6,-.8,0,.8,1.6,2.5];
          const tilt = tilts[Math.floor(rng()*tilts.length)] * Math.PI / 180;
          const iW = Math.min(maxW, 380);
          const iH = Math.round(iW * img.naturalHeight / img.naturalWidth);
          ctx.save();
          ctx.translate(pad.left + iW/2, y + iH/2);
          ctx.rotate(tilt);
          ctx.shadowColor = 'rgba(42,31,14,.3)'; ctx.shadowBlur = 12;
          ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 5;
          ctx.drawImage(img, -iW/2, -iH/2, iW, iH);
          ctx.shadowColor = 'transparent';
          ctx.restore();
          y += iH + 24;
          drawTextContent();
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = () => { drawTextContent(); resolve(canvas.toDataURL('image/png')); };
        img.src = imgSrc;
      } else {
        drawTextContent();
        resolve(canvas.toDataURL('image/png'));
      }

      function drawTextContent() {
        if (!p.title && !p.desc && !p.quote) return;
        ctx.strokeStyle = 'rgba(180,150,100,.35)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(pad.left, y+8); ctx.lineTo(W-pad.right, y+8); ctx.stroke();
        y += 22;
        if (p.title) drawText(p.title, 'bold 24px Caveat,cursive', '#2a1f0e', 24, maxW, 30);
        if (p.desc)  drawText(p.desc,  '12px "Special Elite",monospace', '#6b5040', 12, maxW, 20);
        if (p.quote) {
          y += 8;
          ctx.strokeStyle = 'rgba(85,92,60,.5)'; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.moveTo(pad.left-10,y); ctx.lineTo(pad.left-10,y+50); ctx.stroke();
          drawText('"' + p.quote + '"', 'italic 18px Caveat,cursive', '#2a1f0e', 18, maxW, 26);
        }
        if (p.date || p.location) {
          ctx.font = '10px "Special Elite",monospace';
          ctx.fillStyle = '#a08060';
          ctx.fillText([p.date, p.location].filter(Boolean).join(' ¬∑ '), pad.left, y + 8);
        }
      }
    };
    draw();
  });
}

document.getElementById('share-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('share-overlay')) closeShare();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO JOURNAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEMO_PAGES = [
  {
    id: '__demo_p1__', preset: 'moody',
    title: 'The city that never quite sleeps',
    desc: 'Somewhere between the neon and the rain, the streets felt like a film I had already seen ‚Äî but couldn\'t remember the ending of. Every window a world, every shadow a sentence left unfinished.',
    quote: 'pressed against the glass, the world moved and I stayed still.',
    date: 'a thursday in late november', location: 'shinjuku, 2am',
    photo: 'https://picsum.photos/id/1060/600/400',
    tape: 'rgba(100,120,180,.52)', tapeAngle: '-1.8deg', tapeLeft: '26%',
    decorations: [], layers: [],
  },
  {
    id: '__demo_p2__', preset: 'botanical',
    title: 'Light through the canopy',
    desc: 'The forest held its breath. Somewhere above, light was breaking through in long gold columns, catching the dust of a thousand ordinary mornings made extraordinary by simply being outside.',
    quote: 'I counted seven different greens before I stopped counting.',
    date: 'a sunday in early september', location: 'the woods behind the house',
    photo: 'https://picsum.photos/id/15/600/400',
    tape: 'rgba(140,175,100,.52)', tapeAngle: '1.4deg', tapeLeft: '16%',
    decorations: [], layers: [],
  },
  {
    id: '__demo_p3__', preset: 'darkacademia',
    title: 'Marginal notes on a rainy afternoon',
    desc: 'The coffee cooled while I read. Outside, the rain made the windows into watercolours. There is something about old books and grey skies that makes the world feel both smaller and endlessly vast.',
    quote: 'the best sentences are the ones someone else underlined first.',
    date: 'an october afternoon', location: 'the corner table, usual caf√©',
    photo: 'https://picsum.photos/id/766/600/400',
    tape: 'rgba(180,145,85,.52)', tapeAngle: '-2.2deg', tapeLeft: '34%',
    decorations: [], layers: [],
  },
  {
    id: '__demo_p4__', preset: 'vintage',
    title: 'Letters we never finished writing',
    desc: 'Found them in a shoebox ‚Äî postcards, half-written letters, photographs with names on the back I don\'t recognise. Someone kept these. Someone thought they mattered. They were right.',
    quote: 'the handwriting changes partway through. something happened.',
    date: 'found on a tuesday in march', location: 'grandmother\'s attic',
    photo: 'https://picsum.photos/id/357/600/400',
    tape: 'rgba(196,168,140,.55)', tapeAngle: '2.4deg', tapeLeft: '20%',
    decorations: [], layers: [],
  },
];

const DEMO_JOURNAL = {
  id: '__demo__',
  name: 'A Year in Fragments ‚Äî Demo',
  color: '#2a3a4a',
  createdAt: Date.now(),
  isDemo: true,
  pages: DEMO_PAGES,
};

const DEMO_FILTERS = {
  moody:        'sepia(.5) brightness(.72) contrast(1.22) saturate(.55) hue-rotate(-8deg)',
  botanical:    'sepia(.18) brightness(1.06) contrast(1.08) saturate(.85) hue-rotate(12deg)',
  darkacademia: 'sepia(.62) brightness(.78) contrast(1.18) saturate(.42)',
  vintage:      'sepia(.75) brightness(.88) contrast(1.06) saturate(.68)',
  summer:       'sepia(.22) brightness(1.12) contrast(.95) saturate(1.1) hue-rotate(8deg)',
};

function makeDemoScene(page) {
  const rng  = mkRng(strHash(page.id + 'demo'));
  const tilt = [-2.5,-1.6,-.8,0,.8,1.6,2.5][Math.floor(rng()*7)];

  const frame = document.createElement('div');
  frame.style.cssText = `transform:rotate(${tilt}deg);position:relative;margin-bottom:18px;isolation:isolate`;

  const clip = document.createElement('div');
  clip.style.cssText = `clip-path:${makeTornClipPath(page.id)};filter:drop-shadow(4px 6px 10px rgba(42,31,14,.38));overflow:hidden`;

  const img = document.createElement('img');
  img.src = page.photo;
  img.alt = page.title;
  img.crossOrigin = 'anonymous';
  img.style.cssText = `display:block;width:100%;height:220px;object-fit:cover;object-position:center;filter:${DEMO_FILTERS[page.preset] || DEMO_FILTERS.vintage}`;
  img.style.background = 'linear-gradient(160deg,#2a1e0e,#3a2c18)';
  img.onerror = () => {
    img.style.display = 'none';
    const fb = document.createElement('div');
    fb.style.cssText = `width:100%;height:220px;background:linear-gradient(160deg,#1a1410,#2a2018,#1e1a10);display:flex;align-items:center;justify-content:center`;
    fb.innerHTML = `<span style="font-family:'Special Elite',monospace;font-size:10px;color:rgba(200,170,120,.5);letter-spacing:.15em">PHOTO UNAVAILABLE</span>`;
    clip.appendChild(fb);
  };

  clip.appendChild(img);
  frame.appendChild(clip);

  const tape = document.createElement('div');
  tape.style.cssText = `position:absolute;top:-10px;left:${page.tapeLeft};width:74px;height:22px;z-index:5;background-color:${page.tape};transform:rotate(${page.tapeAngle});background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.22) 4px,rgba(255,255,255,.22) 5px)`;
  frame.appendChild(tape);

  return frame;
}

// FIX (BUG 7): showDemo sets S.isDemo = true so all getJ/getP calls return demo data
function showDemo() {
  S.isDemo = true;
  S.jid = '__demo__';
  S.pidx = 0;
  document.getElementById('view-lib').classList.remove('active');
  document.getElementById('view-ed').classList.add('active');
  document.getElementById('ed-jname').textContent = DEMO_JOURNAL.name + ' ‚ú¶ DEMO';
  renderDemoSidebar();
  renderDemoPage(0);
  resetAiPanel();
}

function renderDemoSidebar() {
  const list = document.getElementById('pglist');
  list.innerHTML = '';
  DEMO_PAGES.forEach((p, i) => {
    const t = document.createElement('div');
    t.className = 'pgthumb' + (i === S.pidx ? ' active' : '');
    t.title = p.title;
    t.style.cssText = 'overflow:hidden;position:relative';
    t.innerHTML = `<img src="${p.photo}" alt="" crossorigin="anonymous" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:${DEMO_FILTERS[p.preset]}">`
      + `<span class="pgnum">${i+1}</span>`;
    t.onclick = () => selectPage(i);
    list.appendChild(t);
  });
}

function renderDemoPage(idx) {
  const p = DEMO_PAGES[idx];
  const content = document.getElementById('pcontent');
  content.innerHTML = '';
  // FIX: also clear any sticker overlays from previous pages
  document.getElementById('jpage').querySelectorAll('.decor-sticker').forEach(el => el.remove());

  S.preset = p.preset;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === p.preset));

  content.appendChild(makeDemoScene(p));

  const sep = document.createElement('div'); sep.className = 'divider-orn'; sep.textContent = '‚ú¶ ‚ú¶ ‚ú¶';
  content.appendChild(sep);

  const titleEl = document.createElement('div');
  titleEl.style.cssText = 'font-family:Caveat,cursive;font-size:28px;font-weight:700;color:var(--ink);line-height:1.2;margin-bottom:7px';
  titleEl.textContent = p.title;
  content.appendChild(titleEl);

  const descEl = document.createElement('div');
  descEl.style.cssText = 'font-family:"Special Elite",monospace;font-size:11.5px;color:var(--ink2);line-height:1.9;letter-spacing:.015em;margin-bottom:12px';
  descEl.textContent = p.desc;
  content.appendChild(descEl);

  const qi = document.createElement('div'); qi.className = 'quote-inline';
  const qtext = document.createElement('div');
  qtext.style.cssText = 'font-family:Caveat,cursive;font-size:20px;color:var(--ink);margin-bottom:6px;font-style:italic;line-height:1.3';
  qtext.textContent = '\u201c' + p.quote + '\u201d';
  const qfooter = document.createElement('div');
  qfooter.style.cssText = 'display:flex;flex-direction:column;gap:3px';
  const qdate = document.createElement('div');
  qdate.style.cssText = 'font-family:"Special Elite",monospace;font-size:9px;color:var(--muted);letter-spacing:.08em';
  qdate.textContent = p.date;
  const qloc = document.createElement('div');
  qloc.style.cssText = 'font-family:Caveat,cursive;font-size:13px;color:var(--muted);font-style:italic';
  qloc.textContent = p.location;
  qfooter.appendChild(qdate); qfooter.appendChild(qloc);
  qi.appendChild(qtext); qi.appendChild(qfooter);
  content.appendChild(qi);

  const nav = document.createElement('div');
  nav.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-top:24px;padding-top:14px;border-top:1px solid var(--border)';
  nav.innerHTML =
    `<button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="if(S.pidx>0){S.pidx--;renderDemoSidebar();renderDemoPage(S.pidx)}" ${idx===0?'disabled style="opacity:.3"':''}>‚Üê PREV</button>`
    + `<span style="font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);letter-spacing:.1em">PAGE ${idx+1} OF ${DEMO_PAGES.length}</span>`
    + `<button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="if(S.pidx<${DEMO_PAGES.length-1}){S.pidx++;renderDemoSidebar();renderDemoPage(S.pidx)}" ${idx===DEMO_PAGES.length-1?'disabled style="opacity:.3"':''}>NEXT ‚Üí</button>`;
  content.appendChild(nav);

  if (idx === DEMO_PAGES.length - 1) {
    const cta = document.createElement('div');
    cta.style.cssText = 'margin-top:20px;padding:16px;background:rgba(122,64,32,.08);border:1.5px solid rgba(122,64,32,.18);text-align:center';
    cta.innerHTML = '<div style="font-family:\'Special Elite\',monospace;font-size:10px;color:var(--ac);letter-spacing:.12em;margin-bottom:6px">‚ú¶ YOUR JOURNAL AWAITS ‚ú¶</div>'
      + '<div style="font-family:\'Crimson Pro\',serif;font-style:italic;font-size:13px;color:var(--ink2);margin-bottom:12px;line-height:1.6">Upload any photo and Claude writes your title, caption, and memory quote in seconds.</div>'
      + '<button class="btn btn-p" style="margin:0 auto" onclick="showLib();setTimeout(()=>currentUser?showNewModal():openModal(\'m-auth\'),100)">+ START MY JOURNAL</button>';
    content.appendChild(cta);
  }

  // Update layer list to show "demo" state
  document.getElementById('layer-list').innerHTML = '<div style="font-family:Caveat,cursive;font-size:12px;color:var(--muted)">Demo mode ‚Äî no layers</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE PAGES DRAWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePgDrawer() {
  const sb = document.getElementById('pg-sb');
  sb.classList.toggle('open');
  document.body.classList.toggle('pgopen', sb.classList.contains('open'));
}
function closePgDrawer() {
  document.getElementById('pg-sb').classList.remove('open');
  document.body.classList.remove('pgopen');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _tt;
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(() => t.classList.remove('show'), 2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initLoadingState() {
  load();
  renderLib();
  const grid = document.getElementById('jgrid');
  setTimeout(() => {
    if (grid && !S.journals.length && !currentUser) renderLib();
  }, 4000);
})();
</script>
</body>
</html>