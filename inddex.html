<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paperly â€” Junk Journal Co-Pilot</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Caveat:wght@400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#e2d8c2;--paper:#f7f0de;--paper2:#efe5cc;
  --ink:#2a1f0e;--ink2:#6b5040;--muted:#a08060;
  --border:#d0bc98;--bs:#b89a70;
  --ac:#7a4020;--al:#c07838;--ap:#f0e2cc;
  --red:#8b1a1a;--sage:#4a6040;
  --sh:0 4px 18px rgba(42,31,14,.22),0 1px 4px rgba(42,31,14,.12);
  --shhov:0 14px 36px rgba(42,31,14,.28);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Crimson Pro',Georgia,serif;background:var(--bg);min-height:100vh;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.05'/%3E%3C/svg%3E"),
  linear-gradient(150deg,#ece0c6,#ddd0ae);background-attachment:fixed}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:200;background:rgba(226,216,194,.95);backdrop-filter:blur(12px);
  border-bottom:2px solid var(--border);height:56px;padding:0 22px;
  display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
.logo-stamp{width:36px;height:36px;border:2px solid var(--ac);display:flex;align-items:center;justify-content:center;
  font-family:'Special Elite',monospace;font-size:16px;color:var(--ac);transform:rotate(-3deg);
  background:rgba(247,240,222,.9);box-shadow:2px 2px 0 rgba(122,64,32,.2)}
.logo-name{font-family:'Special Elite',monospace;font-size:18px;color:var(--ink);letter-spacing:.05em}
.logo-tag{font-family:'Crimson Pro',serif;font-style:italic;font-size:11px;color:var(--muted)}
.topbar-r{display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;font-family:'Special Elite',monospace;
  font-size:12px;letter-spacing:.05em;cursor:pointer;border:none;border-radius:1px;transition:all .15s}
.btn-p{background:var(--ac);color:#f5e8d0;border:1.5px solid rgba(122,64,32,.4);box-shadow:2px 2px 0 rgba(42,31,14,.16)}
.btn-p:hover{background:#5a2e10;transform:translate(-1px,-1px);box-shadow:3px 3px 0 rgba(42,31,14,.16)}
.btn-s{background:var(--paper);color:var(--ink);border:1.5px solid var(--bs);box-shadow:2px 2px 0 rgba(42,31,14,.07)}
.btn-s:hover{background:var(--paper2);transform:translate(-1px,-1px)}
.btn-g{background:transparent;color:var(--ink2);border:1.5px solid transparent;padding:5px 9px}
.btn-g:hover{background:var(--ap);border-color:var(--border)}
.view{display:none}.view.active{display:block}

/* LIBRARY */
.library{max-width:1060px;margin:0 auto;padding:44px 22px}
.lib-h{font-family:'Special Elite',monospace;font-size:28px;color:var(--ink);letter-spacing:.04em}
.lib-s{font-family:'Crimson Pro',serif;font-style:italic;font-size:14px;color:var(--muted);margin-top:2px}
.sep{display:flex;align-items:center;gap:10px;margin:20px 0 18px;
  font-family:'Special Elite',monospace;font-size:10px;color:var(--muted);letter-spacing:.2em}
.sep::before,.sep::after{content:'';flex:1;height:1px;background:linear-gradient(to right,transparent,var(--border),transparent)}
.jgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(178px,1fr));gap:24px}
.jcard{cursor:pointer;transition:all .2s;position:relative}
.jcard:hover{transform:translateY(-6px) rotate(.3deg)}
.jcard:hover .jcov{box-shadow:var(--shhov)}
.jcov{aspect-ratio:3/4;box-shadow:var(--sh),4px 4px 0 rgba(42,31,14,.06);
  position:relative;overflow:hidden;display:flex;align-items:flex-end;padding:14px;transition:box-shadow .2s}
.jcov-grain{position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='.07'/%3E%3C/svg%3E");pointer-events:none;z-index:2}
.jspine{position:absolute;left:0;top:0;bottom:0;width:8px;background:rgba(0,0,0,.22);z-index:3}
.jthumb{position:absolute;inset:0;object-fit:cover;opacity:.22;mix-blend-mode:multiply;z-index:1}
.jcov-txt{position:relative;z-index:4;color:rgba(255,245,218,.95)}
.jcov-name{font-family:'Special Elite',monospace;font-size:13px;line-height:1.2;text-shadow:0 1px 4px rgba(0,0,0,.45);letter-spacing:.03em}
.jcov-ct{font-family:'Crimson Pro',serif;font-style:italic;font-size:11px;opacity:.85;margin-top:2px}
.jmeta{padding:8px 1px 0}
.jmeta-name{font-family:'Special Elite',monospace;font-size:11px;color:var(--ink);letter-spacing:.03em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.jmeta-date{font-family:'Crimson Pro',serif;font-style:italic;font-size:10px;color:var(--muted);margin-top:1px}
.jacts{position:absolute;top:6px;right:6px;opacity:0;transition:opacity .12s;display:flex;gap:3px;z-index:10}
.jcard:hover .jacts{opacity:1}
.icobtn{width:24px;height:24px;border-radius:50%;background:rgba(247,240,222,.92);border:1px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .12s;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.icobtn:hover{background:white;transform:scale(1.1)}
.newcard{cursor:pointer;border:2px dashed var(--bs);aspect-ratio:3/4;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:6px;color:var(--muted);transition:all .18s;background:rgba(247,240,222,.3);border-radius:1px}
.newcard:hover{border-color:var(--al);color:var(--ac);background:var(--ap);transform:translateY(-4px)}
.newcard-lbl{font-family:'Caveat',cursive;font-size:15px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(42,31,14,.52);backdrop-filter:blur(5px);
  z-index:400;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--paper);border-radius:1px;box-shadow:0 24px 60px rgba(0,0,0,.28),4px 4px 0 rgba(42,31,14,.1);
  border:1px solid var(--bs);padding:28px;width:90%;max-width:400px;
  transform:scale(.96) translateY(8px);transition:transform .2s}
.overlay.open .modal{transform:scale(1) translateY(0)}
.modal-title{font-family:'Special Elite',monospace;font-size:18px;color:var(--ink);letter-spacing:.04em;margin-bottom:2px}
.modal-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:12px;color:var(--muted);margin-bottom:18px}
.flabel{display:block;font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);letter-spacing:.12em;margin-bottom:5px}
.finput{width:100%;padding:8px 10px;border:1.5px solid var(--bs);font-family:'Caveat',cursive;font-size:17px;
  color:var(--ink);background:rgba(255,252,244,.85);outline:none;border-radius:1px;transition:border-color .12s;margin-bottom:14px}
.finput:focus{border-color:var(--al)}
.color-row{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:4px}
.csw{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .12s;position:relative}
.csw.sel{border-color:var(--ink);transform:scale(1.18)}
.csw.sel::after{content:'âœ“';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.9);font-size:11px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
.modal-acts{display:flex;justify-content:flex-end;gap:8px;margin-top:20px;padding-top:14px;border-top:1px solid var(--border)}

/* EDITOR */
.editor{display:flex;flex-direction:column;height:calc(100vh - 56px)}
.ed-hdr{background:rgba(226,214,190,.97);border-bottom:2px solid var(--border);
  padding:0 16px;height:46px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.ed-back{font-family:'Special Elite',monospace;font-size:11px;color:var(--ink2);cursor:pointer;
  padding:4px 9px;background:none;border:1.5px solid transparent;border-radius:1px;transition:all .12s;letter-spacing:.04em}
.ed-back:hover{border-color:var(--border);background:var(--ap);color:var(--ac)}
.ed-jname{font-family:'Special Elite',monospace;font-size:13px;color:var(--ink);flex:1;letter-spacing:.04em}
.ed-body{display:flex;flex:1;overflow:hidden}

/* PAGES SIDEBAR */
.pg-sb{width:130px;background:rgba(220,210,188,.7);border-right:1px solid var(--border);
  overflow-y:auto;flex-shrink:0;padding:10px 8px;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 19px,rgba(180,150,100,.12) 19px,rgba(180,150,100,.12) 20px)}
.sb-lbl{font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);letter-spacing:.16em;margin-bottom:8px}
.pgthumb{aspect-ratio:3/4;background:var(--paper);border-radius:1px;border:2px solid var(--border);
  cursor:pointer;margin-bottom:6px;transition:all .12s;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;box-shadow:1px 2px 0 rgba(42,31,14,.06)}
.pgthumb.active{border-color:var(--ac);box-shadow:0 0 0 1px var(--ac)}
.pgthumb:hover:not(.active){border-color:var(--al)}
.pgthumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.pgnum{position:absolute;bottom:2px;right:3px;font-family:'Special Elite',monospace;font-size:7px;color:var(--muted)}
.addpg{width:100%;aspect-ratio:3/4;border:2px dashed var(--bs);background:none;border-radius:1px;
  cursor:pointer;font-family:'Caveat',cursive;font-size:11px;color:var(--muted);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:all .12s}
.addpg:hover{border-color:var(--al);color:var(--ac);background:var(--ap)}

/* CANVAS AREA â€” corkboard */
.canvas-area{flex:1;overflow:auto;display:flex;justify-content:center;padding:28px 18px;
  background:#c4ae8a;
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 28px,rgba(140,110,60,.1) 28px,rgba(140,110,60,.1) 29px),
    repeating-linear-gradient(90deg,transparent,transparent 28px,rgba(140,110,60,.05) 28px,rgba(140,110,60,.05) 29px)}

/* THE JOURNAL PAGE */
.journal-page{
  width:560px;min-height:780px;position:relative;flex-shrink:0;align-self:flex-start;
  background-color:#f6ecd6;
  background-image:
    radial-gradient(ellipse 70px 58px at 88% 10%,rgba(100,65,25,.08) 52%,transparent 74%),
    radial-gradient(ellipse 58px 50px at 86% 8.5%,transparent 48%,rgba(100,65,25,.04) 54%,transparent 66%),
    url("data:image/svg+xml,%3Csvg viewBox='0 0 300 300' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='p'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.72' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23p)' opacity='.07'/%3E%3C/svg%3E"),
    repeating-linear-gradient(0deg,transparent,transparent 27px,rgba(150,110,70,.18) 27px,rgba(150,110,70,.18) 28px);
  box-shadow:0 6px 24px rgba(42,31,14,.22),5px 8px 0 rgba(42,31,14,.08)}
/* Red margin line */
.journal-page::before{content:'';position:absolute;left:50px;top:0;bottom:0;width:1px;
  background:rgba(150,45,45,.2);z-index:1;pointer-events:none}
/* Hole punches */
.journal-page::after{content:'';position:absolute;left:12px;top:0;bottom:0;width:24px;
  background:
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 72px,
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 234px,
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 396px,
    radial-gradient(circle 5px at 50% 50%,rgba(200,180,145,.5) 0%,rgba(200,180,145,.5) 4px,transparent 5px) center 558px;
  background-repeat:no-repeat;z-index:1;pointer-events:none}

/* Page content â€” sits ABOVE all page decorations */
.page-content{position:relative;z-index:10;padding:30px 30px 50px 58px;min-height:780px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHOTO DISPLAY â€” Option 5 Architecture
   
   The photo is displayed INSTANTLY as a raw <img>.
   Visual effects (torn edge, color grade, shadow,
   washi tape, postmark) are applied via pure CSS.
   No canvas pipeline blocking the upload.
   Canvas is only used at export time.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Outer wrapper: tilt + drop shadow */
.photo-frame{
  display:block;
  position:relative;
  margin-bottom:18px;
  /* tilt set via JS style.transform */
  /* filter here would break position:absolute containment for tape/postmark children */
}

/* The photo itself â€” clip-path creates torn edges on a div, not img */
/* We use clip-path on the WRAPPER div (not img) which works universally */
.photo-clip{
  position:relative;
  display:block;
  overflow:hidden; /* fallback if clip-path fails */
  /* Drop shadow lives here, NOT on .photo-frame */
  filter:drop-shadow(4px 6px 10px rgba(42,31,14,.35));
}

/* The actual image */
.photo-clip img{
  display:block;
  width:100%;
  height:auto;
  /* CSS filter for color grading â€” works on img, zero JS required */
  /* filter set via JS based on preset */
}

/* Washi tape â€” pure CSS, positioned over the top of the photo */
.photo-tape{
  position:absolute;
  top:-11px;
  height:22px;
  /* left, width, background, transform set via JS */
  z-index:5;
  /* stripe pattern */
  background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.25) 4px,rgba(255,255,255,.25) 5px);
}

/* Postmark â€” pure CSS circle stamp */
.photo-postmark{
  position:absolute;
  /* position, size set via JS */
  z-index:5;
  border-radius:50%;
  border:2.5px solid rgba(110,25,25,.6);
  display:flex;align-items:center;justify-content:center;
  font-family:'Special Elite',monospace;font-size:6px;
  color:rgba(110,25,25,.7);text-align:center;line-height:1.3;
  /* inner ring via outline */
  outline:1.2px solid rgba(110,25,25,.4);
  outline-offset:-6px;
}

/* DROP ZONE */
.dropzone{border:2px dashed var(--bs);border-radius:1px;padding:28px 14px;
  text-align:center;cursor:pointer;background:rgba(247,240,222,.5);
  transition:all .16s;position:relative;margin-bottom:14px}
.dropzone:hover,.dropzone.dv{border-color:var(--al);background:var(--ap)}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;font-size:0}
.dz-ico{font-size:22px;margin-bottom:5px}
.dz-txt{font-family:'Caveat',cursive;font-size:14px;color:var(--muted)}
.dz-txt strong{color:var(--ac)}

/* TEXT FIELDS */
.divider-orn{display:flex;align-items:center;gap:8px;
  font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);
  letter-spacing:.25em;margin:12px 0 10px}
.divider-orn::before,.divider-orn::after{content:'';flex:1;height:1px;background:var(--border)}
.f-title{font-family:'Caveat',cursive;font-size:28px;font-weight:700;color:var(--ink);
  line-height:1.15;width:100%;border:none;background:transparent;outline:none;resize:none;overflow:hidden;
  display:block;margin-bottom:5px}
.f-title:focus{outline:2px dashed rgba(122,64,32,.28);outline-offset:3px;border-radius:1px}
.f-desc{font-family:'Special Elite',monospace;font-size:12px;color:var(--ink2);line-height:1.9;
  width:100%;border:none;background:transparent;outline:none;resize:none;min-height:48px;letter-spacing:.02em;display:block;margin-bottom:7px}
.f-desc:focus{outline:2px dashed rgba(122,64,32,.2);outline-offset:3px;border-radius:1px}

/* Quote block */
.quote-inline{border-left:3px solid rgba(85,92,60,.5);padding:5px 0 5px 11px;margin:10px 0}
.f-quote{font-family:'Caveat',cursive;font-size:19px;color:var(--ink);
  width:100%;border:none;background:transparent;outline:none;resize:none;min-height:28px;display:block}
.f-quote:focus{outline:2px dashed rgba(85,92,60,.3);outline-offset:2px;border-radius:1px}
.quote-footer{display:flex;flex-direction:column;gap:5px;margin-top:6px}
.f-qdate,.f-qloc{font-family:'Special Elite',monospace;font-size:10px;color:var(--muted);
  border:none;background:transparent;outline:none;border-bottom:1px solid rgba(160,130,80,.28);
  width:100%;min-width:0;letter-spacing:.06em;padding-bottom:1px}
.f-qdate:focus,.f-qloc:focus{border-bottom-color:var(--al);outline:none}
.f-qloc{font-family:'Caveat',cursive;font-size:13px;font-style:italic}
.prompt-wrap{margin-top:10px;padding:8px 11px;border-left:3px solid rgba(70,92,60,.48);background:rgba(70,92,60,.05)}
.prompt-lbl{font-family:'Special Elite',monospace;font-size:9px;color:var(--sage);letter-spacing:.14em;margin-bottom:2px}
.f-prompt{font-family:'Caveat',cursive;font-size:15px;color:var(--sage);
  width:100%;border:none;background:transparent;outline:none;resize:none;min-height:28px;display:block}

/* Scrap mode quote */
.scrap-wrap{position:relative;display:inline-block;max-width:94%;margin:12px 0}
.scrap-paper{background:#fdf5dc;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 20px,rgba(130,100,65,.1) 20px,rgba(130,100,65,.1) 21px);
  padding:14px 14px 26px;
  clip-path:polygon(0% 2%,3% 0%,6% 2%,9% 0%,12% 2%,15% 0%,18% 1%,21% 0%,24% 2%,27% 0%,30% 1%,33% 0%,36% 2%,39% 0%,42% 1%,45% 0%,48% 2%,51% 0%,54% 1%,57% 0%,60% 2%,63% 0%,66% 1%,69% 0%,72% 2%,75% 0%,78% 1%,81% 0%,84% 2%,87% 0%,90% 1%,93% 0%,96% 2%,99% 0%,100% 2%,100% 100%,97% 96%,94% 100%,91% 96%,88% 100%,85% 95%,82% 100%,79% 96%,76% 100%,73% 95%,70% 100%,67% 96%,64% 100%,61% 95%,58% 100%,55% 96%,52% 100%,49% 95%,46% 100%,43% 96%,40% 100%,37% 95%,34% 100%,31% 96%,28% 100%,25% 95%,22% 100%,19% 96%,16% 100%,13% 95%,10% 100%,7% 96%,4% 100%,1% 96%,0% 100%);
  box-shadow:2px 3px 9px rgba(42,31,14,.15)}
.scrap-tape-el{position:absolute;top:-9px;height:18px;z-index:5;
  background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.22) 4px,rgba(255,255,255,.22) 5px)}

/* Inline decorations */
.inline-tape{display:block;height:20px;margin:6px -3px;opacity:.85}
.inline-div{text-align:center;font-family:'Special Elite',monospace;font-size:10px;
  color:var(--muted);letter-spacing:.35em;margin:10px 0;opacity:.65}
.inline-txt{font-family:'Caveat',cursive;font-size:17px;color:var(--ink2);
  padding:3px 0;font-style:italic;outline:none;min-height:28px;display:block}

/* RIGHT PANEL */
.rpanel{width:276px;background:rgba(224,212,188,.8);border-left:1px solid var(--border);
  overflow-y:auto;flex-shrink:0;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 26px,rgba(170,140,90,.09) 26px,rgba(170,140,90,.09) 27px)}
.psec{padding:14px;border-bottom:1px solid var(--border)}
.ptitle{font-family:'Special Elite',monospace;font-size:9px;color:var(--muted);
  letter-spacing:.16em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:5px}
.badge{background:var(--ac);color:#f5e0c0;font-size:6.5px;padding:2px 4px;border-radius:1px;letter-spacing:.06em}

/* Style presets */
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.preset-btn{padding:8px 4px;border-radius:1px;border:1.5px solid var(--border);cursor:pointer;
  text-align:center;transition:all .12s;background:rgba(247,240,222,.55);font-family:'Special Elite',monospace;
  box-shadow:1px 1px 0 rgba(42,31,14,.05)}
.preset-btn:hover{border-color:var(--al)}
.preset-btn.active{border-color:var(--ac);background:var(--ap);box-shadow:2px 2px 0 rgba(122,64,32,.1)}
.preset-ico{font-size:14px;margin-bottom:2px}
.preset-name{font-size:8.5px;color:var(--ink);letter-spacing:.05em;display:block}

/* AI panel */
.ai-loader{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 10px;text-align:center;color:var(--muted)}
.quill{font-size:22px;display:inline-block;animation:q 1.4s ease-in-out infinite}
@keyframes q{0%,100%{transform:rotate(-10deg) translateY(0)}50%{transform:rotate(6deg) translateY(-5px)}}
.ai-loader span{font-family:'Caveat',cursive;font-size:13px}
.sug-card{background:rgba(247,240,222,.7);border:1.5px solid var(--border);border-radius:1px;
  padding:10px;margin-bottom:7px;cursor:pointer;transition:all .12s;box-shadow:1px 1px 0 rgba(42,31,14,.04)}
.sug-card:hover{border-color:var(--al);background:var(--ap)}
.sug-card.sel{border-color:var(--ac);background:var(--ap);box-shadow:2px 2px 0 rgba(122,64,32,.08)}
.sug-title{font-family:'Caveat',cursive;font-size:16px;font-weight:600;color:var(--ink);margin-bottom:3px}
.sug-desc{font-family:'Special Elite',monospace;font-size:9.5px;color:var(--ink2);line-height:1.65;letter-spacing:.01em}
.sug-q{font-family:'Caveat',cursive;font-size:12px;color:var(--muted);font-style:italic;
  margin-top:4px;border-top:1px solid var(--border);padding-top:3px}
.sug-meta{font-family:'Special Elite',monospace;font-size:8.5px;color:var(--muted);margin-top:2px;letter-spacing:.04em}
.regen-btn{width:100%;padding:6px;background:none;border:1.5px solid var(--border);border-radius:1px;
  font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:4px;transition:all .12s;margin-top:5px;letter-spacing:.05em}
.regen-btn:hover{border-color:var(--al);color:var(--ac)}

/* Layer list */
.layer-list{display:flex;flex-direction:column;gap:4px}
.layer-item{display:flex;align-items:center;gap:6px;padding:5px 6px;
  background:rgba(247,240,222,.55);border:1px solid var(--border);border-radius:1px;transition:all .12s}
.layer-item:hover{border-color:var(--al)}
.lthumb{width:28px;height:28px;object-fit:cover;border-radius:1px;border:1px solid var(--border);flex-shrink:0}
.linfo{flex:1;min-width:0}
.lname{font-family:'Special Elite',monospace;font-size:9.5px;color:var(--ink);letter-spacing:.04em}
.ldel{background:none;border:none;cursor:pointer;font-size:11px;opacity:.4;transition:opacity .12s;flex-shrink:0}
.ldel:hover{opacity:1}

/* Ephemera */
.decor-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
.decor-btn{padding:7px 2px;background:rgba(247,240,222,.5);border:1.5px solid var(--border);
  border-radius:1px;cursor:pointer;text-align:center;transition:all .12s;
  font-family:'Special Elite',monospace;font-size:8.5px;color:var(--ink2);letter-spacing:.04em}
.decor-btn:hover{border-color:var(--al);background:var(--ap)}
.di{font-size:14px;display:block;margin-bottom:2px}

/* Toggle */
.toggle-row{display:flex;align-items:center;gap:7px;margin-bottom:9px}
.tog{position:relative;width:28px;height:16px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0}
.tslider{position:absolute;inset:0;cursor:pointer;background:var(--bs);border-radius:8px;transition:.16s}
.tslider::before{content:'';position:absolute;width:10px;height:10px;left:3px;top:3px;
  background:white;border-radius:50%;transition:.16s}
.tog input:checked+.tslider{background:var(--ac)}
.tog input:checked+.tslider::before{transform:translateX(12px)}
.tog-lbl{font-family:'Special Elite',monospace;font-size:8.5px;color:var(--muted);letter-spacing:.07em;cursor:pointer}

/* Toast */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(14px);
  background:var(--ink);color:#f5e0c0;padding:7px 16px;border-radius:1px;
  font-family:'Special Elite',monospace;font-size:11px;letter-spacing:.06em;
  opacity:0;transition:all .24s;z-index:9999;pointer-events:none;box-shadow:3px 3px 0 rgba(0,0,0,.2)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* SHARE OVERLAY */
.share-overlay{position:fixed;inset:0;z-index:500;background:rgba(30,20,10,.88);
  backdrop-filter:blur(8px);display:flex;flex-direction:column;align-items:center;
  justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.share-overlay.open{opacity:1;pointer-events:all}
.share-box{background:var(--paper);border:1px solid var(--bs);
  box-shadow:0 24px 60px rgba(0,0,0,.4),5px 5px 0 rgba(42,31,14,.12);
  padding:24px;max-width:520px;width:90%;position:relative}
.share-title{font-family:'Special Elite',monospace;font-size:16px;color:var(--ink);
  letter-spacing:.06em;margin-bottom:3px}
.share-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:12px;
  color:var(--muted);margin-bottom:18px}
.share-preview{width:100%;aspect-ratio:3/4;max-height:340px;object-fit:cover;
  border:1px solid var(--border);margin-bottom:14px;display:block}
.share-preview-wrap{position:relative;margin-bottom:14px;
  background:var(--paper);border:1px solid var(--border);overflow:hidden;
  max-height:340px;display:flex;align-items:flex-start;justify-content:center}
.share-preview-wrap .journal-page{
  transform:scale(.52);transform-origin:top center;
  margin-bottom:calc(-48% - 0px);pointer-events:none;flex-shrink:0}
.share-acts{display:flex;gap:8px}
.share-close{position:absolute;top:12px;right:14px;background:none;border:none;
  font-size:18px;cursor:pointer;color:var(--muted);line-height:1;padding:2px 5px}
.share-close:hover{color:var(--ink)}
.share-url{width:100%;padding:7px 10px;border:1.5px solid var(--bs);
  font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);
  background:rgba(247,240,222,.7);outline:none;border-radius:1px;margin-bottom:10px;
  letter-spacing:.04em;cursor:text}

/* DEMO HERO â€” empty state */
.demo-hero{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:32px;
  align-items:center;padding:32px 0 24px;border-bottom:1px solid var(--border);margin-bottom:28px}
.demo-text{padding-right:12px}
.demo-eyebrow{font-family:'Special Elite',monospace;font-size:9px;color:var(--ac);
  letter-spacing:.22em;margin-bottom:10px}
.demo-headline{font-family:'Special Elite',monospace;font-size:22px;color:var(--ink);
  line-height:1.3;letter-spacing:.03em;margin-bottom:10px}
.demo-body{font-family:'Crimson Pro',serif;font-style:italic;font-size:15px;
  color:var(--ink2);line-height:1.65;margin-bottom:18px}
.demo-acts{display:flex;gap:10px;flex-wrap:wrap}
.demo-page-preview{position:relative;cursor:pointer}
.demo-page-preview:hover .demo-cover{box-shadow:var(--shhov);transform:translateY(-4px) rotate(.5deg)}
.demo-cover{
  aspect-ratio:3/4;background:#3a2810;
  background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 2px,transparent 2px,transparent 12px);
  box-shadow:var(--sh),4px 4px 0 rgba(42,31,14,.08);
  transition:all .2s;position:relative;overflow:hidden;
  display:flex;align-items:flex-end;padding:14px}
.demo-cover-grain{position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='.08'/%3E%3C/svg%3E");pointer-events:none;z-index:2}
.demo-cover-spine{position:absolute;left:0;top:0;bottom:0;width:8px;background:rgba(0,0,0,.25);z-index:3}
.demo-cover-txt{position:relative;z-index:4;color:rgba(255,245,218,.95)}
.demo-cover-name{font-family:'Special Elite',monospace;font-size:13px;line-height:1.2;
  text-shadow:0 1px 4px rgba(0,0,0,.5);letter-spacing:.03em}
.demo-cover-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:11px;opacity:.8;margin-top:3px}
.demo-badge{position:absolute;top:10px;right:10px;background:var(--ac);color:#f5e0c0;
  font-family:'Special Elite',monospace;font-size:8px;letter-spacing:.1em;
  padding:3px 7px;z-index:5;box-shadow:1px 1px 0 rgba(0,0,0,.2)}

/* AUTH */
.auth-bar{display:flex;align-items:center;gap:8px}
.user-chip{display:flex;align-items:center;gap:6px;padding:4px 10px;
  background:rgba(247,240,222,.7);border:1.5px solid var(--border);border-radius:1px;
  font-family:'Special Elite',monospace;font-size:10px;color:var(--ink2);letter-spacing:.04em}
.user-avatar{width:20px;height:20px;border-radius:50%;background:var(--ac);
  display:flex;align-items:center;justify-content:center;color:#f5e0c0;font-size:9px;font-weight:700}
.sync-dot{width:6px;height:6px;border-radius:50%;background:#4a9a4a;display:inline-block;margin-left:2px}
.sync-dot.syncing{background:var(--al);animation:pulse .8s ease-in-out infinite}
.sync-dot.offline{background:var(--muted)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* AUTH MODAL */
.auth-modal .modal-title{margin-bottom:6px}
.auth-tabs{display:flex;gap:0;margin-bottom:18px;border:1.5px solid var(--border);border-radius:1px;overflow:hidden}
.auth-tab{flex:1;padding:7px;font-family:'Special Elite',monospace;font-size:10px;
  letter-spacing:.08em;cursor:pointer;border:none;background:transparent;
  color:var(--muted);transition:all .12s}
.auth-tab.active{background:var(--ac);color:#f5e0c0}
.auth-err{font-family:'Special Elite',monospace;font-size:9px;color:var(--red);
  margin-bottom:8px;letter-spacing:.04em;min-height:14px}

@media print{.topbar,.ed-hdr,.pg-sb,.rpanel{display:none!important}.canvas-area{padding:0;background:none!important}.journal-page{box-shadow:none;width:100%}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE LAYOUT â€” pure CSS, zero JS changes
   Strategy:
   - pg-sb slides in as an overlay drawer
   - rpanel moves below the canvas
   - journal-page scales to viewport width
   - ed-body stacks vertically
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){

  /* Topbar â€” tighter on mobile */
  .topbar{padding:0 14px;height:50px}
  .logo-name{font-size:15px}
  .logo-tag{display:none}
  .btn{padding:5px 10px;font-size:11px}

  /* Editor stacks vertically */
  .editor{height:auto;min-height:calc(100vh - 50px)}
  .ed-body{flex-direction:column;overflow:visible}
  .ed-hdr{height:auto;min-height:44px;flex-wrap:wrap;padding:8px 12px;gap:6px}
  .ed-jname{font-size:11px;order:-1;width:100%;flex:none}

  /* Pages sidebar â€” hidden by default, slides in as drawer */
  .pg-sb{
    position:fixed;left:0;top:0;bottom:0;z-index:300;
    transform:translateX(-100%);transition:transform .24s ease;
    width:110px;padding-top:60px;
    box-shadow:4px 0 20px rgba(42,31,14,.2);
  }
  .pg-sb.open{transform:translateX(0)}

  /* Pages drawer backdrop */
  .pg-backdrop{
    display:none;position:fixed;inset:0;z-index:299;
    background:rgba(42,31,14,.4);backdrop-filter:blur(2px)
  }
  .pg-sb.open ~ .pg-backdrop,
  body.pgopen .pg-backdrop{display:block}

  /* Floating pages toggle button */
  .pg-fab{
    display:flex;position:fixed;bottom:80px;left:12px;z-index:298;
    width:44px;height:44px;border-radius:50%;
    background:var(--ac);color:#f5e0c0;border:none;cursor:pointer;
    align-items:center;justify-content:center;font-size:16px;
    box-shadow:0 4px 14px rgba(42,31,14,.3);transition:all .15s
  }
  .pg-fab:active{transform:scale(.92)}

  /* Canvas area â€” full width, less padding */
  .canvas-area{
    padding:16px 10px 20px;
    min-height:auto;
    justify-content:center;
    overflow-x:hidden;
  }

  /* Journal page â€” scales to fit screen */
  .journal-page{
    width:min(560px, calc(100vw - 20px));
    min-height:auto;
  }

  /* Right panel â€” full width below canvas */
  .rpanel{
    width:100%;border-left:none;
    border-top:2px solid var(--border);
    max-height:none;overflow:visible;
  }
  .psec{padding:12px 14px}

  /* Upload dropzone â€” smaller on mobile */
  .dropzone{padding:18px 12px}

  /* AI suggestion cards */
  .sug-card{padding:10px}
  .sug-title{font-size:15px}

  /* Share overlay */
  .share-box{padding:18px;width:96%}
  .share-preview{max-height:220px}

  /* Modal */
  .modal{padding:20px;width:94%}

  /* Library grid â€” 2 columns on mobile */
  .jgrid{grid-template-columns:repeat(2,1fr);gap:16px}
  .lib-h{font-size:22px}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<nav class="topbar">
  <div class="logo" onclick="showLib()">
    <div class="logo-stamp">P</div>
    <div><div class="logo-name">PAPERLY</div><div class="logo-tag">junk journal co-pilot</div></div>
  </div>
  <div class="topbar-r">
    <div class="auth-bar" id="auth-bar">
      <button class="btn btn-s" id="sign-in-btn" onclick="openModal('m-auth')" style="font-size:10px">â†— SIGN IN</button>
    </div>
    <button class="btn btn-p" onclick="showNewModal()">+ NEW JOURNAL</button>
  </div>
</nav>

<!-- LIBRARY -->
<div id="view-lib" class="view active">
  <div class="library">
    <div class="lib-h">YOUR JOURNALS</div>
    <div class="lib-s">a shelf full of little somethings</div>
    <div class="sep">âœ¦ COLLECTION âœ¦</div>
    <div class="jgrid" id="jgrid"></div>
  </div>
</div>

<!-- EDITOR -->
<div id="view-ed" class="view">
  <div class="editor">
    <div class="ed-hdr">
      <button class="ed-back" onclick="showLib()">â† BACK</button>
      <div style="width:1px;height:18px;background:var(--border)"></div>
      <div class="ed-jname" id="ed-jname"></div>
      <div style="display:flex;gap:6px;margin-left:auto">
        <button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="openShare()">â†— SHARE</button>
        <button class="btn btn-s" style="font-size:10px;padding:4px 10px" onclick="window.print()">â†“ EXPORT</button>
        <button class="btn btn-g" style="font-size:12px" onclick="delPage()" title="Delete page">ğŸ—‘</button>
      </div>
    </div>
    <div class="ed-body">

      <!-- Pages sidebar -->
      <div class="pg-sb" id="pg-sb">
        <div class="sb-lbl">PAGES</div>
        <div id="pglist"></div>
        <button class="addpg" onclick="addPage()">
          <span style="font-size:16px">+</span><span>page</span>
        </button>
      </div>
      <!-- Mobile drawer backdrop -->
      <div class="pg-backdrop" id="pg-backdrop" onclick="closePgDrawer()"></div>
      <!-- Mobile pages FAB -->
      <button class="pg-fab" id="pg-fab" onclick="togglePgDrawer()" title="Pages">ğŸ“„</button>

      <!-- Canvas / page area -->
      <div class="canvas-area">
        <div class="journal-page" id="jpage">
          <div class="page-content" id="pcontent"></div>
        </div>
      </div>

      <!-- Right panel -->
      <div class="rpanel">
        <!-- Upload -->
        <div class="psec">
          <div class="ptitle">ğŸ“· ADD PHOTO</div>
          <div class="dropzone" id="main-dz"
            ondragover="event.preventDefault();this.classList.add('dv')"
            ondragleave="this.classList.remove('dv')"
            ondrop="onDrop(event,'main')">
            <input type="file" accept="image/*" id="main-file-input" onchange="onFile(event,'main')">
            <div class="dz-ico">ğŸ–¼</div>
            <div class="dz-txt"><strong>Click or drag photo</strong><br>appears instantly</div>
          </div>
        </div>

        <!-- Style presets -->
        <div class="psec">
          <div class="ptitle">ğŸ¨ STYLE</div>
          <div class="preset-grid" id="preset-grid">
            <button class="preset-btn active" data-p="vintage" onclick="setPreset('vintage',this)"><div class="preset-ico">ğŸ“œ</div><span class="preset-name">VINTAGE</span></button>
            <button class="preset-btn" data-p="darkacademia" onclick="setPreset('darkacademia',this)"><div class="preset-ico">ğŸ“š</div><span class="preset-name">DARK ACADEMIA</span></button>
            <button class="preset-btn" data-p="botanical" onclick="setPreset('botanical',this)"><div class="preset-ico">ğŸŒ¿</div><span class="preset-name">BOTANICAL</span></button>
            <button class="preset-btn" data-p="summer" onclick="setPreset('summer',this)"><div class="preset-ico">â˜€ï¸</div><span class="preset-name">FADED SUMMER</span></button>
            <button class="preset-btn" data-p="moody" onclick="setPreset('moody',this)"><div class="preset-ico">ğŸŒ§</div><span class="preset-name">MOODY</span></button>
          </div>
        </div>

        <!-- AI panel -->
        <div class="psec">
          <div class="ptitle">âœ¦ AI SUGGESTIONS <span class="badge">CLAUDE</span></div>
          <div id="ai-panel">
            <div style="font-family:'Caveat',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">
              Upload a photo â€” Claude automatically writes your page
            </div>
          </div>
        </div>

        <!-- Memory scrap toggle -->
        <div class="psec">
          <div class="ptitle">ğŸ’¬ MEMORY SCRAP</div>
          <div class="toggle-row">
            <label class="tog"><input type="checkbox" id="scrap-tog" onchange="toggleScrap(this.checked)"><span class="tslider"></span></label>
            <span class="tog-lbl">TORN PAPER SCRAP MODE</span>
          </div>
        </div>

        <!-- Collage layers -->
        <div class="psec">
          <div class="ptitle">ğŸ–¼ COLLAGE LAYERS</div>
          <div class="dropzone" style="padding:10px 7px;margin-bottom:6px"
            ondragover="event.preventDefault();this.classList.add('dv')"
            ondragleave="this.classList.remove('dv')"
            ondrop="onDrop(event,'layer')">
            <input type="file" accept="image/*" onchange="onFile(event,'layer')">
            <div class="dz-txt" style="font-size:12px"><strong>+ Add layer</strong></div>
          </div>
          <div class="layer-list" id="layer-list"><div style="font-family:'Caveat',cursive;font-size:12px;color:var(--muted)">No layers yet</div></div>
        </div>

        <!-- Ephemera -->
        <div class="psec">
          <div class="ptitle">ğŸª¡ EPHEMERA</div>
          <div class="decor-grid">
            <button class="decor-btn" onclick="addDecor('tape-floral')"><span class="di">ğŸŒ¸</span>FLORAL</button>
            <button class="decor-btn" onclick="addDecor('tape-stripe')"><span class="di">ğŸ“</span>STRIPE</button>
            <button class="decor-btn" onclick="addDecor('tape-kraft')"><span class="di">ğŸ“¦</span>KRAFT</button>
            <button class="decor-btn" onclick="addDecor('postmark')"><span class="di">ğŸ“®</span>POSTMARK</button>
            <button class="decor-btn" onclick="addDecor('botanical')"><span class="di">ğŸŒ¿</span>PLANT</button>
            <button class="decor-btn" onclick="addDecor('stamp')"><span class="di">ğŸ”–</span>STAMP</button>
            <button class="decor-btn" onclick="addDecor('divider')"><span class="di">âœ¦</span>DIVIDER</button>
            <button class="decor-btn" onclick="addDecor('text')"><span class="di">âœ</span>TEXT</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW JOURNAL MODAL -->
<div class="overlay" id="m-new">
  <div class="modal">
    <div class="modal-title">CREATE JOURNAL</div>
    <div class="modal-sub">every collection starts with a name</div>
    <label class="flabel">JOURNAL NAME</label>
    <input class="finput" type="text" id="inp-name" placeholder="Autumn Wanderingsâ€¦" maxlength="50" onkeydown="if(event.key==='Enter')createJournal()">
    <label class="flabel">COVER COLOR</label>
    <div class="color-row">
      <div class="csw sel" data-c="#7a4020" style="background:#7a4020" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#3a4a5a" style="background:#3a4a5a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#4a5a3a" style="background:#4a5a3a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#6a2020" style="background:#6a2020" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#1e3a30" style="background:#1e3a30" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#4a3a6a" style="background:#4a3a6a" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#5a4a30" style="background:#5a4a30" onclick="pickColor(this)"></div>
      <div class="csw" data-c="#8a6a10" style="background:#8a6a10" onclick="pickColor(this)"></div>
    </div>
    <div class="modal-acts">
      <button class="btn btn-s" onclick="closeModal('m-new')">CANCEL</button>
      <button class="btn btn-p" onclick="createJournal()">CREATE</button>
    </div>
  </div>
</div>


<!-- SHARE OVERLAY -->
<div class="share-overlay" id="share-overlay">
  <div class="share-box">
    <button class="share-close" onclick="closeShare()">âœ•</button>
    <div class="share-title">SHARE THIS PAGE</div>
    <div class="share-sub">your journal page, ready to share</div>
    <canvas id="share-canvas" style="display:none"></canvas>
    <img id="share-img" class="share-preview" alt="Journal page preview">
    <input class="share-url" id="share-url" readonly onclick="this.select()" value="">
    <div class="share-acts">
      <button class="btn btn-p" style="flex:1;justify-content:center" onclick="copyShareUrl()">ğŸ“‹ COPY LINK</button>
      <button class="btn btn-s" style="flex:1;justify-content:center" onclick="downloadPage()">â†“ SAVE IMAGE</button>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="overlay" id="m-auth">
  <div class="modal auth-modal" style="max-width:360px">
    <div class="modal-title">WELCOME TO PAPERLY</div>
    <div class="modal-sub">sign in to save your journals to the cloud</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-in" onclick="switchAuthTab('in')">SIGN IN</button>
      <button class="auth-tab" id="tab-up" onclick="switchAuthTab('up')">CREATE ACCOUNT</button>
    </div>
    <div class="auth-err" id="auth-err"></div>
    <label class="flabel">EMAIL</label>
    <input class="finput" type="email" id="auth-email" placeholder="you@example.com" style="margin-bottom:10px"
      onkeydown="if(event.key==='Enter')document.getElementById('auth-pass').focus()">
    <label class="flabel">PASSWORD</label>
    <input class="finput" type="password" id="auth-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
      onkeydown="if(event.key==='Enter')submitAuth()">
    <div class="modal-acts">
      <button class="btn btn-s" onclick="closeModal('m-auth')">CANCEL</button>
      <button class="btn btn-p" id="auth-submit-btn" onclick="submitAuth()">SIGN IN</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEEDED RNG â€” same page ID always gets same torn edge
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkRng(seed) {
  let s = Math.abs(seed) | 0 || 1;
  return () => { s = (Math.imul(1664525, s) + 1013904223) | 0; return (s >>> 0) / 4294967295; };
}
function strHash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (Math.imul(31, h) + str.charCodeAt(i)) | 0;
  return Math.abs(h);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSS FILTER PRESETS â€” applied directly to <img>
// No canvas, no async, instant, works everywhere
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESET_CSS = {
  vintage:      'sepia(.65) brightness(.88) contrast(1.06) saturate(.78)',
  darkacademia: 'sepia(.35) brightness(.72) contrast(1.2) saturate(.48)',
  botanical:    'sepia(.15) brightness(1.04) contrast(1.04) saturate(.9) hue-rotate(14deg)',
  summer:       'sepia(.1) brightness(1.1) contrast(.96) saturate(1.2)',
  moody:        'sepia(.45) brightness(.68) contrast(1.22) saturate(.4) hue-rotate(-10deg)',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TORN EDGE â€” unique clip-path polygon per page ID
// Applied as CSS clip-path on .photo-clip div
// Works on divs universally (not on <img> directly)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeTornClipPath(pageId) {
  const rng = mkRng(strHash(pageId + 'torn'));
  const W = 100, H = 100; // percentage coordinates

  const jag = (t, style) => {
    if (style === 'rough')   return (rng() - .5) * 4.5;
    if (style === 'deckled') return Math.sin(t * 7) * 2.2 + (rng() - .5) * 2.8;
    return rng() > .88 ? (rng() - .5) * 9 : (rng() - .5) * 1.5; // cut
  };

  const styles = ['rough', 'deckled', 'cut'];
  const ts = styles[Math.floor(rng() * styles.length)];
  const bs = styles[Math.floor(rng() * styles.length)];
  const ls = styles[Math.floor(rng() * styles.length)];
  const rs = styles[Math.floor(rng() * styles.length)];

  const N = 18;
  const pts = [];

  // Top edge: leftâ†’right
  for (let i = 0; i <= N; i++) {
    const t = i / N;
    pts.push(`${Math.min(100, Math.max(0, t * W + jag(t, ts))).toFixed(1)}% ${Math.min(8, Math.max(0, jag(t, ts) * .6 + 1.5)).toFixed(1)}%`);
  }
  // Right edge: topâ†’bottom
  for (let i = 1; i <= N; i++) {
    const t = i / N;
    pts.push(`${Math.min(100, Math.max(92, W + jag(t, rs) * .7)).toFixed(1)}% ${(t * H + jag(t, rs) * .4).toFixed(1)}%`);
  }
  // Bottom edge: rightâ†’left
  for (let i = N; i >= 0; i--) {
    const t = i / N;
    pts.push(`${Math.min(100, Math.max(0, t * W + jag(t, bs))).toFixed(1)}% ${Math.min(100, Math.max(92, H + jag(t, bs) * .6)).toFixed(1)}%`);
  }
  // Left edge: bottomâ†’top
  for (let i = N; i >= 0; i--) {
    const t = i / N;
    pts.push(`${Math.min(8, Math.max(0, jag(t, ls) * .7 + 1.5)).toFixed(1)}% ${(t * H + jag(t, ls) * .4).toFixed(1)}%`);
  }

  return `polygon(${pts.join(',')})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WASHI TAPE â€” CSS positioning, no canvas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function washiStyle(pageId) {
  const rng = mkRng(strHash(pageId + 'washi'));
  const colors = [
    'rgba(196,168,140,.65)', 'rgba(155,178,140,.62)', 'rgba(182,140,168,.58)',
    'rgba(100,128,180,.52)', 'rgba(200,140,100,.62)', 'rgba(160,100,100,.55)',
    'rgba(180,165,120,.6)',  'rgba(130,160,130,.58)',
  ];
  const color = colors[Math.floor(rng() * colors.length)];
  const width = 48 + Math.floor(rng() * 40);
  const left  = 15 + Math.floor(rng() * 55); // percent
  const angle = (rng() - .5) * 6; // degrees
  return { color, width, left, angle };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POSTMARK â€” CSS circle, no canvas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function postmarkStyle(pageId) {
  const rng = mkRng(strHash(pageId + 'pm'));
  if (rng() > .62) return null; // not every image gets one
  const size  = 44 + Math.floor(rng() * 18);
  const right = rng() > .5; // right or left side
  const x     = 8 + Math.floor(rng() * 14);
  const bottom= 10 + Math.floor(rng() * 16);
  const angle = (rng() - .5) * 18;
  return { size, right, x, bottom, angle };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  journals: [],
  jid: null,
  pidx: 0,
  preset: 'vintage',
  scrapMode: false,
};

const PRESET_NAMES = {
  vintage: 'VINTAGE', darkacademia: 'DARK ACADEMIA',
  botanical: 'BOTANICAL', summer: 'FADED SUMMER', moody: 'MOODY',
};

const PRESET_VOICE = {
  vintage:      "Write in a warm antique voice â€” like a letter found in a grandmother's attic. Poetic, nostalgic.",
  darkacademia: "Write with literary melancholy â€” candlelight, old books, autumn, the quiet pursuit of beauty.",
  botanical:    "Write with a naturalist's reverence â€” gentle, observational, in awe of living things.",
  summer:       "Write with sun-bleached nostalgia â€” a perfect afternoon, faded and bittersweet.",
  moody:        "Write with cinematic introspection â€” rain, ink, quiet sadness that feels like a gift.",
};

const BOTANICALS  = ['ğŸŒ¿','ğŸƒ','ğŸŒ¾','ğŸ‚','ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ¹','ğŸ€','ğŸŒµ'];
const STAMPS      = ['PASSED','RECEIVED','FRAGILE','SPECIAL','MEMORIES','FOUND','RARE','ARCHIVAL'];
const COVER_PATS  = [
  'repeating-linear-gradient(45deg,rgba(255,255,255,.07) 0,rgba(255,255,255,.07) 2px,transparent 2px,transparent 12px)',
  'repeating-linear-gradient(135deg,rgba(255,255,255,.05) 0,rgba(255,255,255,.05) 1px,transparent 1px,transparent 8px)',
  'radial-gradient(ellipse at 30% 30%,rgba(255,255,255,.1) 0%,transparent 55%)',
  'repeating-linear-gradient(0deg,rgba(255,255,255,.05) 0,rgba(255,255,255,.05) 1px,transparent 1px,transparent 16px)',
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE â€” cloud persistence
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA_URL  = 'https://dgqvpttyrnsunsjjfqwv.supabase.co';
const SUPA_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRncXZwdHR5cm5zdW5zampmcXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDUyNDcsImV4cCI6MjA4NzM4MTI0N30.-zdMprzTCFUKdtWYDKekLbHmxJs4iAhKh9itb8g398o';
const sb = supabase.createClient(SUPA_URL, SUPA_KEY);

let currentUser = null;
let saveTimer   = null;

// â”€â”€ Serialize journals for cloud (images stay as-is in jsonb) â”€â”€
function toCloud() {
  return S.journals.map(j => ({
    id: j.id,
    user_id: currentUser.id,
    data: j,           // full journal including base64 images
    updated_at: new Date().toISOString(),
  }));
}

// â”€â”€ Save: local immediately, cloud debounced 1.5s â”€â”€
function save() {
  // Always keep a local copy as safety net
  try {
    const lite = S.journals.map(j => ({
      ...j,
      pages: j.pages.map(p => ({
        ...p,
        rawImage: p.rawImage ? '__R__' : null,
        layers: (p.layers || []).map(l => ({ ...l, raw: '__R__' })),
      })),
    }));
    localStorage.setItem('paperly6', JSON.stringify(lite));
    S.journals.forEach(j => j.pages.forEach(p => {
      if (p.rawImage) try { localStorage.setItem('pr_' + p.id, p.rawImage); } catch(e) {}
      (p.layers || []).forEach(l => {
        if (l.raw) try { localStorage.setItem('pr_' + l.id, l.raw); } catch(e) {}
      });
    }));
  } catch(e) {}

  // Cloud sync if signed in
  if (currentUser) {
    setSyncDot('syncing');
    clearTimeout(saveTimer);
    saveTimer = setTimeout(syncToCloud, 1500);
  }
}

async function syncToCloud() {
  if (!currentUser || !S.journals.length) { setSyncDot('ok'); return; }
  try {
    // Upsert each journal individually so partial failures don't wipe data
    for (const j of S.journals) {
      const { error } = await sb.from('journals').upsert({
        id: j.id,
        user_id: currentUser.id,
        data: j,
        updated_at: new Date().toISOString(),
      }, { onConflict: 'id' });
      if (error) throw error;
    }
    setSyncDot('ok');
  } catch(err) {
    console.warn('Cloud sync failed:', err.message);
    setSyncDot('offline');
    toast('Saved locally â€” cloud sync failed');
  }
}

// â”€â”€ Load: from cloud if signed in, else from localStorage â”€â”€
function load() {
  try {
    const raw = localStorage.getItem('paperly6');
    if (!raw) return;
    S.journals = JSON.parse(raw);
    S.journals.forEach(j => j.pages.forEach(p => {
      if (p.rawImage === '__R__') p.rawImage = localStorage.getItem('pr_' + p.id) || null;
      (p.layers || []).forEach(l => {
        if (l.raw === '__R__') l.raw = localStorage.getItem('pr_' + l.id) || null;
      });
    }));
  } catch(e) { S.journals = []; }
}

async function loadFromCloud() {
  if (!currentUser) return;
  try {
    const { data, error } = await sb
      .from('journals')
      .select('data')
      .eq('user_id', currentUser.id)
      .order('updated_at', { ascending: false });
    if (error) throw error;
    if (data && data.length) {
      S.journals = data.map(r => r.data);
      // Also update localStorage cache
      save();
    }
    setSyncDot('ok');
  } catch(err) {
    console.warn('Cloud load failed:', err.message);
    setSyncDot('offline');
  }
}

// Delete a journal from cloud when user deletes it
async function deleteFromCloud(id) {
  if (!currentUser) return;
  try {
    await sb.from('journals').delete().eq('id', id).eq('user_id', currentUser.id);
  } catch(err) { console.warn('Cloud delete failed:', err.message); }
}

// â”€â”€ Sync indicator â”€â”€
function setSyncDot(state) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (state === 'syncing' ? ' syncing' : state === 'offline' ? ' offline' : '');
  dot.title = state === 'ok' ? 'Saved to cloud' : state === 'syncing' ? 'Savingâ€¦' : 'Offline â€” saved locally';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let authMode = 'in'; // 'in' | 'up'

function switchAuthTab(mode) {
  authMode = mode;
  document.getElementById('tab-in').classList.toggle('active', mode === 'in');
  document.getElementById('tab-up').classList.toggle('active', mode === 'up');
  document.getElementById('auth-submit-btn').textContent = mode === 'in' ? 'SIGN IN' : 'CREATE ACCOUNT';
  document.getElementById('auth-err').textContent = '';
}

async function submitAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const pass  = document.getElementById('auth-pass').value;
  const errEl = document.getElementById('auth-err');
  errEl.textContent = '';

  if (!email || !pass) { errEl.textContent = 'EMAIL AND PASSWORD REQUIRED'; return; }
  const btn = document.getElementById('auth-submit-btn');
  btn.textContent = 'â€¦'; btn.disabled = true;

  try {
    let res;
    if (authMode === 'in') {
      res = await sb.auth.signInWithPassword({ email, password: pass });
    } else {
      res = await sb.auth.signUp({ email, password: pass });
    }
    if (res.error) throw res.error;
    closeModal('m-auth');
    document.getElementById('auth-email').value = '';
    document.getElementById('auth-pass').value = '';
    if (authMode === 'up') toast('Account created â€” welcome to Paperly âœ“');
  } catch(err) {
    errEl.textContent = err.message.toUpperCase();
  } finally {
    btn.textContent = authMode === 'in' ? 'SIGN IN' : 'CREATE ACCOUNT';
    btn.disabled = false;
  }
}

async function signOut() {
  await sb.auth.signOut();
  currentUser = null;
  S.journals = [];
  load(); // fall back to local
  renderAuthBar(null);
  renderLib();
  toast('Signed out');
}

function renderAuthBar(user) {
  const bar = document.getElementById('auth-bar');
  if (!user) {
    bar.innerHTML = '<button class="btn btn-s" onclick="openModal(\'m-auth\')" style="font-size:10px">â†— SIGN IN</button>';
  } else {
    const initials = user.email.slice(0, 2).toUpperCase();
    bar.innerHTML =
      '<div class="user-chip">'
      + '<div class="user-avatar">' + initials + '</div>'
      + '<span>' + user.email.split('@')[0] + '</span>'
      + '<span class="sync-dot" id="sync-dot" title="Saved to cloud"></span>'
      + '</div>'
      + '<button class="btn btn-g" onclick="signOut()" style="font-size:10px">SIGN OUT</button>';
  }
}

// Listen for auth state changes â€” fires on sign-in, sign-out, and page load
sb.auth.onAuthStateChange(async (event, session) => {
  currentUser = session?.user || null;
  renderAuthBar(currentUser);

  if (currentUser) {
    if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
      // INITIAL_SESSION fires on page refresh for already-logged-in users
      // SIGNED_IN fires when user explicitly signs in
      if (event === 'SIGNED_IN') toast('Signed in â€” loading your journalsâ€¦');
      setSyncDot('syncing');
      await loadFromCloud();
      // If user had local journals before signing in, merge and upload them
      if (event === 'SIGNED_IN') {
        const localRaw = localStorage.getItem('paperly6');
        if (localRaw) {
          try {
            const localJs = JSON.parse(localRaw);
            for (const lj of localJs) {
              if (!S.journals.find(j => j.id === lj.id)) S.journals.push(lj);
            }
            if (localJs.length) await syncToCloud();
          } catch(e) {}
        }
        toast('Journals loaded âœ“');
      }
      renderLib();
    }
  } else {
    // Signed out or no session â€” show landing, clear data
    S.journals = [];
    renderLib();
  }
});

const gid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 5);
const getJ = () => S.journals.find(j => j.id === S.jid);
const getP = () => { const j = getJ(); return j ? j.pages[S.pidx] : null; };
const blank = () => ({
  id: gid(), rawImage: null, preset: 'vintage',
  title: '', desc: '', quote: '', date: '', location: '',
  decorations: [], layers: [],
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLib() {
  document.getElementById('view-lib').classList.add('active');
  document.getElementById('view-ed').classList.remove('active');
  renderLib();
}
function showEd(jid) {
  S.jid = jid; S.pidx = 0;
  document.getElementById('view-lib').classList.remove('active');
  document.getElementById('view-ed').classList.add('active');
  renderEditor();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLib() {
  const grid = document.getElementById('jgrid');
  grid.innerHTML = '';

  // â”€â”€ LOGGED OUT: show landing page only, no journals, demo accessible â”€â”€
  if (!currentUser) {
    const landing = document.createElement('div');
    landing.className = 'demo-hero';
    landing.style.cssText = 'grid-column:1/-1';
    landing.innerHTML = `
      <div class="demo-text">
        <div class="demo-eyebrow">âœ¦ WELCOME TO PAPERLY</div>
        <div class="demo-headline">Turn any photo into a beautiful journal page</div>
        <div class="demo-body">Upload a photo. Claude reads the image and writes your title, caption, and memory quote â€” instantly. Every page feels handmade.</div>
        <div class="demo-acts">
          <button class="btn btn-p" onclick="openModal('m-auth')">â†— SIGN IN TO START</button>
          <button class="btn btn-s" onclick="showDemo()">ğŸ‘ SEE A DEMO</button>
        </div>
      </div>
      <div class="demo-page-preview" onclick="showDemo()">
        <div class="demo-cover">
          <div class="demo-cover-grain"></div>
          <div class="demo-cover-spine"></div>
          <div class="demo-badge">DEMO</div>
          <div class="demo-cover-txt">
            <div class="demo-cover-name">Tokyo Nights</div>
            <div class="demo-cover-sub">a thursday in late november</div>
          </div>
        </div>
      </div>`;
    grid.appendChild(landing);
    return; // stop here â€” don't show journals or + new card
  }

  // â”€â”€ LOGGED IN: always show demo card first, then user's journals â”€â”€
  // Demo card â€” always visible so users can revisit it
  const demoCard = document.createElement('div');
  demoCard.className = 'jcard';
  demoCard.onclick = showDemo;
  demoCard.innerHTML =
    '<div class="jcov" style="background:#2a3a4a;background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.06) 0,rgba(255,255,255,.06) 2px,transparent 2px,transparent 12px)">'
    + '<div class="jcov-grain"></div><div class="jspine"></div>'
    + '<div class="demo-badge" style="top:8px;right:8px">DEMO</div>'
    + '<div class="jcov-txt"><div class="jcov-name">Tokyo Nights</div><div class="jcov-ct">see how it works</div></div></div>'
    + '<div class="jmeta"><div class="jmeta-name">Demo Journal</div><div class="jmeta-date">tap to explore</div></div>';
  grid.appendChild(demoCard);

  if (!S.journals.length) {
    // Signed in but no journals yet â€” prompt to create
    const empty = document.createElement('div');
    empty.style.cssText = 'grid-column:2/-1;display:flex;align-items:center;padding:20px 0';
    empty.innerHTML = '<div style="font-family:\'Crimson Pro\',serif;font-style:italic;color:var(--muted);font-size:14px">Your journals will appear here once you create one â†’</div>';
    grid.appendChild(empty);
  } else {
    S.journals.forEach((j, i) => {
      const thumb = j.pages.find(p => p.rawImage);
      const pc = j.pages.length;
      const pat = COVER_PATS[i % COVER_PATS.length];
      const card = document.createElement('div');
      card.className = 'jcard';
      card.innerHTML = '<div class="jacts">'
        + '<button class="icobtn" onclick="event.stopPropagation();renameJ(\'' + j.id + '\')" title="Rename">âœï¸</button>'
        + '<button class="icobtn" onclick="event.stopPropagation();deleteJ(\'' + j.id + '\')" title="Delete">ğŸ—‘</button></div>'
        + '<div class="jcov" style="background:' + j.color + ';background-image:' + pat + '" onclick="showEd(\'' + j.id + '\')">'
        + '<div class="jcov-grain"></div><div class="jspine"></div>'
        + (thumb ? '<img class="jthumb" src="' + thumb.rawImage + '">' : '')
        + '<div class="jcov-txt"><div class="jcov-name">' + esc(j.name) + '</div>'
        + '<div class="jcov-ct">' + pc + ' page' + (pc !== 1 ? 's' : '') + '</div></div></div>'
        + '<div class="jmeta"><div class="jmeta-name">' + esc(j.name) + '</div>'
        + '<div class="jmeta-date">' + fmtD(j.createdAt) + '</div></div>';
      grid.appendChild(card);
    });
  }

  // + New journal card
  const nc = document.createElement('div');
  nc.innerHTML = '<div class="newcard" onclick="showNewModal()"><div style="font-size:22px">ï¼‹</div><div class="newcard-lbl">new journal</div></div>';
  grid.appendChild(nc.firstElementChild);
}
const fmtD = ts => new Date(ts).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOURNAL CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selColor = '#7a4020';
function pickColor(el) { document.querySelectorAll('.csw').forEach(s => s.classList.remove('sel')); el.classList.add('sel'); selColor = el.dataset.c; }
function showNewModal() {
  if (!currentUser) { openModal('m-auth'); toast('Sign in to create a journal'); return; }
  document.getElementById('inp-name').value = '';
  openModal('m-new');
  setTimeout(() => document.getElementById('inp-name').focus(), 200);
}
function createJournal() {
  if (!currentUser) { openModal('m-auth'); return; }
  const name = document.getElementById('inp-name').value.trim() || 'Untitled Journal';
  S.journals.unshift({ id: gid(), name, color: selColor, createdAt: Date.now(), pages: [blank()] });
  save(); closeModal('m-new'); showEd(S.journals[0].id);
}
function deleteJ(id) {
  if (!confirm('Delete this journal?')) return;
  S.journals = S.journals.filter(j => j.id !== id);
  save();
  deleteFromCloud(id);
  renderLib();
  toast('Journal deleted');
}
function renameJ(id) { const j = S.journals.find(j => j.id === id); const n = prompt('Rename:', j.name); if (n && n.trim()) { j.name = n.trim(); save(); renderLib(); } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEditor() {
  const j = getJ(); if (!j) return;
  document.getElementById('ed-jname').textContent = j.name;
  S.preset = getP()?.preset || 'vintage';
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === S.preset));
  document.getElementById('scrap-tog').checked = S.scrapMode;
  renderSidebar();
  renderPage();
  resetAiPanel();
}

function renderSidebar() {
  const j = getJ(); const list = document.getElementById('pglist');
  list.innerHTML = '';
  j.pages.forEach((p, i) => {
    const t = document.createElement('div');
    t.className = 'pgthumb' + (i === S.pidx ? ' active' : '');
    t.onclick = () => selectPage(i);
    if (p.rawImage) {
      const img = document.createElement('img');
      img.src = p.rawImage;
      t.appendChild(img);
    } else {
      t.style.cssText = 'font-family:Caveat,cursive;font-size:10px;color:var(--muted)';
      t.textContent = 'blank';
    }
    const num = document.createElement('span'); num.className = 'pgnum'; num.textContent = i + 1;
    t.appendChild(num);
    list.appendChild(t);
  });
}

function selectPage(i) { S.pidx = i; renderSidebar(); renderPage(); resetAiPanel(); }
function addPage() { const j = getJ(); j.pages.push(blank()); S.pidx = j.pages.length - 1; save(); renderSidebar(); renderPage(); resetAiPanel(); toast('New page added'); }
function delPage() {
  const j = getJ();
  if (j.pages.length <= 1) { toast('Cannot delete last page'); return; }
  if (!confirm('Delete this page?')) return;
  j.pages.splice(S.pidx, 1);
  S.pidx = Math.max(0, S.pidx - 1);
  save(); renderEditor(); toast('Page deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPage() {
  const p = getP(); if (!p) return;
  S.preset = p.preset || 'vintage';
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === S.preset));
  document.getElementById('scrap-tog').checked = S.scrapMode;

  const content = document.getElementById('pcontent');
  content.innerHTML = '';

  // Before decorations
  (p.decorations || []).filter(d => d.pos === 'before').forEach(d => content.appendChild(makeDecorEl(d)));

  if (p.rawImage) {
    content.appendChild(makePhotoEl(p));
    (p.layers || []).forEach((layer, li) => { if (layer.raw) content.appendChild(makeLayerEl(layer, li)); });
  } else {
    content.appendChild(makeDzEl());
  }

  if (p.title || p.desc || p.quote || p.date || p.location) {
    const sep = document.createElement('div');
    sep.className = 'divider-orn'; sep.textContent = 'âœ¦ âœ¦ âœ¦';
    content.appendChild(sep);
    if (p.title || p.desc) {
      content.appendChild(mkTA('f-title', 'add a titleâ€¦', p.title, 'title', 1));
      content.appendChild(mkTA('f-desc', 'your captionâ€¦', p.desc, 'desc', 3));
    }
    if (p.quote || p.date || p.location) content.appendChild(makeQuoteBlock(p));
  }

  (p.decorations || []).filter(d => d.pos === 'after').forEach(d => content.appendChild(makeDecorEl(d)));
  content.querySelectorAll('textarea').forEach(autoR);
  renderLayers();
}

// â”€â”€ Photo element â€” INSTANT display, CSS effects only â”€â”€
function makePhotoEl(p) {
  const rng   = mkRng(strHash(p.id + 'tilt'));
  const tilts = [-2.5, -1.6, -.8, 0, .8, 1.6, 2.5];
  const tilt  = tilts[Math.floor(rng() * tilts.length)];

  const frame = document.createElement('div');
  frame.className = 'photo-frame';
  frame.style.transform = 'rotate(' + tilt + 'deg)';

  // Torn edge clip on wrapper div (not img â€” div clip-path works everywhere)
  const clip = document.createElement('div');
  clip.className = 'photo-clip';
  clip.style.clipPath = makeTornClipPath(p.id);

  const img = document.createElement('img');
  img.src = p.rawImage;
  img.alt = '';
  img.style.cssText = 'display:block;width:100%;height:auto';
  img.style.filter = PRESET_CSS[p.preset || S.preset] || PRESET_CSS.vintage;

  clip.appendChild(img);
  frame.appendChild(clip);

  // Washi tape
  const ws = washiStyle(p.id);
  const tape = document.createElement('div');
  tape.className = 'photo-tape';
  tape.style.cssText = 'left:' + ws.left + '%;width:' + ws.width + 'px;background-color:' + ws.color + ';transform:rotate(' + ws.angle + 'deg)';
  frame.appendChild(tape);

  // Postmark
  const ps = postmarkStyle(p.id);
  if (ps) {
    const pm = document.createElement('div');
    pm.className = 'photo-postmark';
    const side = ps.right ? 'right:' + ps.x + 'px' : 'left:' + ps.x + 'px';
    pm.style.cssText = 'width:' + ps.size + 'px;height:' + ps.size + 'px;bottom:' + ps.bottom + 'px;' + side + ';transform:rotate(' + ps.angle + 'deg)';
    pm.innerHTML = 'PAPERLY<br>âœ¦<br>' + new Date().getFullYear();
    pm.style.fontSize = Math.round(ps.size * .13) + 'px';
    frame.appendChild(pm);
  }

  return frame;
}

function makeLayerEl(layer, li) {
  const rng   = mkRng(strHash(layer.id + 'lt'));
  const tilts = [-2.5, -1.6, -.8, 0, .8, 1.6, 2.5];
  const tilt  = tilts[Math.floor(rng() * tilts.length)];
  const scales= [.54, .62, .47, .58, .51];
  const sc    = scales[li % scales.length];
  const offs  = [[-8, 20], [36, -12], [10, 42], [-4, 16], [30, 8]];
  const [lx, ly] = offs[li % offs.length];

  const frame = document.createElement('div');
  frame.className = 'photo-frame';
  frame.style.cssText = 'transform:rotate(' + tilt + 'deg) translate(' + lx + 'px,' + ly + 'px);width:' + Math.round(sc * 100) + '%;position:relative;z-index:' + (li + 2) + ';margin-top:' + Math.round(ly - 50) + 'px;margin-left:' + (lx > 0 ? lx : 0) + 'px';

  const clip = document.createElement('div');
  clip.className = 'photo-clip';
  clip.style.clipPath = makeTornClipPath(layer.id);

  const img = document.createElement('img');
  img.src = layer.raw;
  img.alt = '';
  img.style.cssText = 'display:block;width:100%;height:auto';
  img.style.filter = PRESET_CSS[S.preset] || PRESET_CSS.vintage;

  clip.appendChild(img);
  frame.appendChild(clip);

  // Small washi tape on layer
  const ws = washiStyle(layer.id);
  const tape = document.createElement('div');
  tape.className = 'photo-tape';
  tape.style.cssText = 'left:' + ws.left + '%;width:' + (ws.width * .7) + 'px;background-color:' + ws.color + ';transform:rotate(' + ws.angle + 'deg)';
  frame.appendChild(tape);

  return frame;
}

function makeDzEl() {
  const dz = document.createElement('div');
  dz.className = 'dropzone';
  dz.style.marginBottom = '14px';
  dz.ondragover = e => { e.preventDefault(); dz.classList.add('dv'); };
  dz.ondragleave = () => dz.classList.remove('dv');
  dz.ondrop = e => onDrop(e, 'main');
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'image/*';
  inp.onchange = e => onFile(e, 'main');
  dz.appendChild(inp);
  const ico = document.createElement('div'); ico.className = 'dz-ico'; ico.textContent = 'ğŸ–¼';
  const txt = document.createElement('div'); txt.className = 'dz-txt';
  txt.innerHTML = '<strong>Drop a photo here</strong><br><span style="font-family:\'Special Elite\',monospace;font-size:10px">or use the panel â†’</span>';
  dz.appendChild(ico); dz.appendChild(txt);
  return dz;
}

function mkTA(cls, ph, val, field, rows) {
  const ta = document.createElement('textarea');
  ta.className = cls; ta.placeholder = ph; ta.value = val || ''; ta.rows = rows;
  ta.oninput = function() { autoR(this); saveF(field, this.value); };
  return ta;
}

function makeQuoteBlock(p) {
  if (S.scrapMode) {
    const rng = mkRng(strHash(p.id + 'sc'));
    const tapeColors = ['rgba(196,168,140,.65)','rgba(155,178,140,.62)','rgba(182,140,168,.58)','rgba(100,128,180,.52)','rgba(200,140,100,.62)'];
    const tc = tapeColors[Math.floor(rng() * tapeColors.length)];
    const scR = [-1.3, -.6, 0, .6, 1.3][Math.floor(rng() * 5)];
    const tR  = [-2, -1, 0, 1, 2][Math.floor(rng() * 5)];

    const wrap = document.createElement('div'); wrap.className = 'scrap-wrap';
    wrap.style.transform = 'rotate(' + scR + 'deg)';
    const tape = document.createElement('div'); tape.className = 'scrap-tape-el';
    tape.style.cssText = 'left:calc(50% - 26px);width:52px;background-color:' + tc + ';transform:rotate(' + tR + 'deg)';
    const paper = document.createElement('div'); paper.className = 'scrap-paper';

    const qEl = document.createElement('div');
    qEl.contentEditable = 'true';
    qEl.style.cssText = 'font-family:Caveat,cursive;font-size:19px;font-weight:600;color:var(--ink);min-height:28px;outline:none';
    qEl.textContent = p.quote || '';
    qEl.onblur = () => saveF('quote', qEl.textContent);

    const footer = document.createElement('div'); footer.className = 'quote-footer';
    footer.appendChild(mkInp('f-qdate', 'dateâ€¦', p.date, 'date'));
    footer.appendChild(mkInp('f-qloc', 'somewhereâ€¦', p.location, 'location'));

    paper.appendChild(qEl); paper.appendChild(footer);
    wrap.appendChild(tape); wrap.appendChild(paper);
    return wrap;
  } else {
    const wrap = document.createElement('div'); wrap.className = 'quote-inline';
    wrap.appendChild(mkTA('f-quote', 'a quote or memoryâ€¦', p.quote, 'quote', 2));
    const footer = document.createElement('div'); footer.className = 'quote-footer';
    footer.appendChild(mkInp('f-qdate', 'Sept. 2024', p.date, 'date'));
    footer.appendChild(mkInp('f-qloc', 'somewhere warmâ€¦', p.location, 'location'));
    wrap.appendChild(footer);
    return wrap;
  }
}

function mkInp(cls, ph, val, field) {
  const inp = document.createElement('input');
  inp.type = 'text'; inp.className = cls; inp.placeholder = ph; inp.value = val || '';
  inp.oninput = () => saveF(field, inp.value);
  return inp;
}

function makeDecorEl(d) {
  const div = document.createElement('div');
  const rng = mkRng(strHash(d.id));
  const tapeColors = { 'tape-floral': 'rgba(182,140,168,.62)', 'tape-stripe': 'rgba(155,178,140,.62)', 'tape-kraft': 'rgba(196,168,140,.65)' };
  if (tapeColors[d.type]) {
    div.className = 'inline-tape';
    div.style.cssText = 'background-color:' + tapeColors[d.type] + ';transform:rotate(' + ((rng() - .5) * 2) + 'deg)';
  } else if (d.type === 'postmark') {
    div.style.cssText = 'text-align:center;margin:8px 0';
    div.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:50px;height:50px;border-radius:50%;border:2px solid rgba(100,28,28,.5);outline:1px solid rgba(100,28,28,.35);outline-offset:-6px;font-family:\'Special Elite\',monospace;font-size:6px;color:rgba(100,28,28,.65);text-align:center;line-height:1.3">PAPERLY<br>' + ['ğŸŒ¿','âš“','âœˆ','ğŸ“œ','ğŸ”­'][Math.floor(rng() * 5)] + '<br>' + new Date().getFullYear() + '</span>';
  } else if (d.type === 'botanical') {
    div.style.cssText = 'text-align:' + ['left','center','right'][Math.floor(rng() * 3)] + ';margin:6px 0';
    const s = document.createElement('span');
    s.style.cssText = 'font-size:28px;display:inline-block;transform:rotate(' + ((rng() - .5) * 8) + 'deg);filter:sepia(.3)';
    s.textContent = BOTANICALS[Math.floor(rng() * BOTANICALS.length)];
    div.appendChild(s);
  } else if (d.type === 'stamp') {
    div.style.margin = '8px 0';
    const s = document.createElement('span');
    s.style.cssText = 'font-family:\'Special Elite\',monospace;font-size:10px;color:rgba(139,26,26,.62);border:2px solid rgba(139,26,26,.48);padding:2px 8px;display:inline-block;transform:rotate(' + ((rng() - .5) * 8) + 'deg);letter-spacing:.12em';
    s.textContent = STAMPS[Math.floor(rng() * STAMPS.length)];
    div.appendChild(s);
  } else if (d.type === 'divider') {
    div.className = 'inline-div'; div.textContent = 'â€” âœ¦ â€”';
  } else if (d.type === 'text') {
    div.className = 'inline-txt'; div.contentEditable = 'true';
    div.textContent = d.content || 'write something hereâ€¦';
    div.onblur = () => { d.content = div.textContent; save(); };
  }
  return div;
}

function renderLayers() {
  const p = getP(); const list = document.getElementById('layer-list');
  if (!p || !(p.layers || []).length) { list.innerHTML = '<div style="font-family:Caveat,cursive;font-size:12px;color:var(--muted)">No layers yet</div>'; return; }
  list.innerHTML = '';
  (p.layers || []).forEach((l, i) => {
    const item = document.createElement('div'); item.className = 'layer-item';
    const th = document.createElement('img'); th.className = 'lthumb'; th.src = l.raw || '';
    const info = document.createElement('div'); info.className = 'linfo';
    const nm = document.createElement('div'); nm.className = 'lname'; nm.textContent = 'Layer ' + (i + 2);
    const hn = document.createElement('div'); hn.style.cssText = 'font-family:\'Crimson Pro\',serif;font-style:italic;font-size:10px;color:var(--muted)'; hn.textContent = 'collage image';
    const del = document.createElement('button'); del.className = 'ldel'; del.textContent = 'âœ•';
    del.onclick = () => rmLayer(l.id);
    info.appendChild(nm); info.appendChild(hn);
    item.appendChild(th); item.appendChild(info); item.appendChild(del);
    list.appendChild(item);
  });
}
function rmLayer(lid) { const p = getP(); if (!p) return; p.layers = (p.layers || []).filter(l => l.id !== lid); save(); renderPage(); toast('Layer removed'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE UPLOAD â€” zero async pipeline, instant display
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onDrop(e, type) {
  e.preventDefault();
  document.querySelectorAll('.dropzone').forEach(z => z.classList.remove('dv'));
  const f = e.dataTransfer && e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) type === 'layer' ? addLayer(f) : addMainPhoto(f);
}

function onFile(e, type) {
  const f = e.target && e.target.files[0];
  if (f) type === 'layer' ? addLayer(f) : addMainPhoto(f);
  e.target.value = ''; // reset so same file can be re-selected
}

function addMainPhoto(file) {
  const p = getP();
  if (!p) { toast('Open a journal first'); return; }

  const reader = new FileReader();
  reader.onload = function(e) {
    const raw = e.target.result;
    p.rawImage = raw;
    p.preset = S.preset;
    save();
    renderSidebar();
    renderPage(); // â† image appears HERE, instantly, no async wait
    toast('Photo added âœ“');
    runAI(); // fire and forget â€” AI runs in background
  };
  reader.onerror = function() { toast('Could not read file â€” try another image'); };
  reader.readAsDataURL(file);
}

function addLayer(file) {
  const p = getP();
  if (!p) return;
  if (!p.layers) p.layers = [];
  if (p.layers.length >= 4) { toast('Max 4 layers per page'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    p.layers.push({ id: gid(), raw: e.target.result });
    save(); renderPage(); toast('Layer added âœ“');
  };
  reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESET â€” instant, just update CSS filter on img
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPreset(preset, btn) {
  S.preset = preset;
  const p = getP();
  if (p) { p.preset = preset; save(); }
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === preset));
  // Update all photo filters live â€” no re-render, just CSS
  document.querySelectorAll('.photo-clip img').forEach(img => {
    img.style.filter = PRESET_CSS[preset] || PRESET_CSS.vintage;
  });
  toast('Style: ' + PRESET_NAMES[preset]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DECORATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addDecor(type) {
  const p = getP(); if (!p) return;
  if (!p.decorations) p.decorations = [];
  p.decorations.push({ id: gid(), type, pos: p.rawImage ? 'after' : 'before', content: '' });
  save(); renderPage(); toast('Ephemera added');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI PIPELINE â€” fully agentic, runs in background
// Image shows BEFORE AI runs. AI enriches the page.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetAiPanel() {
  const panel = document.getElementById('ai-panel');
  if (!panel) return;
  const p = getP();
  if (p && p.rawImage && !p.title) {
    panel.innerHTML = '<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Generating page contentâ€¦</div>';
  } else if (p && p.title) {
    panel.innerHTML = '<div style="font-family:\'Caveat\',cursive;font-size:12px;color:var(--muted);margin-bottom:7px">Content applied âœ“</div>'
      + '<button class="regen-btn" onclick="runAI()">â†º REGENERATE</button>';
  } else {
    panel.innerHTML = '<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">Upload a photo â€” Claude automatically writes your page</div>';
  }
}

// Resize image to max 512px longest side before sending to Claude.
// Dramatically reduces payload (e.g. 4MB â†’ 80KB) = 3-5x faster response.
// Claude needs enough pixels to understand the scene, not full resolution.
function downsizeForAI(dataUrl) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const MAX = 512;
      const scale = Math.min(1, MAX / Math.max(img.naturalWidth, img.naturalHeight));
      const w = Math.round(img.naturalWidth * scale);
      const h = Math.round(img.naturalHeight * scale);
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL('image/jpeg', 0.82));
    };
    img.onerror = () => resolve(dataUrl); // fallback to original on error
    img.src = dataUrl;
  });
}

async function runAI() {
  const p = getP();
  if (!p || !p.rawImage) return;

  document.getElementById('ai-panel').innerHTML =
    '<div class="ai-loader"><span class="quill">âœ’ï¸</span><span>Claude is reading<br>your photoâ€¦</span></div>';

  try {
    // Downsize first â€” smaller payload = faster response
    const small = await downsizeForAI(p.rawImage);
    const b64 = small.split(',')[1];
    const mt  = 'image/jpeg';

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 1000,
        system: 'You are Paperly, a junk journal co-pilot. You write in the voice of: ' + PRESET_VOICE[S.preset] + '\n\nSTEP 1 â€” Before writing anything, silently note to yourself: what do I literally see? (objects, light, colours, mood, time of day, setting). Do not include this step in your output.\n\nSTEP 2 â€” Using only what you observed, generate 3 suggestions that feel genuinely different from each other. Each must be rooted in specific visual details from the photo â€” never generic.\n\nRules:\n- Titles: 4-7 words, poetic, specific to this image\n- Quotes: under 18 words, feel handwritten and personal\n- Dates: evocative not literal ("a friday in late november")\n- Locations: intimate and tied to what you see\n\nRespond ONLY with this JSON, no markdown, no explanation:\n{"suggestions":[{"title":"","desc":"2-3 sentence caption","quote":"Memory under 18 words","date":"Evocative date phrase","location":"Specific location"},{"title":"","desc":"","quote":"","date":"","location":""},{"title":"","desc":"","quote":"","date":"","location":""}]}',
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: mt, data: b64 } },
            { type: 'text', text: 'Generate 3 junk journal page suggestions for the ' + PRESET_NAMES[S.preset] + ' style.' },
          ],
        }],
      }),
    });

    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();
    if (d.error) throw new Error(d.error.message || 'API error');

    const raw = d.content.map(b => b.text || '').join('');
    const i0 = raw.indexOf('{'), i1 = raw.lastIndexOf('}');
    if (i0 < 0 || i1 < 0) throw new Error('No JSON in response');
    const parsed = JSON.parse(raw.slice(i0, i1 + 1));
    const sugs = parsed.suggestions;
    if (!sugs || !sugs.length) throw new Error('Empty suggestions');

    applyS(sugs[0]);
    renderSugCards(sugs);

  } catch(err) {
    document.getElementById('ai-panel').innerHTML =
      '<div style="font-family:\'Special Elite\',monospace;font-size:10px;color:var(--red);line-height:1.7;padding:6px 0">'
      + esc(err.message.slice(0, 120)) + '</div>'
      + '<button class="regen-btn" onclick="runAI()">â†º RETRY</button>';
  }
}

function applyS(s) {
  const p = getP(); if (!p || !s) return;
  p.title = s.title || ''; p.desc = s.desc || '';
  p.quote = s.quote || ''; p.date = s.date || ''; p.location = s.location || '';
  save(); renderPage();
}

function renderSugCards(sugs) {
  const panel = document.getElementById('ai-panel');
  panel.innerHTML = '';
  sugs.forEach((s, i) => {
    const card = document.createElement('div');
    card.className = 'sug-card' + (i === 0 ? ' sel' : '');
    const t = document.createElement('div'); t.className = 'sug-title'; t.textContent = s.title || '';
    const d = document.createElement('div'); d.className = 'sug-desc';  d.textContent = s.desc  || '';
    const q = document.createElement('div'); q.className = 'sug-q';    q.textContent = '"' + (s.quote || '') + '"';
    const m = document.createElement('div'); m.className = 'sug-meta'; m.textContent = (s.date || '') + (s.location ? ' Â· ' + s.location : '');
    card.appendChild(t); card.appendChild(d); card.appendChild(q); card.appendChild(m);
    card.onclick = () => {
      document.querySelectorAll('.sug-card').forEach((c, ci) => c.classList.toggle('sel', ci === i));
      applyS(s); toast('Suggestion applied âœ“');
    };
    panel.appendChild(card);
  });
  const rb = document.createElement('button'); rb.className = 'regen-btn'; rb.textContent = 'â†º REGENERATE'; rb.onclick = runAI;
  panel.appendChild(rb);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRAP MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleScrap(on) { S.scrapMode = on; const p = getP(); if (p && (p.quote || p.date || p.location)) renderPage(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoR(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
function saveF(f, v) { const p = getP(); if (p) { p[f] = v; save(); } }
function esc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.overlay.open').forEach(m => m.classList.remove('open')); });
document.querySelectorAll('.overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARE PAGE
// Renders the current journal page to a canvas PNG,
// shows a preview, and generates a shareable data URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openShare() {
  const p = getP();
  if (!p) { toast('Nothing to share yet'); return; }

  // Render the journal page to canvas for download
  renderPageToCanvas(p).then(dataUrl => {
    document.getElementById('share-img').src = dataUrl;
    document.getElementById('share-img').style.display = 'block';

    // Build a shareable URL encoding the page data (title, desc, quote)
    const shareData = {
      t: p.title, d: p.desc, q: p.quote,
      dt: p.date, l: p.location,
      pr: p.preset || 'vintage'
    };
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(shareData))));
    const url = location.href.split('?')[0] + '?page=' + encoded;
    document.getElementById('share-url').value = url;
  });

  document.getElementById('share-overlay').classList.add('open');
}

function closeShare() {
  document.getElementById('share-overlay').classList.remove('open');
}

function copyShareUrl() {
  const url = document.getElementById('share-url').value;
  navigator.clipboard.writeText(url).then(() => toast('Link copied âœ“')).catch(() => {
    document.getElementById('share-url').select();
    document.execCommand('copy');
    toast('Link copied âœ“');
  });
}

function downloadPage() {
  const img = document.getElementById('share-img');
  if (!img.src || img.src === location.href) { toast('Preview not ready'); return; }
  const a = document.createElement('a');
  a.href = img.src;
  a.download = 'paperly-page.png';
  a.click();
  toast('Saved âœ“');
}

// Renders the current journal page content to a canvas PNG for sharing/download
function renderPageToCanvas(p) {
  return new Promise(resolve => {
    const W = 560, H = 780;
    const canvas = document.createElement('canvas');
    canvas.width = W * 2; canvas.height = H * 2; // 2x for retina
    const ctx = canvas.getContext('2d');
    ctx.scale(2, 2);

    // Paper background
    ctx.fillStyle = '#f6ecd6';
    ctx.fillRect(0, 0, W, H);

    // Ruled lines
    ctx.strokeStyle = 'rgba(150,110,70,.18)';
    ctx.lineWidth = 1;
    for (let y = 28; y < H; y += 28) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
    }
    // Red margin
    ctx.strokeStyle = 'rgba(150,45,45,.2)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(50, 0); ctx.lineTo(50, H); ctx.stroke();

    const draw = () => {
      const pad = { top: 30, left: 58, right: 30 };
      let y = pad.top;
      const maxW = W - pad.left - pad.right;

      const drawText = (text, font, color, size, maxWidth, lineH) => {
        ctx.font = font;
        ctx.fillStyle = color;
        const words = String(text || '').split(' ');
        let line = '';
        for (const word of words) {
          const test = line + (line ? ' ' : '') + word;
          if (ctx.measureText(test).width > maxWidth && line) {
            ctx.fillText(line, pad.left, y);
            y += lineH; line = word;
          } else { line = test; }
        }
        if (line) { ctx.fillText(line, pad.left, y); y += lineH; }
        y += 4;
      };

      // Image
      if (p.rawImage) {
        const img = new Image();
        img.onload = () => {
          const rng = mkRng(strHash(p.id + 'tilt'));
          const tilts = [-2.5,-1.6,-.8,0,.8,1.6,2.5];
          const tilt = tilts[Math.floor(rng()*tilts.length)] * Math.PI / 180;
          const iW = Math.min(maxW, 380);
          const iH = Math.round(iW * img.naturalHeight / img.naturalWidth);
          ctx.save();
          ctx.translate(pad.left + iW/2, y + iH/2);
          ctx.rotate(tilt);
          // Shadow
          ctx.shadowColor = 'rgba(42,31,14,.3)'; ctx.shadowBlur = 12;
          ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 5;
          ctx.drawImage(img, -iW/2, -iH/2, iW, iH);
          ctx.shadowColor = 'transparent';
          ctx.restore();
          y += iH + 24;
          drawTextContent();
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = () => { drawTextContent(); resolve(canvas.toDataURL('image/png')); };
        img.src = p.rawImage;
      } else {
        drawTextContent();
        resolve(canvas.toDataURL('image/png'));
      }

      function drawTextContent() {
        if (!p.title && !p.desc && !p.quote) return;
        // Divider
        ctx.strokeStyle = 'rgba(180,150,100,.35)'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(pad.left, y+8); ctx.lineTo(W-pad.right, y+8); ctx.stroke();
        y += 22;
        if (p.title) drawText(p.title, 'bold 24px Caveat,cursive', '#2a1f0e', 24, maxW, 30);
        if (p.desc)  drawText(p.desc,  '12px "Special Elite",monospace', '#6b5040', 12, maxW, 20);
        if (p.quote) {
          y += 8;
          ctx.strokeStyle = 'rgba(85,92,60,.5)'; ctx.lineWidth = 3;
          ctx.beginPath(); ctx.moveTo(pad.left-10,y); ctx.lineTo(pad.left-10,y+50); ctx.stroke();
          drawText('"' + p.quote + '"', 'italic 18px Caveat,cursive', '#2a1f0e', 18, maxW, 26);
        }
        if (p.date || p.location) {
          ctx.font = '10px "Special Elite",monospace';
          ctx.fillStyle = '#a08060';
          ctx.fillText([p.date, p.location].filter(Boolean).join(' Â· '), pad.left, y + 8);
        }
      }
    };
    draw();
  });
}

// Close share overlay on backdrop click
document.getElementById('share-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('share-overlay')) closeShare();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeShare(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO JOURNAL â€” shown on empty library to onboard users
// A pre-filled journal so users see the product before
// committing to creating their own
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEMO_JOURNAL = {
  id: '__demo__',
  name: 'Tokyo Nights â€” A Demo',
  color: '#2a3a4a',
  createdAt: Date.now(),
  isDemo: true,
  pages: [{
    id: '__demo_p1__',
    rawImage: null, // no image â€” uses illustrated placeholder
    preset: 'moody',
    title: 'The city that never quite sleeps',
    desc: 'Somewhere between the neon and the rain, the streets felt like a film I had already seen â€” but couldn\'t remember the ending of.',
    quote: 'pressed against the glass, the world moved and I stayed still.',
    date: 'a thursday in late november',
    location: 'shinjuku, 2am',
    decorations: [],
    layers: [],
  }]
};

function showDemo() {
  // Load the demo journal into the editor without saving it
  S.jid = '__demo__';
  S.pidx = 0;
  document.getElementById('view-lib').classList.remove('active');
  document.getElementById('view-ed').classList.add('active');

  const j = DEMO_JOURNAL;
  document.getElementById('ed-jname').textContent = j.name + ' (demo)';
  S.preset = 'moody';
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.p === 'moody'));
  document.getElementById('scrap-tog').checked = false;

  // Render sidebar
  const list = document.getElementById('pglist');
  list.innerHTML = '';
  const t = document.createElement('div');
  t.className = 'pgthumb active';
  t.style.cssText = 'font-family:Caveat,cursive;font-size:9px;color:var(--muted)';
  t.textContent = 'demo'; t.innerHTML += '<span class="pgnum">1</span>';
  list.appendChild(t);

  // Render the demo page content
  const content = document.getElementById('pcontent');
  content.innerHTML = '';

  // Demo placeholder â€” illustrated city scene using CSS + text
  const hero = document.createElement('div');
  hero.style.cssText = 'margin-bottom:18px;position:relative;font-family:"Special Elite",monospace';
  hero.innerHTML = `
    <div style="background:linear-gradient(180deg,#0a0e1a 0%,#1a2035 40%,#2a1510 100%);
      height:220px;position:relative;overflow:hidden;
      filter:drop-shadow(4px 6px 10px rgba(42,31,14,.4))">
      <div style="position:absolute;inset:0;display:flex;align-items:flex-end;padding:0 20px 16px;gap:6px">
        ${[40,70,55,85,45,60,75,50,65,80].map(h =>
          `<div style="flex:1;background:rgba(${Math.random()>.5?'255,180,60':'180,200,255'},.${Math.floor(Math.random()*3+1)});
            height:${h}%;position:relative">
            <div style="position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 8px,rgba(0,0,0,.3) 8px,rgba(0,0,0,.3) 9px)"></div>
          </div>`
        ).join('')}
      </div>
      <div style="position:absolute;top:0;left:0;right:0;height:60px;
        background:linear-gradient(180deg,rgba(10,14,26,.8),transparent)"></div>
      <div style="position:absolute;bottom:0;left:0;right:0;height:30px;
        background:linear-gradient(0deg,rgba(42,21,16,.6),transparent)"></div>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        font-size:11px;color:rgba(255,220,160,.6);letter-spacing:.2em;text-align:center;
        font-family:\'Special Elite\',monospace">YOUR PHOTO<br>APPEARS HERE</div>
      <!-- Washi tape -->
      <div style="position:absolute;top:-9px;left:28%;width:60px;height:20px;
        background:rgba(100,128,180,.5);transform:rotate(-1.5deg);
        background-image:repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(255,255,255,.2) 4px,rgba(255,255,255,.2) 5px)"></div>
    </div>`;
  content.appendChild(hero);

  const sep = document.createElement('div'); sep.className='divider-orn'; sep.textContent='âœ¦ âœ¦ âœ¦';
  content.appendChild(sep);

  const p = DEMO_JOURNAL.pages[0];
  const titleEl = document.createElement('div');
  titleEl.style.cssText = 'font-family:Caveat,cursive;font-size:28px;font-weight:700;color:var(--ink);line-height:1.2;margin-bottom:6px';
  titleEl.textContent = p.title;
  content.appendChild(titleEl);

  const descEl = document.createElement('div');
  descEl.style.cssText = 'font-family:"Special Elite",monospace;font-size:12px;color:var(--ink2);line-height:1.9;letter-spacing:.02em;margin-bottom:10px';
  descEl.textContent = p.desc;
  content.appendChild(descEl);

  const qi = document.createElement('div'); qi.className='quote-inline';
  const qtext = document.createElement('div');
  qtext.style.cssText='font-family:Caveat,cursive;font-size:19px;color:var(--ink);margin-bottom:5px';
  qtext.textContent='"' + p.quote + '"';
  const qmeta = document.createElement('div');
  qmeta.style.cssText='font-family:"Special Elite",monospace;font-size:9px;color:var(--muted);letter-spacing:.08em';
  qmeta.textContent = p.date + ' Â· ' + p.location;
  qi.appendChild(qtext); qi.appendChild(qmeta);
  content.appendChild(qi);

  // CTA banner
  const cta = document.createElement('div');
  cta.style.cssText = 'margin-top:28px;padding:16px;background:rgba(122,64,32,.08);border:1.5px solid rgba(122,64,32,.2);text-align:center';
  cta.innerHTML = '<div style="font-family:\'Special Elite\',monospace;font-size:11px;color:var(--ac);letter-spacing:.1em;margin-bottom:6px">âœ¦ THIS IS A DEMO PAGE âœ¦</div>'
    + '<div style="font-family:\'Crimson Pro\',serif;font-style:italic;font-size:13px;color:var(--ink2);margin-bottom:12px">Upload your own photo and Claude writes your journal page automatically</div>'
    + '<button class="btn btn-p" style="margin:0 auto" onclick="showLib();setTimeout(showNewModal,100)">+ START MY JOURNAL</button>';
  content.appendChild(cta);

  // Show prompt in AI panel
  document.getElementById('ai-panel').innerHTML =
    '<div style="font-family:\'Caveat\',cursive;font-size:13px;color:var(--muted);text-align:center;padding:10px 0">'
    + 'This is a demo. Create your own journal and upload a photo to get AI suggestions.</div>'
    + '<button class="btn btn-p" style="width:100%;margin-top:8px;font-size:10px" onclick="showLib();setTimeout(showNewModal,100)">+ START MY JOURNAL</button>';
}

// Override getP/getJ for demo mode
const _origGetJ = getJ, _origGetP = getP;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE PAGES DRAWER â€” purely UI, no logic changes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePgDrawer() {
  const sb = document.getElementById('pg-sb');
  sb.classList.toggle('open');
  document.body.classList.toggle('pgopen', sb.classList.contains('open'));
}
function closePgDrawer() {
  document.getElementById('pg-sb').classList.remove('open');
  document.body.classList.remove('pgopen');
}
// Close drawer when a page is selected on mobile
const _origSelectPage = selectPage;
selectPage = function(i) { _origSelectPage(i); closePgDrawer(); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tt;
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(_tt); _tt = setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Don't load local journals here â€” onAuthStateChange handles everything.
// Render the library immediately so logged-out users see the landing page.
renderLib();
</script>
</body>
</html>